<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="zsk">
    <meta name="baidu-site-verification" content="codeva-FDuSf8Qgto" />
    
    <title>
        
            Unidbg操作说明 |
        
        zskのblog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/logo.svg">
    
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.8.1/source/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.8.1/source/font/css/regular.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.8.1/source/font/css/solid.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.8.1/source/font/css/brands.min.css">
    
        
            
        
    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"www.zskkk.cn","root":"/","language":"zh-CN","path":"search.json"}
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true,"layout":"right"},"style":{"primary_color":"#0066cc","logo":"/images/logo.svg","favicon":"/images/logo.svg","avatar":"/images/head.svg","first_screen":{"enable":true,"header_transparent":true,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving.","hitokoto":true},"scroll":{"progress_bar":true,"percent":true}},"local_search":{"enable":true,"preload":true},"code_block":{"tools":{"enable":true,"style":"mac"},"highlight_theme":"obsidian"},"pjax":{"enable":true},"lazyload":{"enable":true},"comment":{"enable":true,"use":"valine","valine":{"appid":"WxNQs5QEQtykF82Sb7nAjXRO-gzGzoHsz","appkey":"4rZ6NwH5zAu6VEspHwVrgqOq","server_urls":null,"placeholder":"😜 尽情吐槽吧~"},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.21"},"waline":{"server_url":null,"reaction":false,"version":2},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false}},"post":{"author_label":{"enable":true,"auto":true,"custom_label_list":["Trainee","Engineer","Architect"]},"word_count":{"wordcount":true,"min2read":true},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":true,"share":true,"reward":{"enable":false,"img_link":null,"text":null}},"website_count":{"busuanzi_count":{"enable":true,"site_uv":true,"site_pv":true,"page_pv":true}},"version":"3.8.1"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <i class="pjax-progress-icon fas fa-circle-notch fa-spin"></i>
    
</div>


<main class="page-container border-box">

    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/logo.svg">
                </a>
            
            <a class="site-name border-box" href="/">
               zskのblog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                关于
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">关于</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">

                

                    <div class="fade-in-down-animation">
    <div class="post-page-container border-box">

        <div class="article-content-container border-box">

            

            <div class="article-content-bottom border-box">
                
                    <div class="article-title">
                        Unidbg操作说明
                    </div>
                

                
                    <div class="article-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/head.svg">
                            </div>
                        
                        <div class="info-box">
                            <div class="author">
                                <span class="name">zsk</span>
                                
                                    <span class="author-label">Lv4</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="article-meta-info-container border-box post">
    <div class="article-meta-info border-box">
        


        
            <span class="meta-info-item article-create-date">
                <i class="icon fa-solid fa-calendar-check"></i>&nbsp;
                <span class="pc">2022-10-19 00:00:00</span>
                <span class="mobile">2022-10-19 00:00</span>
            </span>

            <span class="meta-info-item article-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="pc" data-updated="Wed Oct 19 2022 00:00:00 GMT+0800">2022-10-19 00:00:00</span>
            </span>
        

        

        
            <span class="article-tag meta-info-item border-box">
                <i class="icon fas fa-tags"></i>&nbsp;
                <ul>
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/Unidbg/">Unidbg</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item article-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>17.5k 字</span>
            </span>
        
        
            <span class="meta-info-item article-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>79 分钟</span>
            </span>
        
        
            <span class="meta-info-item article-pv">
                <i class="icon fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
            </span>
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="article-content keep-markdown-body">
                    

                    <h2 id="补环境的三条准则"><a href="#补环境的三条准则" class="headerlink" title="补环境的三条准则"></a>补环境的三条准则</h2><ol>
<li>常规object，比如jstring，jarray使用Unidbg封装的API</li>
<li>除此之外的jobject使用vm.resolveClass(className).newObject(object)，jclass使用vm.resolveClass(className)</li>
<li>如果object不可得，传空&#x2F;方法签名&#x2F;标识</li>
</ol>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#AndroidEmulator">AndroidEmulator</a><ul>
<li><a href="#AndroidEmulator%E4%BB%8B%E7%BB%8D">AndroidEmulator介绍</a></li>
<li><a href="#%E5%88%9B%E5%BB%BAAndroidEmulator%E5%AE%9E%E4%BE%8B">创建AndroidEmulator实例</a></li>
<li><a href="#AndroidEmulator%E6%93%8D%E4%BD%9C%E6%8E%A5%E5%8F%A3">AndroidEmulator操作接口</a><ul>
<li><a href="#getMemory">getMemory</a></li>
<li><a href="#createDalvikVM">createDalvikVM</a></li>
<li><a href="#loadLibrary">loadLibrary</a></li>
<li><a href="#getDalvikVM">getDalvikVM</a></li>
<li><a href="#showRegs">showRegs</a></li>
<li><a href="#getBackend">getBackend</a></li>
<li><a href="#getPid">getPid</a></li>
<li><a href="#getProcessName">getProcessName</a></li>
<li><a href="#getContext">getContext</a></li>
<li><a href="#isRunning">isRunning</a></li>
<li><a href="#Trace">Trace</a></li>
<li><a href="#et-x2F-Get">Set&#x2F;Get</a></li>
<li><a href="#SyscallHandler">SyscallHandler</a></li>
<li><a href="#Debugger">Debugger</a></li>
<li><a href="#emulateSignal">emulateSignal</a></li>
<li><a href="#disassemble">disassemble</a></li>
<li><a href="#close">close</a></li>
<li><a href="#getUnwinder">getUnwinder</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Memory">Memory</a><ul>
<li><a href="#Memory%E4%BB%8B%E7%BB%8D">Memory介绍</a></li>
<li><a href="#Memory%E6%93%8D%E4%BD%9C">Memory操作</a><ul>
<li><a href="#%E8%8E%B7%E5%8F%96Memory%E5%AE%9E%E4%BE%8B">获取Memory实例</a></li>
<li><a href="#setLibraryResolver">setLibraryResolver</a></li>
<li><a href="#findModule">findModule</a></li>
<li><a href="#allocateStack">allocateStack</a></li>
<li><a href="#malloc">malloc</a></li>
<li><a href="#setErrno">setErrno</a></li>
<li><a href="#getStackPoint">getStackPoint</a></li>
<li><a href="#disableCallInitFunction">disableCallInitFunction</a></li>
<li><a href="#getMemoryMap">getMemoryMap</a></li>
<li><a href="#pointer">pointer</a></li>
<li><a href="#addModuleListener">addModuleListener</a></li>
<li><a href="#load">load</a></li>
</ul>
</li>
<li><a href="#Memory%E6%80%BB%E7%BB%93">Memory总结</a></li>
</ul>
</li>
<li><a href="#VM">VM</a><ul>
<li><a href="#VM%E4%BB%8B%E7%BB%8D">VM介绍</a></li>
<li><a href="#VM%E4%BB%8B%E7%BB%8D">VM介绍</a></li>
<li><a href="#VM%E6%8E%A5%E5%8F%A3">VM接口</a><ul>
<li><a href="#%E6%97%A5%E5%BF%97%E6%8E%A7%E5%88%B6">日志控制</a></li>
<li><a href="#%E8%AE%BE%E7%BD%AEJNI">设置JNI</a></li>
<li><a href="#%E8%B0%83%E7%94%A8JNI_OnLoad%E5%87%BD%E6%95%B0">调用JNI_OnLoad函数</a></li>
<li><a href="#%E8%8E%B7%E5%8F%96%E6%A8%A1%E6%8B%9F%E5%99%A8%E5%AE%9E%E4%BE%8B">获取模拟器实例</a></li>
<li><a href="#%E8%8E%B7%E5%8F%96APK%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF">获取APK相关信息</a></li>
<li><a href="#%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9D%97">加载模块</a></li>
</ul>
</li>
<li><a href="#VM%E6%80%BB%E7%BB%93">VM总结</a></li>
</ul>
</li>
<li><a href="#CallMethod">CallMethod</a><ul>
<li><a href="#%E6%89%A7%E8%A1%8CJNI%E5%87%BD%E6%95%B0">执行JNI函数</a></li>
<li><a href="#%E6%89%A7%E8%A1%8C%E4%BB%BB%E6%84%8F%E5%87%BD%E6%95%B0">执行任意函数</a></li>
<li><a href="#%E6%89%A7%E8%A1%8Cmain%E5%87%BD%E6%95%B0">执行main函数</a></li>
<li><a href="#JNI%E6%96%B9%E6%B3%95%E5%B0%81%E8%A3%85">JNI方法封装</a><ul>
<li><a href="#void">void</a></li>
<li><a href="#boolean">boolean</a></li>
<li><a href="#int">int</a></li>
<li><a href="#long">long</a></li>
<li><a href="#float">float</a></li>
<li><a href="#double">double</a></li>
<li><a href="#%E5%AF%B9%E8%B1%A1%E7%B1%BB%E5%9E%8B">对象类型</a></li>
</ul>
</li>
<li><a href="#JNI%E6%96%B9%E6%B3%95%E7%AD%BE%E5%90%8D">JNI方法签名</a></li>
</ul>
</li>
<li><a href="#Hook">Hook</a><ul>
<li><a href="#Hook%E4%BB%8B%E7%BB%8D">Hook介绍</a></li>
<li><a href="#Hook%E6%A1%86%E6%9E%B6%E5%88%86%E7%B1%BB">Hook框架分类</a><ul>
<li><a href="#HookZz">HookZz</a><ul>
<li><a href="#%E8%8E%B7%E5%8F%96HookZz%E5%AE%9E%E4%BE%8B">获取HookZz实例</a></li>
<li><a href="#HookZz-API">HookZz API</a><ul>
<li><a href="#wrap">wrap</a></li>
<li><a href="#replace">replace</a></li>
<li><a href="#instrument">instrument</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Dobby">Dobby</a><ul>
<li><a href="#%E8%8E%B7%E5%8F%96Dobby%E5%AE%9E%E4%BE%8B">获取Dobby实例</a></li>
<li><a href="#Dobby-API">Dobby API</a><ul>
<li><a href="#replace-1">replace</a></li>
<li><a href="#instrument">instrument</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#xHook">xHook</a><ul>
<li><a href="#%E8%8E%B7%E5%8F%96xHook%E5%AE%9E%E4%BE%8B">获取xHook实例</a></li>
<li><a href="#xHook-API">xHook API</a><ul>
<li><a href="#register">register</a></li>
<li><a href="#refresh">refresh</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Whale">Whale</a><ul>
<li><a href="#%E8%8E%B7%E5%8F%96Whale%E5%AE%9E%E4%BE%8B">获取Whale实例</a></li>
<li><a href="#Whale-API">Whale API</a></li>
</ul>
</li>
<li><a href="#patch">patch</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#JNI">JNI</a><ul>
<li><a href="#JNI%E4%BB%8B%E7%BB%8D">JNI介绍</a></li>
<li><a href="#%E7%B1%BB-x2F-%E7%B1%BB%E5%9E%8B">类&#x2F;类型</a></li>
<li><a href="#%E5%AF%B9%E8%B1%A1-x2F-%E5%AE%9E%E4%BE%8B">对象&#x2F;实例</a></li>
<li><a href="#%E5%8C%85%E8%A3%85%E5%AF%B9%E8%B1%A1">包装对象</a><ul>
<li><a href="#String">String</a></li>
<li><a href="#Array">Array</a></li>
<li><a href="#List">List</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Module">Module</a><ul>
<li><a href="#Module%E4%BB%8B%E7%BB%8D">Module介绍</a></li>
<li><a href="#Module%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B1%9E%E6%80%A7">Module常用的属性</a><ul>
<li><a href="#base">base</a></li>
<li><a href="#name">name</a></li>
<li><a href="#callEntry">callEntry</a></li>
<li><a href="#findSymbolByName">findSymbolByName</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#Backend">Backend</a><ul>
<li><a href="#Backend%E4%BB%8B%E7%BB%8D">Backend介绍</a></li>
<li><a href="#Backend%E5%88%97%E8%A1%A8">Backend列表</a><ul>
<li><a href="#Unicorn-x2F-Unicorn2">Unicorn&#x2F;Unicorn2</a><ul>
<li>使用Unicorn2后端:</li>
<li>Unicorn后端特点</li>
</ul>
</li>
<li><a href="#Dynarmic">Dynarmic</a><ul>
<li>使用Dynarmic后端</li>
<li>Dynarmic后端特点</li>
</ul>
</li>
<li><a href="#Hypervisor">Hypervisor</a><ul>
<li>使用Hypervisor后端</li>
<li>Hypervisor后端特点</li>
</ul>
</li>
<li><a href="#Kvm">Kvm</a><ul>
<li>使用Kvm后端</li>
<li>Kvm后端特点</li>
</ul>
</li>
</ul>
</li>
<li><a href="#Backend%E6%8E%A5%E5%8F%A3">Backend接口</a></li>
</ul>
</li>
<li><a href="#yxDebuggerRMm">Debugger</a><ul>
<li><a href="#Debugger%E4%BB%8B%E7%BB%8D">Debugger介绍</a></li>
<li><a href="#ConsoleDebugger">ConsoleDebugger</a><ul>
<li><a href="#%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4">使用步骤</a></li>
<li><a href="#%E8%B0%83%E8%AF%95%E6%8C%87%E4%BB%A4">调试指令</a></li>
</ul>
</li>
<li><a href="#GDB_SERVER">GDB_SERVER</a></li>
<li><a href="#ANDROID_SERVER_V7">ANDROID_SERVER_V7</a></li>
<li><a href="#Block">Block</a></li>
</ul>
</li>
<li><a href="#SyscallHandler">SyscallHandler</a><ul>
<li><a href="#SyscallHandler%E4%BB%8B%E7%BB%8D">SyscallHandler介绍</a></li>
<li><a href="#API">API</a><ul>
<li><a href="#%E8%8E%B7%E5%8F%96SyscallHandler%E5%AE%9E%E4%BE%8B">获取SyscallHandler实例</a></li>
<li><a href="#setVerbose">setVerbose</a></li>
<li><a href="#addIOResolver">addIOResolver</a></li>
<li><a href="#setEnableThreadDispatcher">setEnableThreadDispatcher</a></li>
<li><a href="#setFileListener">setFileListener</a></li>
<li><a href="#getFileIO">getFileIO</a></li>
</ul>
</li>
<li><a href="#%E8%87%AA%E5%A4%84%E7%90%86%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8">自处理系统调用</a></li>
<li><a href="#FileResult">FileResult</a><ul>
<li>success</li>
<li>failed</li>
<li>fallback</li>
</ul>
</li>
</ul>
</li>
<li><a href="#VirtualModule">VirtualModule</a><ul>
<li><a href="#VirtualModule%E4%BB%8B%E7%BB%8D">VirtualModule介绍</a></li>
<li><a href="#unidbg%E8%87%AA%E5%B8%A6%E8%99%9A%E6%8B%9F%E6%A8%A1%E5%9D%97">unidbg自带虚拟模块</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%99%9A%E6%8B%9F%E6%A8%A1%E5%9D%97">自定义虚拟模块</a><ul>
<li>模拟场景</li>
<li>首次尝试</li>
<li>处理问题</li>
<li>完整代码</li>
</ul>
</li>
</ul>
</li>
<li><a href="#Jnitrace">Jnitrace</a><ul>
<li><a href="#%E4%BD%BF%E7%94%A8">使用</a></li>
<li><a href="#jnitrace%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E8%BF%94%E5%9B%9E%E7%9A%84%E6%98%AF%E5%9C%B0%E5%9D%80%E7%9A%84%E6%97%B6%E5%80%99">jnitrace函数调用返回的是地址的时候</a></li>
<li><a href="#%E5%A0%86%E6%A0%88%E6%A3%80%E6%B5%8B">堆栈检测</a></li>
</ul>
</li>
<li><a href="#%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F">函数调用的两种方式</a><ul>
<li><a href="#%E7%AC%A6%E5%8F%B7%E8%B0%83%E7%94%A8">符号调用</a></li>
<li><a href="#%E5%9C%B0%E5%9D%80%E8%B0%83%E7%94%A8">地址调用</a></li>
</ul>
</li>
<li><a href="#%E6%9E%84%E5%BB%BA%E7%B1%BB%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F">构建类的两种方式</a></li>
<li><a href="#%E7%B1%BB%E7%BB%A7%E6%89%BF%E7%9A%84%E5%86%99%E6%B3%95">类继承的写法</a></li>
<li><a href="#unidbg%E8%A1%A5%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E5%B1%9E%E6%80%A7">unidbg补获取系统属性</a></li>
<li><a href="#%E6%96%87%E4%BB%B6%E9%87%8D%E5%AE%9A%E5%90%91%EF%BC%8C%E5%AE%9E%E7%8E%B0-IOResolver">文件重定向，实现-IOResolver</a></li>
<li><a href="#%E4%B8%80%E4%BA%9B%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD">一些常用功能</a></li>
<li><a href="#%E5%8F%8D%E5%88%B6unidbg">反制unidbg</a></li>
<li><a href="#Unidbg%E6%8A%A5%E9%94%99">Unidbg报错</a></li>
</ul>
<h2 id="基本框架"><a href="#基本框架" class="headerlink" title="基本框架"></a>基本框架</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AndroidEmulator emulator;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> VM vm;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Module <span class="keyword">module</span>;</span><br><span class="line"></span><br><span class="line">xxxx() &#123;</span><br><span class="line">    <span class="comment">// 创建模拟器实例,进程名建议依照实际进程名填写，可以规避针对进程名的校验</span></span><br><span class="line">    emulator = AndroidEmulatorBuilder.for32Bit().setProcessName(<span class="string">&quot;xxxxx&quot;</span>).build();</span><br><span class="line">    <span class="comment">// 获取模拟器的内存操作接口</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Memory</span> <span class="variable">memory</span> <span class="operator">=</span> emulator.getMemory();</span><br><span class="line">    <span class="comment">// 设置系统类库解析</span></span><br><span class="line">    memory.setLibraryResolver(<span class="keyword">new</span> <span class="title class_">AndroidResolver</span>(<span class="number">23</span>));</span><br><span class="line">    <span class="comment">// 创建Android虚拟机,传入APK，Unidbg可以替我们做部分签名校验的工作</span></span><br><span class="line">    vm = emulator.createDalvikVM(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;apk路径&quot;</span>));</span><br><span class="line">    <span class="comment">// 加载目标SO</span></span><br><span class="line">    <span class="type">DalvikModule</span> <span class="variable">dm</span> <span class="operator">=</span> vm.loadLibrary(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;so路径&quot;</span>), <span class="literal">true</span>); <span class="comment">// 加载so到虚拟内存</span></span><br><span class="line">    <span class="comment">//获取本SO模块的句柄,后续需要用它</span></span><br><span class="line">    <span class="keyword">module</span> = dm.getModule();</span><br><span class="line">    vm.setJni(<span class="built_in">this</span>); <span class="comment">// 设置JNI</span></span><br><span class="line">    vm.setVerbose(<span class="literal">true</span>); <span class="comment">// 打印日志</span></span><br><span class="line"></span><br><span class="line">    dm.callJNI_OnLoad(emulator); <span class="comment">// 调用JNI OnLoad</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="AndroidEmulator"><a href="#AndroidEmulator" class="headerlink" title="AndroidEmulator"></a>AndroidEmulator</h2><h3 id="AndroidEmulator介绍"><a href="#AndroidEmulator介绍" class="headerlink" title="AndroidEmulator介绍"></a>AndroidEmulator介绍</h3><p>AndroidEmulator是一个抽象的Android模拟器接口。它作为一个枢纽，协调unidbg中大多数模块相互工作，至关重要。我们需要的大多数操作也都需要借助于它。</p>
<h3 id="创建AndroidEmulator实例"><a href="#创建AndroidEmulator实例" class="headerlink" title="创建AndroidEmulator实例"></a>创建AndroidEmulator实例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AndroidEmulator</span> <span class="variable">build</span> <span class="operator">=</span> AndroidEmulatorBuilder</span><br><span class="line">    <span class="comment">// 指定32位CPU</span></span><br><span class="line">    .for32Bit()</span><br><span class="line">    <span class="comment">// 添加后端，推荐使用Dynarmic，运行速度快，但并不支持某些新特性</span></span><br><span class="line">    .addBackendFactory(<span class="keyword">new</span> <span class="title class_">DynarmicFactory</span>(<span class="literal">true</span>))</span><br><span class="line">    <span class="comment">// 指定进程名，推荐以安卓包名做为进程名</span></span><br><span class="line">    .setProcessName(<span class="string">&quot;com.github.unidbg&quot;</span>)</span><br><span class="line">    <span class="comment">// 设置根路径</span></span><br><span class="line">    .setRootDir(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;target/rootfs/default&quot;</span>))</span><br><span class="line">    <span class="comment">// 生成AndroidEmulator实例</span></span><br><span class="line">    .build();</span><br></pre></td></tr></table></figure>

<h3 id="AndroidEmulator操作接口"><a href="#AndroidEmulator操作接口" class="headerlink" title="AndroidEmulator操作接口"></a>AndroidEmulator操作接口</h3><h4 id="getMemory"><a href="#getMemory" class="headerlink" title="getMemory"></a>getMemory</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取内存操作接口</span></span><br><span class="line"><span class="type">Memory</span> <span class="variable">memory</span> <span class="operator">=</span> emulator.getMemory();</span><br></pre></td></tr></table></figure>
<p>获取内存操作接口，关于Memory接口介绍查看<a href="#Memory">Memory</a>。</p>
<h4 id="getPid"><a href="#getPid" class="headerlink" title="getPid"></a>getPid</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取进程pid</span></span><br><span class="line"><span class="type">int</span> <span class="variable">pid</span> <span class="operator">=</span> emulator.getPid();</span><br></pre></td></tr></table></figure>

<h4 id="createDalvikVM"><a href="#createDalvikVM" class="headerlink" title="createDalvikVM"></a>createDalvikVM</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建虚拟机</span></span><br><span class="line"><span class="type">VM</span> <span class="variable">vm</span> <span class="operator">=</span> emulator.createDalvikVM();</span><br><span class="line"><span class="comment">// 创建虚拟机并指定APK文件</span></span><br><span class="line"><span class="type">VM</span> <span class="variable">vm</span> <span class="operator">=</span> emulator.createDalvikVM(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;apk file path&quot;</span>));</span><br></pre></td></tr></table></figure>
<p>创建虚拟机，关于VM的接口查看<a href="#VM">VM介绍</a></p>
<h4 id="loadLibrary"><a href="#loadLibrary" class="headerlink" title="loadLibrary"></a>loadLibrary</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//参数一: So或可执行ELF文件</span></span><br><span class="line"><span class="comment">//参数二: 是否强制执行Init初始化系列函数</span></span><br><span class="line"><span class="type">Module</span> <span class="variable">module</span> <span class="operator">=</span> emulator.loadLibrary(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;Elf文件路径&quot;</span>), <span class="literal">true</span>);</span><br><span class="line"><span class="comment">//省略参数二，默认为false</span></span><br><span class="line"><span class="type">Module</span> <span class="variable">module</span> <span class="operator">=</span> emulator.loadLibrary(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;Elf文件路径&quot;</span>));</span><br></pre></td></tr></table></figure>

<h4 id="getDalvikVM"><a href="#getDalvikVM" class="headerlink" title="getDalvikVM"></a>getDalvikVM</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取已创建的虚拟机</span></span><br><span class="line"><span class="type">VM</span> <span class="variable">vm</span> <span class="operator">=</span> emulator.getDalvikVM();</span><br></pre></td></tr></table></figure>
<p>获取已创建的虚拟机。</p>
<h4 id="showRegs"><a href="#showRegs" class="headerlink" title="showRegs"></a>showRegs</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//打印所有寄存器信息</span></span><br><span class="line">emulator.showRegs();</span><br><span class="line"><span class="comment">//打印指定寄存器信息</span></span><br><span class="line">emulator.showRegs(ArmConst.UC_ARM_REG_R0, ArmConst.UC_ARM_REG_R1);</span><br></pre></td></tr></table></figure>
<p>打印当前寄存器信息。</p>
<h4 id="getBackend"><a href="#getBackend" class="headerlink" title="getBackend"></a>getBackend</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取后端CPU</span></span><br><span class="line">Backend backend = emulator.getBackend();</span><br></pre></td></tr></table></figure>
<p>获取后端，关于后端请查看<a href="#Backend">Backend</a>介绍</p>
<h4 id="getProcessName"><a href="#getProcessName" class="headerlink" title="getProcessName"></a>getProcessName</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取进程名</span></span><br><span class="line"><span class="type">String</span> <span class="variable">processName</span> <span class="operator">=</span> emulator.getProcessName();</span><br></pre></td></tr></table></figure>
<p>获取进程名。</p>
<h4 id="getContext"><a href="#getContext" class="headerlink" title="getContext"></a>getContext</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取寄存器</span></span><br><span class="line">RegisterContext context = emulator.getContext();</span><br></pre></td></tr></table></figure>
<p>获取寄存器上下文，关于寄存器上下文介绍请查看<a href="#RegisterContext">RegisterContext介绍</a>。</p>
<h4 id="isRunning"><a href="#isRunning" class="headerlink" title="isRunning"></a>isRunning</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 是否正在运行</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">running</span> <span class="operator">=</span> emulator.isRunning();</span><br></pre></td></tr></table></figure>
<p>是否正在运行。</p>
<h4 id="Trace"><a href="#Trace" class="headerlink" title="Trace"></a>Trace</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Trace汇编指令</span></span><br><span class="line">emulator.traceCode();</span><br><span class="line"><span class="comment">//指定起始结束范围Trace汇编指令。</span></span><br><span class="line">emulator.traceCode(<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">//带回调的Trace，每条指令都会回调onInstruction方法</span></span><br><span class="line">emulator.traceCode(<span class="number">1</span>, <span class="number">0</span>, <span class="keyword">new</span> <span class="title class_">TraceCodeListener</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onInstruction</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">long</span> address, Instruction insn)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">mnemonic</span> <span class="operator">=</span> insn.getMnemonic();</span><br><span class="line">        <span class="keyword">if</span> (mnemonic.equals(<span class="string">&quot;svc&quot;</span>) || mnemonic.equals(<span class="string">&quot;swi&quot;</span>))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;0x&quot;</span>+Long.toHexString(address)+<span class="string">&quot;执行了svc指令&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Trace读内存</span></span><br><span class="line">emulator.traceRead();</span><br><span class="line"><span class="comment">// emulator.traceRead(起始地址，结束地址);  // 哪里做了读取</span></span><br><span class="line"><span class="comment">//Trace写内存</span></span><br><span class="line">emulator.traceWrite(); </span><br><span class="line"><span class="comment">// emulator.traceWrite(起始地址，结束地址);  // 哪里做了赋值</span></span><br></pre></td></tr></table></figure>
<p><strong>注意：Trace功能仅支持Unicorn后端引擎</strong><br />如使用带范围的Trace，起始位置大于结束位置将全部进行Trace。与无参方法作用相同。每种Trace都包含了三种重载，参照traceCode()即可。<br /></p>
<h4 id="Set-x2F-Get"><a href="#Set-x2F-Get" class="headerlink" title="Set&#x2F;Get"></a>Set&#x2F;Get</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">emulator.set(<span class="string">&quot;Test&quot;</span>,<span class="built_in">this</span>);</span><br><span class="line"><span class="type">DocTest</span> <span class="variable">test</span> <span class="operator">=</span> emulator.&lt;DocTest&gt;get(<span class="string">&quot;Test&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>emulator内部维护了一个Map，如有全局的对象需要存储，可借助这两个API来操作，无需额外维护Map对象</p>
<h4 id="SyscallHandler"><a href="#SyscallHandler" class="headerlink" title="SyscallHandler"></a>SyscallHandler</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SyscallHandler&lt;AndroidFileIO&gt; syscallHandler = emulator.getSyscallHandler();</span><br></pre></td></tr></table></figure>
<p>获取系统调用处理器，其API请查看<a href="#SyscallHandler-1">SyscallHandler介绍</a>。</p>
<h4 id="Debugger"><a href="#Debugger" class="headerlink" title="Debugger"></a>Debugger</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//无参默认CONSOLE调试器</span></span><br><span class="line"><span class="type">Debugger</span> <span class="variable">attach</span> <span class="operator">=</span> emulator.attach();</span><br><span class="line"><span class="comment">//指定调试器</span></span><br><span class="line"><span class="type">Debugger</span> <span class="variable">attach</span> <span class="operator">=</span> emulator.attach(DebuggerType.CONSOLE);</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span>  <span class="title class_">DebuggerType</span> &#123;</span><br><span class="line">    <span class="comment">//console debugger</span></span><br><span class="line">    CONSOLE,</span><br><span class="line">    <span class="comment">//gdb server</span></span><br><span class="line">    GDB_SERVER,</span><br><span class="line">    <span class="comment">//ida android server v7.x</span></span><br><span class="line">    ANDROID_SERVER_V7</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>附加调试器。关于调试器请查看<a href="#Deggbuer">Debugger介绍</a>。</p>
<h4 id="emulateSignal"><a href="#emulateSignal" class="headerlink" title="emulateSignal"></a>emulateSignal</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//参数为SIG_NUM Linux执行 kill -l 查看信号列表</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> emulator.emulateSignal(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<p>模拟向进程发送一个信号。</p>
<h4 id="disassemble"><a href="#disassemble" class="headerlink" title="disassemble"></a>disassemble</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数一: 地址</span></span><br><span class="line"><span class="comment">// 参数二: 机器码</span></span><br><span class="line"><span class="comment">// 参数三: 是否为Thumb指令</span></span><br><span class="line"><span class="comment">// 参数四: 最多处理多少条指令</span></span><br><span class="line"><span class="type">byte</span>[] code = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">0x00</span>, <span class="number">0x20</span>&#125;;</span><br><span class="line">Instruction[] disassemble = emulator.disassemble(<span class="number">0</span>, code, <span class="literal">true</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>如需灵活转换，请使用Capstone，此处只是Capstone的简单封装。disassemble方法的另一重载不推荐大家使用，为Trace而封装的，了解即可。</p>
<h4 id="close"><a href="#close" class="headerlink" title="close"></a>close</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emulator.close();</span><br></pre></td></tr></table></figure>
<p>调用此方法来释放Android虚拟机使用的资源。</p>
<h4 id="getUnwinder"><a href="#getUnwinder" class="headerlink" title="getUnwinder"></a>getUnwinder</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emulator.getUnwinder().unwind();</span><br></pre></td></tr></table></figure>
<p>此方法用来打印调用栈</p>
<h2 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h2><h3 id="Memory介绍"><a href="#Memory介绍" class="headerlink" title="Memory介绍"></a>Memory介绍</h3><p>Memory内存接口主要提供了两个功能</p>
<ul>
<li>内存管理</li>
<li>ELF文件的加载</li>
</ul>
<p>下面我们来介绍下Memory操作的主要接口。</p>
<h3 id="Memory操作"><a href="#Memory操作" class="headerlink" title="Memory操作"></a>Memory操作</h3><h4 id="获取Memory实例"><a href="#获取Memory实例" class="headerlink" title="获取Memory实例"></a>获取Memory实例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//emulator为模拟器实例</span></span><br><span class="line"><span class="type">Memory</span> <span class="variable">memory</span> <span class="operator">=</span> emulator.getMemory();</span><br></pre></td></tr></table></figure>

<h4 id="setLibraryResolver"><a href="#setLibraryResolver" class="headerlink" title="setLibraryResolver"></a>setLibraryResolver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//指定Android SDK 版本，目前支持19和23两个版本</span></span><br><span class="line">memory.setLibraryResolver(<span class="keyword">new</span> <span class="title class_">AndroidResolver</span>(<span class="number">23</span>));</span><br></pre></td></tr></table></figure>
<p><font color="red">此接口属于必调用接口。</font>设置SDK版本，管理了Android提供的常用基本so库。如不调用此方法，在处理Elf文件的依赖时，需要自行处理依赖问题。只有So中无任何依赖的情况下可以不调用此方法。</p>
<h4 id="findModule"><a href="#findModule" class="headerlink" title="findModule"></a>findModule</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据名称获取已加载模块</span></span><br><span class="line"><span class="type">Module</span> <span class="variable">module</span> <span class="operator">=</span> memory.findModule(<span class="string">&quot;libc.so&quot;</span>);</span><br><span class="line"><span class="comment">//根据模块在内存中的地址查找已加载模块</span></span><br><span class="line"><span class="type">Module</span> <span class="variable">module</span> <span class="operator">=</span> memory.findModuleByAddress(address);</span><br><span class="line"><span class="comment">//获取所有已经加载过的模块</span></span><br><span class="line">Collection&lt;Module&gt; loadedModules = memory.getLoadedModules();</span><br></pre></td></tr></table></figure>
<p>上面两个方法都为获取已加载的模块，需在自行加载模块之后调用。</p>
<h4 id="allocateStack"><a href="#allocateStack" class="headerlink" title="allocateStack"></a>allocateStack</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//参数为申请栈空间的大小</span></span><br><span class="line"><span class="type">UnidbgPointer</span> <span class="variable">pointer</span> <span class="operator">=</span> memory.allocateStack(<span class="number">0x10</span>);</span><br><span class="line"><span class="comment">//在栈空间写入数据并返回指针</span></span><br><span class="line"><span class="type">UnidbgPointer</span> <span class="variable">pointer</span> <span class="operator">=</span> memory.writeStackBytes(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">0x01</span>, <span class="number">0x02</span>&#125;);</span><br><span class="line"><span class="comment">//在栈空间写入字符串并返回指针</span></span><br><span class="line"><span class="type">UnidbgPointer</span> <span class="variable">pointer</span> <span class="operator">=</span> memory.writeStackString(<span class="string">&quot;doc&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>不要在程序运行期间修改栈，如果你不清楚在做什么，最好不要自行开辟栈空间，unidbg会自行维护。</p>
<h4 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//参数一: 分配内存的大小</span></span><br><span class="line"><span class="comment">//参数二: runtime标志</span></span><br><span class="line"><span class="type">MemoryBlock</span> <span class="variable">malloc</span> <span class="operator">=</span> memory.malloc(<span class="number">0x10</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="comment">//获取已分配内存的指针来操作该内存</span></span><br><span class="line"><span class="type">UnidbgPointer</span> <span class="variable">pointer</span> <span class="operator">=</span> malloc.getPointer();</span><br><span class="line"><span class="comment">//释放已分配的内存</span></span><br><span class="line">malloc.free();</span><br></pre></td></tr></table></figure>
<p>参数二的runtime标志：true表示使用mmap按页大小分配，相应的调用MemoryBlock.free方法则使用munmap释放。false表示使用libc.malloc分配，相应的调用MemoryBlock.free方法则使用libc.free释放。</p>
<h4 id="setErrno"><a href="#setErrno" class="headerlink" title="setErrno"></a>setErrno</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">memory.setErrno(UnixEmulator.EPERM); </span><br></pre></td></tr></table></figure>
<p>如需在模拟执行某函数前需要指定errno，可使用此方法设置。</p>
<h4 id="getStackPoint"><a href="#getStackPoint" class="headerlink" title="getStackPoint"></a>getStackPoint</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">stackPoint</span> <span class="operator">=</span> memory.getStackPoint(); </span><br></pre></td></tr></table></figure>
<p>返回当前SP寄存器指向的地址。</p>
<h4 id="disableCallInitFunction"><a href="#disableCallInitFunction" class="headerlink" title="disableCallInitFunction"></a>disableCallInitFunction</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">memory.disableCallInitFunction();</span><br><span class="line"><span class="comment">//参数一: 指定是否调用初始化</span></span><br><span class="line">memory.setCallInitFunction(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
<p>禁用Elf加载时调用初始化函数。需配合加载模块的forceCallInit参数使用。如不进行上述设置，默认为true。</p>
<h4 id="getMemoryMap"><a href="#getMemoryMap" class="headerlink" title="getMemoryMap"></a>getMemoryMap</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Collection&lt;MemoryMap&gt; memoryMap = memory.getMemoryMap();</span><br><span class="line"><span class="comment">//打印当前内存映射情况</span></span><br><span class="line"><span class="keyword">for</span> (MemoryMap map : memoryMap)&#123;</span><br><span class="line">    System.out.println(map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取内存映射信息，所有正在使用的内存块都维护在此Map中。</p>
<h4 id="pointer"><a href="#pointer" class="headerlink" title="pointer"></a>pointer</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UnidbgPointer</span> <span class="variable">pointer</span> <span class="operator">=</span> memory.pointer(<span class="number">0x40000000</span>);</span><br><span class="line"><span class="type">UnidbgPointer</span> <span class="variable">pointer2</span> <span class="operator">=</span> UnidbgPointer.pointer(emulator, <span class="number">0x40000000</span>);</span><br></pre></td></tr></table></figure>
<p>在unidbg中，可以借助unidbgPointer封装的API来读写内存，此API供已知地址的情况下，获得一个指针指向已知地址，继而进行操作。可以理解为指哪打哪。具体内存读写操作请查看<a href="#UnidbgPointer">UnidbgPointer</a>。</p>
<h4 id="addModuleListener"><a href="#addModuleListener" class="headerlink" title="addModuleListener"></a>addModuleListener</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">memory.addModuleListener(<span class="keyword">new</span> <span class="title class_">ModuleListener</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLoaded</span><span class="params">(Emulator&lt;?&gt; emulator, Module <span class="keyword">module</span>)</span> &#123;</span><br><span class="line">        System.out.println(<span class="keyword">module</span>.name + <span class="string">&quot;已被加载&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>添加一个模块加载监听器，当一个新模块被加载后，会回调ModuleListener的onLoaded方法，用来感知某模块加载。一般用于想在某个模块加载后接着进行hook的操作。需在模块加载前设置，否则无效。</p>
<h4 id="load"><a href="#load" class="headerlink" title="load"></a>load</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Module</span> <span class="variable">module</span> <span class="operator">=</span> memory.load(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;文件地址&quot;</span>)); </span><br></pre></td></tr></table></figure>
<p>其余几个重载就不介绍了，emulator接口提供的模块加载API和VM提供的加载API底层都基于此，仅是对此API的一层封装。</p>
<h3 id="Memory总结"><a href="#Memory总结" class="headerlink" title="Memory总结"></a>Memory总结</h3><p>Memory模块封装了关于内存管理的各个接口，其余未介绍的方法不推荐大家使用，多为unidbg内部封装的功能。</p>
<h2 id="VM"><a href="#VM" class="headerlink" title="VM"></a>VM</h2><h3 id="VM介绍"><a href="#VM介绍" class="headerlink" title="VM介绍"></a>VM介绍</h3><p>如果要加载的模块中存在JNI交互的场景，需要创建VM。VM主要的作用就是代理了一套JNI，在模拟执行的过程中，如果需要借助JNI来操作Java层，就少不了VM的帮助。</p>
<h3 id="VM创建"><a href="#VM创建" class="headerlink" title="VM创建"></a>VM创建</h3><p>在<a href="#AndroidEmulator">AndroidEmulator</a>一节我们介绍过，主要有两种创建VM的方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建虚拟机</span></span><br><span class="line"><span class="type">VM</span> <span class="variable">dalvikVM</span> <span class="operator">=</span> emulator.createDalvikVM();</span><br><span class="line"><span class="comment">//创建虚拟机并指定APK文件</span></span><br><span class="line"><span class="type">VM</span> <span class="variable">dalvikVM</span> <span class="operator">=</span> emulator.createDalvikVM(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;apk file path&quot;</span>));</span><br></pre></td></tr></table></figure>
<p>推荐使用指定APK文件进行创建，某些API需要指定APK文件才可使用。</p>
<h3 id="VM接口"><a href="#VM接口" class="headerlink" title="VM接口"></a>VM接口</h3><h4 id="日志控制"><a href="#日志控制" class="headerlink" title="日志控制"></a>日志控制</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置是否输出JNI运行日志 </span></span><br><span class="line">vm.setVerbose(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<p>此开关只控制VM的日志，主要表现为JNI交互的详细日志。</p>
<h4 id="设置JNI"><a href="#设置JNI" class="headerlink" title="设置JNI"></a>设置JNI</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置JNI接口 </span></span><br><span class="line">dalvikVM.setJni(<span class="built_in">this</span>);</span><br></pre></td></tr></table></figure>
<p>如程序中存在使用JNI的接口，必须设置JNI。推荐自实现的类继承AbstractJni类，此类封装了绝大部份常用的方法，免去部分繁杂的内容。如签名校验(需指定APK文件创建VM)、常用JDK操作等。 关于JNI部分请查看<a href="#JNI">JNI介绍</a></p>
<h4 id="调用JNI-OnLoad函数"><a href="#调用JNI-OnLoad函数" class="headerlink" title="调用JNI_OnLoad函数"></a>调用JNI_OnLoad函数</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数一: 模拟器实例 </span></span><br><span class="line"><span class="comment">// 参数二: 要执行JNI_OnLoad函数的模块 </span></span><br><span class="line">dalvikVM.callJNI_OnLoad(emulator,<span class="keyword">module</span>);</span><br></pre></td></tr></table></figure>
<p>对JNI_OnLoad函数进行模拟执行。如某些JNI方法在JNI_OnLoad函数进行动态绑定需调用此函数后才能够调用JNI方法，推荐加载模块后紧接执行此方法。</p>
<h4 id="获取模拟器实例"><a href="#获取模拟器实例" class="headerlink" title="获取模拟器实例"></a>获取模拟器实例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Emulator&lt;?&gt; emulator = dalvikVM.getEmulator(); </span><br></pre></td></tr></table></figure>

<h4 id="获取APK相关信息"><a href="#获取APK相关信息" class="headerlink" title="获取APK相关信息"></a>获取APK相关信息</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//指定APK文件以后，可调用该方法获取资源文件</span></span><br><span class="line"><span class="type">byte</span>[] bytes = dalvikVM.openAsset(<span class="string">&quot;fileName&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定APK文件以后，可调用该方法获取APK包名</span></span><br><span class="line"><span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> dalvikVM.getPackageName();</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定APK文件以后，可调用该方法获取APK版本名称</span></span><br><span class="line"><span class="type">String</span> <span class="variable">versionName</span> <span class="operator">=</span> dalvikVM.getVersionName();</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定APK文件以后，可调用该方法获取APK版本号</span></span><br><span class="line"><span class="type">long</span> <span class="variable">versionCode</span> <span class="operator">=</span> dalvikVM.getVersionCode();</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定APK文件以后，可调用该方法获取Manifest清单信息</span></span><br><span class="line"><span class="type">String</span> <span class="variable">manifestXml</span> <span class="operator">=</span> dalvikVM.getManifestXml();</span><br></pre></td></tr></table></figure>

<h4 id="加载模块"><a href="#加载模块" class="headerlink" title="加载模块"></a>加载模块</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//参数一: 模块名称</span></span><br><span class="line"><span class="comment">//参数二: 是否强制执行Init初始化</span></span><br><span class="line"><span class="type">DalvikModule</span> <span class="variable">docModule</span> <span class="operator">=</span> dalvikVM.loadLibrary(<span class="string">&quot;doc&quot;</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//参数一: 模块名称</span></span><br><span class="line"><span class="comment">//参数二: 要加载模块的字节数据</span></span><br><span class="line"><span class="comment">//参数三: 是否强制执行Init初始化</span></span><br><span class="line"><span class="type">DalvikModule</span> <span class="variable">docModule</span> <span class="operator">=</span> dalvikVM.loadLibrary(<span class="string">&quot;doc&quot;</span>, soFile.getBytes(), <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<p>VM同样能够加载Elf模块，具体的差异就是如果指定了APK文件，可以使用上述第一个重载方法指定模块名称，unidbg会自行从APK文件中提取该So文件进行加载。第二个重载方法使用较少，指定byte[]数据进行加载，名称由参数一指定。<br />返回一个DalvikModule实例，可调用JNI_OnLoad函数:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docModule.callJNI_OnLoad(emulator); </span><br></pre></td></tr></table></figure>
<p>该实例还维护了一个Module实例，可使用下面方法获取。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Module</span> <span class="variable">module</span> <span class="operator">=</span> docModule.getModule(); </span><br></pre></td></tr></table></figure>
<p>有关Module实例请查看<a href="#Module">Module</a></p>
<h3 id="VM总结"><a href="#VM总结" class="headerlink" title="VM总结"></a>VM总结</h3><p>上述的几个接口主要来控制VM或获取APK文件信息，VM其中的方法不止于这些，我们留到JNI部分来介绍，因为其他的几个方法都是有关于JNI交互场景的，也就是unidbg中的环境问题。<br />unidbg补环境、JNI交互请查看<a href="#JNI">JNI介绍</a></p>
<h2 id="CallMethod"><a href="#CallMethod" class="headerlink" title="CallMethod"></a>CallMethod</h2><h3 id="执行JNI函数"><a href="#执行JNI函数" class="headerlink" title="执行JNI函数"></a>执行JNI函数</h3><ul>
<li>我们首先来写一段小案例来说明如何在unidbg中执行JNI函数</li>
</ul>
<p>Java层:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.github.unidbg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;native-doc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">jnitest</span><span class="params">(String arg)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>So层:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;jni.h&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line"></span><br><span class="line">using namespace std;</span><br><span class="line"></span><br><span class="line">extern <span class="string">&quot;C&quot;</span></span><br><span class="line">JNIEXPORT jstring JNICALL</span><br><span class="line"><span class="title function_">Java_com_github_unidbg_Test_jnitest</span><span class="params">(JNIEnv *env, jobject thiz, jstring arg)</span> &#123;</span><br><span class="line">    const <span class="type">char</span> *c_arg = env-&gt;GetStringUTFChars(arg, nullptr);</span><br><span class="line">    <span class="type">string</span> <span class="variable">hello</span> <span class="operator">=</span> <span class="string">&quot;unidbg:&quot;</span>;</span><br><span class="line">    hello.append(c_arg);</span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(hello.c_str());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>非常简单的一段小例子，我们就以该例子来说明如何调用libnative-doc.so中的jnitest函数。</p>
<ul>
<li><p>第一步: 创建一个DvmObject，此对象相当于在Java层去调用native函数的类的实例对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建一个类的实例对象</span></span><br><span class="line">DvmObject&lt;?&gt; obj = vm.resolveClass(<span class="string">&quot;com/github/unidbg/Test&quot;</span>).newObject(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>
<p>关于实例对象的介绍请查看<a href="#%E5%AF%B9%E8%B1%A1-x2F-%E5%AE%9E%E4%BE%8B">JNI对象&#x2F;实例</a></p>
</li>
<li><p>第二步: 使用该对象调用JNI方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//参数一: Emulator实例</span></span><br><span class="line"><span class="comment">//参数二: 方法的签名</span></span><br><span class="line"><span class="comment">//参数三: 可变参数，传需要向该方法传递的参数</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> obj.callJniMethodObject(emulator, <span class="string">&quot;jnitest(Ljava/lang/String;)Ljava/lang/String;&quot;</span>, <span class="string">&quot;yyds!&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>我们拥有了一个实例对象，就可以像在Java中那样来调用native方法了，针对Java层中不同返回值调用的API不同，请查看<a href="#JNI%E6%96%B9%E6%B3%95%E5%B0%81%E8%A3%85">JNI方法封装</a><br />参数二是方法的签名，此参数如何填写请查看<a href="#JNI%E6%96%B9%E6%B3%95%E5%B0%81%E8%A3%85">JNI方法签名</a></p>
</li>
</ul>
<h3 id="执行任意函数"><a href="#执行任意函数" class="headerlink" title="执行任意函数"></a>执行任意函数</h3><p>当我们想执行的函数并非导出函数，也可使用地址进行调用，请自行参考unidbg对JNI函数调用的封装，自行实现此部分。</p>
<h3 id="执行main函数"><a href="#执行main函数" class="headerlink" title="执行main函数"></a>执行main函数</h3><p>如果加载的文件是一个可执行文件，需要持有该文件被加载后返回的Module实例来调用callEntry方法，请查看<a href="#Module">Module</a></p>
<h3 id="JNI方法封装"><a href="#JNI方法封装" class="headerlink" title="JNI方法封装"></a>JNI方法封装</h3><h4 id="void"><a href="#void" class="headerlink" title="void"></a>void</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DvmClass</span> <span class="variable">testClass</span> <span class="operator">=</span> vm.resolveClass(<span class="string">&quot;com/github/unidbg/Test&quot;</span>);</span><br><span class="line">DvmObject&lt;?&gt; obj = testClass.newObject(<span class="literal">null</span>);</span><br><span class="line"><span class="comment">//调用void返回值的函数</span></span><br><span class="line">testClass.callStaticJniMethod(emulator, <span class="string">&quot;signature&quot;</span>, args);</span><br><span class="line">obj.callJniMethod(emulator,<span class="string">&quot;signature&quot;</span>, args);</span><br></pre></td></tr></table></figure>

<h4 id="boolean"><a href="#boolean" class="headerlink" title="boolean"></a>boolean</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DvmClass</span> <span class="variable">testClass</span> <span class="operator">=</span> vm.resolveClass(<span class="string">&quot;com/github/unidbg/Test&quot;</span>);</span><br><span class="line">DvmObject&lt;?&gt; obj = testClass.newObject(<span class="literal">null</span>);</span><br><span class="line"><span class="comment">//调用boolean返回值的函数</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">ret</span> <span class="operator">=</span> testClass.callStaticJniMethodBoolean(emulator, <span class="string">&quot;signature&quot;</span>, args);</span><br><span class="line"><span class="type">boolean</span> <span class="variable">ret</span> <span class="operator">=</span> obj.callJniMethodBoolean(emulator, <span class="string">&quot;signature&quot;</span>, args);</span><br></pre></td></tr></table></figure>

<h4 id="int"><a href="#int" class="headerlink" title="int"></a>int</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DvmClass</span> <span class="variable">testClass</span> <span class="operator">=</span> vm.resolveClass(<span class="string">&quot;com/github/unidbg/Test&quot;</span>);</span><br><span class="line">DvmObject&lt;?&gt; obj = testClass.newObject(<span class="literal">null</span>);</span><br><span class="line"><span class="comment">//调用int返回值的函数</span></span><br><span class="line"><span class="type">int</span> <span class="variable">ret</span> <span class="operator">=</span> testClass.callStaticJniMethodInt(emulator, <span class="string">&quot;signature&quot;</span>, args);</span><br><span class="line"><span class="type">int</span> <span class="variable">ret</span> <span class="operator">=</span> obj.callJniMethodInt(emulator, <span class="string">&quot;signature&quot;</span>, args);</span><br></pre></td></tr></table></figure>

<h4 id="long"><a href="#long" class="headerlink" title="long"></a>long</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DvmClass</span> <span class="variable">testClass</span> <span class="operator">=</span> vm.resolveClass(<span class="string">&quot;com/github/unidbg/Test&quot;</span>);</span><br><span class="line">DvmObject&lt;?&gt; obj = testClass.newObject(<span class="literal">null</span>);</span><br><span class="line"><span class="comment">//调用long返回值的函数</span></span><br><span class="line"><span class="type">long</span> <span class="variable">ret</span> <span class="operator">=</span> testClass.callStaticJniMethodLong(emulator, <span class="string">&quot;signature&quot;</span>, args);</span><br><span class="line"><span class="type">long</span> <span class="variable">ret</span> <span class="operator">=</span> obj.callJniMethodLong(emulator, <span class="string">&quot;signature&quot;</span>, args);</span><br></pre></td></tr></table></figure>

<h4 id="float"><a href="#float" class="headerlink" title="float"></a>float</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DvmClass</span> <span class="variable">testClass</span> <span class="operator">=</span> vm.resolveClass(<span class="string">&quot;com/github/unidbg/Test&quot;</span>);</span><br><span class="line">DvmObject&lt;?&gt; obj = testClass.newObject(<span class="literal">null</span>);</span><br><span class="line"><span class="type">int</span> <span class="variable">ret</span> <span class="operator">=</span> testClass.callStaticJniMethodInt(emulator, <span class="string">&quot;signature&quot;</span>, args);</span><br><span class="line"><span class="type">int</span> <span class="variable">ret</span> <span class="operator">=</span> obj.callJniMethodInt(emulator, <span class="string">&quot;signature&quot;</span>, args);</span><br></pre></td></tr></table></figure>
<p>先拿到4字节的int数据，然后将其转换</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteBuffer</span> <span class="variable">allocate</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">4</span>);</span><br><span class="line">allocate.putInt(ret);</span><br><span class="line">allocate.flip();</span><br><span class="line"><span class="type">float</span> <span class="variable">f_ret</span> <span class="operator">=</span> allocate.getFloat();</span><br></pre></td></tr></table></figure>

<h4 id="double"><a href="#double" class="headerlink" title="double"></a>double</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DvmClass</span> <span class="variable">testClass</span> <span class="operator">=</span> vm.resolveClass(<span class="string">&quot;com/github/unidbg/Test&quot;</span>);</span><br><span class="line">DvmObject&lt;?&gt; obj = testClass.newObject(<span class="literal">null</span>);</span><br><span class="line"><span class="type">long</span> <span class="variable">ret</span> <span class="operator">=</span> testClass.callStaticJniMethodLong(emulator, <span class="string">&quot;signature&quot;</span>, args);</span><br><span class="line"><span class="type">long</span> <span class="variable">ret</span> <span class="operator">=</span> obj.callJniMethodLong(emulator, <span class="string">&quot;signature&quot;</span>, args);</span><br></pre></td></tr></table></figure>
<p>先拿到8字节的long数据，然后将其转换</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteBuffer</span> <span class="variable">allocate</span> <span class="operator">=</span> ByteBuffer.allocate(<span class="number">8</span>);</span><br><span class="line">allocate.putLong(ret);</span><br><span class="line">allocate.flip();</span><br><span class="line"><span class="type">double</span> <span class="variable">d_ret</span> <span class="operator">=</span> allocate.getDouble();</span><br></pre></td></tr></table></figure>

<h4 id="对象类型"><a href="#对象类型" class="headerlink" title="对象类型"></a>对象类型</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DvmClass</span> <span class="variable">testClass</span> <span class="operator">=</span> vm.resolveClass(<span class="string">&quot;com/github/unidbg/Test&quot;</span>);</span><br><span class="line">DvmObject&lt;?&gt; obj = testClass.newObject(<span class="literal">null</span>);</span><br><span class="line"><span class="comment">//调用对象类型返回值的函数</span></span><br><span class="line">DvmObject&lt;?&gt; ret = testClass.callStaticJniMethodObject(emulator, <span class="string">&quot;signature&quot;</span>, args);</span><br><span class="line">DvmObject&lt;?&gt;  ret = obj.callJniMethodObject(emulator, <span class="string">&quot;signature&quot;</span>, args);</span><br></pre></td></tr></table></figure>
<p>基本类型外的所有类型都为对象类型，包括基本类型的数组类型</p>
<h3 id="JNI方法签名"><a href="#JNI方法签名" class="headerlink" title="JNI方法签名"></a>JNI方法签名</h3><p>通过类名与方法签名的配合，才能定位到唯一的函数。所以一定要将方法签名填写正确，unidbg才可以找到对应的函数，所有的类型都按JNI本身定义的签名一致。</p>
<table>
<thead>
<tr>
<th><strong>Java类型</strong></th>
<th><strong>类型签名</strong></th>
</tr>
</thead>
<tbody><tr>
<td>boolean</td>
<td>Z</td>
</tr>
<tr>
<td>byte</td>
<td>B</td>
</tr>
<tr>
<td>char</td>
<td>C</td>
</tr>
<tr>
<td>long</td>
<td>J</td>
</tr>
<tr>
<td>float</td>
<td>F</td>
</tr>
<tr>
<td>double</td>
<td>D</td>
</tr>
<tr>
<td>short</td>
<td>S</td>
</tr>
<tr>
<td>int</td>
<td>I</td>
</tr>
<tr>
<td>类</td>
<td>L全限定类名;</td>
</tr>
<tr>
<td>数组</td>
<td>[元素类型签名</td>
</tr>
</tbody></table>
<p>unidbg方法签名如下格式:<br />方法名(参数列表)返回值 <br />举个例子:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">jnitest</span><span class="params">(String arg)</span>;</span><br></pre></td></tr></table></figure>
<p>对应的方法签名为:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jnitest(Ljava/lang/String;)Ljava/lang/String;</span><br></pre></td></tr></table></figure>



<h2 id="Hook"><a href="#Hook" class="headerlink" title="Hook"></a>Hook</h2><h3 id="Hook介绍"><a href="#Hook介绍" class="headerlink" title="Hook介绍"></a>Hook介绍</h3><p>Hook模块为unidbg引入第三方Hook框架而封装的一个模块，使用它可以快速对目标So进行hook操作。而API基本与第三方Hook框架保持一致。如果是32位程序，要注意Hook目标地址是否为Thumb模式，手动处理+1操作。</p>
<h3 id="Hook框架分类"><a href="#Hook框架分类" class="headerlink" title="Hook框架分类"></a>Hook框架分类</h3><h4 id="HookZz"><a href="#HookZz" class="headerlink" title="HookZz"></a>HookZz</h4><p>HookZz为Dobby的前身，32位模式下推荐使用HookZz。支持inline hook。</p>
<h5 id="获取HookZz实例"><a href="#获取HookZz实例" class="headerlink" title="获取HookZz实例"></a>获取HookZz实例</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HookZz hook = HookZz.getInstance(emulator);</span><br></pre></td></tr></table></figure>
<p>在使用任何Hook框架之前都需要拿到unidbg对该Hook框架的封装实例。</p>
<h5 id="HookZz-API"><a href="#HookZz-API" class="headerlink" title="HookZz API"></a>HookZz API</h5><h6 id="wrap"><a href="#wrap" class="headerlink" title="wrap"></a>wrap</h6><p>wrap的作用相当于在目标地址进行一层包装，回调到我们的代码，可以对其打印当前参数或寄存器的值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.获取HookZz实例</span></span><br><span class="line"><span class="type">HookZz</span> <span class="variable">hookZz</span> <span class="operator">=</span> HookZz.getInstance(emulator);</span><br><span class="line"><span class="comment">// 2.创建hook触发回调</span></span><br><span class="line">WrapCallback&lt;HookZzArm32RegisterContextImpl&gt; wrapCallback = <span class="keyword">new</span> <span class="title class_">WrapCallback</span>&lt;HookZzArm32RegisterContextImpl&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContextImpl ctx, HookEntryInfo info)</span> &#123;</span><br><span class="line">        <span class="comment">//hook函数进入前回调</span></span><br><span class="line">        System.out.println(<span class="string">&quot;arg0:&quot;</span> + ctx.getIntArg(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookZzArm32RegisterContextImpl ctx, HookEntryInfo info)</span> &#123;</span><br><span class="line">        <span class="comment">//hook函数返回后回调</span></span><br><span class="line">        System.out.println(<span class="string">&quot;ret:&quot;</span> + ctx.getIntArg(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 3.wrap</span></span><br><span class="line"><span class="type">long</span> <span class="variable">functionAddress</span> <span class="operator">=</span> <span class="keyword">module</span>.base + <span class="number">0xC09D</span><span class="comment">/*偏移*/</span>;</span><br><span class="line">hookZz.wrap(functionAddress, wrapCallback);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.wrap重载, hook导出符号</span></span><br><span class="line"><span class="type">Symbol</span> <span class="variable">symbol</span> <span class="operator">=</span> <span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;symbolName&quot;</span>);</span><br><span class="line">hookZz.wrap(symbol, wrapCallback);</span><br></pre></td></tr></table></figure>

<h6 id="replace"><a href="#replace" class="headerlink" title="replace"></a>replace</h6><p>replace可以进行替换目标函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取HookZz实例</span></span><br><span class="line"><span class="type">HookZz</span> <span class="variable">hookZz</span> <span class="operator">=</span> HookZz.getInstance(emulator);</span><br><span class="line"><span class="comment">//创建replace触发回调</span></span><br><span class="line"><span class="type">ReplaceCallback</span> <span class="variable">replaceCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReplaceCallback</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> HookStatus <span class="title function_">onCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context, <span class="type">long</span> originFunction)</span> &#123;</span><br><span class="line">        <span class="comment">//函数调用前回调。上层会根据HookStatus来决定程序流程</span></span><br><span class="line">        <span class="comment">//先来介绍几个参数</span></span><br><span class="line">        <span class="comment">//emulator: 模拟器实例</span></span><br><span class="line">        <span class="comment">//context: Hook上下文，可根据此参数获取各种参数。也可存储临时数据。</span></span><br><span class="line">        <span class="comment">//originFunction: 原函数地址</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//获取参数一并打印</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">arg0</span> <span class="operator">=</span> context.getIntArg(<span class="number">0</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;arg0:&quot;</span>+arg0);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//获取指针参数二并存入context</span></span><br><span class="line">        context.push(context.getPointerArg(<span class="number">1</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//修改参数三的值为0</span></span><br><span class="line">        <span class="type">EditableArm32RegisterContext</span> <span class="variable">ctx</span> <span class="operator">=</span> (EditableArm32RegisterContext) context;</span><br><span class="line">        ctx.setR2(<span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//可以在此改变函数流程</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">newFuncAddr</span> <span class="operator">=</span> <span class="keyword">module</span>.base + <span class="number">0xDC0</span><span class="comment">/*偏移*/</span>;</span><br><span class="line">        <span class="keyword">return</span> HookStatus.RET(emulator, newFuncAddr);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        //也可以直接返回一个值而不调用函数</span></span><br><span class="line"><span class="comment">        long retValue = 0L;</span></span><br><span class="line"><span class="comment">        return HookStatus.LR(emulator, retValue);</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context)</span> &#123;</span><br><span class="line">        <span class="comment">//此回调会根据hookZz.replace方法的第三个参数enablePostCall决定</span></span><br><span class="line">        <span class="comment">//可以获取context存储的数据</span></span><br><span class="line">        <span class="type">UnidbgPointer</span> <span class="variable">arg2</span> <span class="operator">=</span> context.pop();</span><br><span class="line">        <span class="comment">//可在此修改函数返回值</span></span><br><span class="line">        <span class="built_in">super</span>.postCall(emulator, context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="variable">functionAddress</span> <span class="operator">=</span> <span class="keyword">module</span>.base + <span class="number">0xC09D</span><span class="comment">/*偏移*/</span>;</span><br><span class="line"><span class="comment">//对目标地址进行inline hook, 并传入回调实例</span></span><br><span class="line">hookZz.replace(functionAddress, replaceCallback);</span><br><span class="line"><span class="comment">//replace重载，第三个参数控制是否可以修改返回值</span></span><br><span class="line">hookZz.replace(functionAddress, replaceCallback, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Symbol</span> <span class="variable">symbol</span> <span class="operator">=</span> <span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;symbolName&quot;</span>);</span><br><span class="line"><span class="comment">//使用符号进行hook</span></span><br><span class="line">hookZz.replace(symbol, replaceCallback);</span><br><span class="line">hookZz.replace(symbol, replaceCallback, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<h6 id="instrument"><a href="#instrument" class="headerlink" title="instrument"></a>instrument</h6><p>instrument提供了一种对单行汇编进行Hook的能力，使用场景较少。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取HookZz实例</span></span><br><span class="line"><span class="type">HookZz</span> <span class="variable">hookZz</span> <span class="operator">=</span> HookZz.getInstance(emulator);</span><br><span class="line"><span class="comment">//创建InstrumentCallback实例</span></span><br><span class="line">InstrumentCallback&lt;RegisterContext&gt; instrumentCallback = <span class="keyword">new</span> <span class="title class_">InstrumentCallback</span>&lt;RegisterContext&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dbiCall</span><span class="params">(Emulator&lt;?&gt; emulator, RegisterContext ctx, HookEntryInfo info)</span> &#123;</span><br><span class="line">        System.out.println(ctx.getIntArg(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="variable">functionAddress</span> <span class="operator">=</span> <span class="keyword">module</span>.base + <span class="number">0xC09D</span><span class="comment">/*偏移*/</span>;</span><br><span class="line"><span class="comment">//对单行地址进行hook</span></span><br><span class="line">hookZz.instrument(functionAddress, instrumentCallback);</span><br><span class="line"></span><br><span class="line"><span class="type">Symbol</span> <span class="variable">symbol</span> <span class="operator">=</span> <span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;symbolName&quot;</span>);</span><br><span class="line">hookZz.instrument(symbol, instrumentCallback);</span><br></pre></td></tr></table></figure>

<h4 id="Dobby"><a href="#Dobby" class="headerlink" title="Dobby"></a>Dobby</h4><p>64位模式下推荐使用Dobby进行inline hook。</p>
<h5 id="获取Dobby实例"><a href="#获取Dobby实例" class="headerlink" title="获取Dobby实例"></a>获取Dobby实例</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Dobby</span> <span class="variable">dobby</span> <span class="operator">=</span> Dobby.getInstance(emulator);</span><br></pre></td></tr></table></figure>

<h5 id="Dobby-API"><a href="#Dobby-API" class="headerlink" title="Dobby API"></a>Dobby API</h5><h6 id="replace-1"><a href="#replace-1" class="headerlink" title="replace"></a>replace</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Dobby</span> <span class="variable">dobby</span> <span class="operator">=</span> Dobby.getInstance(emulator);</span><br><span class="line"><span class="type">long</span> <span class="variable">functionAddress</span> <span class="operator">=</span> <span class="keyword">module</span>.base + <span class="number">0xC09D</span><span class="comment">/*偏移*/</span>;</span><br><span class="line">dobby.replace(functionAddress, <span class="keyword">new</span> <span class="title class_">ReplaceCallback</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> HookStatus <span class="title function_">onCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context, <span class="type">long</span> originFunction)</span> &#123;</span><br><span class="line">        <span class="type">Pointer</span> <span class="variable">result</span> <span class="operator">=</span> context.getPointerArg(<span class="number">0</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;input:&quot;</span> + result.getString(<span class="number">0</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.onCall(emulator, context, originFunction);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postCall</span><span class="params">(Emulator&lt;?&gt; emulator, HookContext context)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.postCall(emulator, context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>
<p>Dobby.replace的用法同HookZz，详细使用请查看<a href="#replace">HookZz-replace</a></p>
<h6 id="instrument-1"><a href="#instrument-1" class="headerlink" title="instrument"></a>instrument</h6><p>同HookZz中的<a href="#instrument-1">instrument</a>。</p>
<h4 id="xHook"><a href="#xHook" class="headerlink" title="xHook"></a>xHook</h4><p>xHook框架实现原理本身就存在局限性，只能够hook符号表函数。有好有坏，它的优点就是稳定。</p>
<h5 id="获取xHook实例"><a href="#获取xHook实例" class="headerlink" title="获取xHook实例"></a>获取xHook实例</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">IxHook</span> <span class="variable">hook</span> <span class="operator">=</span> XHookImpl.getInstance(emulator);</span><br></pre></td></tr></table></figure>

<h5 id="xHook-API"><a href="#xHook-API" class="headerlink" title="xHook API"></a>xHook API</h5><h6 id="register"><a href="#register" class="headerlink" title="register"></a>register</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">IxHook</span> <span class="variable">hook</span> <span class="operator">=</span> XHookImpl.getInstance(emulator);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>xHook的register方法的第一个参数为pathname_regex_str, 其支持POSIX BRE (Basic Regular Expression) 定义的正则表达式语法。用来检索符合条件的So。第二个参数为符号名。详情请看<a class="link"   target="_blank" rel="noopener" href="https://github.com/iqiyi/xHook/blob/master/README.zh-CN.md" >xhook介绍<i class="fas fa-external-link-alt"></i></a></p>
<h6 id="refresh"><a href="#refresh" class="headerlink" title="refresh"></a>refresh</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hook.refresh(); </span><br></pre></td></tr></table></figure>
<p>在使用xHook进行hook时，务必调用此方法进行刷新才能生效。</p>
<h4 id="Whale"><a href="#Whale" class="headerlink" title="Whale"></a>Whale</h4><p>Whale Hook框架为跨平台的Hook框架，在Android中的实现为inline hook。</p>
<h5 id="获取Whale实例"><a href="#获取Whale实例" class="headerlink" title="获取Whale实例"></a>获取Whale实例</h5><p>IWhale whale &#x3D; Whale.getInstance(emulator); </p>
<h5 id="Whale-API"><a href="#Whale-API" class="headerlink" title="Whale API"></a>Whale API</h5><p>TODO</p>
<h4 id="原生hook"><a href="#原生hook" class="headerlink" title="原生hook"></a>原生hook</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">emulator.attach().addBreakPoint(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;memcmp&quot;</span>).getAddress(), <span class="keyword">new</span> <span class="title class_">BreakPointCallback</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">long</span> address)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;callMemcmp作比较&quot;</span>);</span><br><span class="line">        <span class="type">RegisterContext</span> <span class="variable">registerContext</span> <span class="operator">=</span> emulator.getContext();</span><br><span class="line">        <span class="type">UnidbgPointer</span> <span class="variable">arg1</span> <span class="operator">=</span> registerContext.getPointerArg(<span class="number">0</span>);</span><br><span class="line">        <span class="type">UnidbgPointer</span> <span class="variable">arg2</span> <span class="operator">=</span> registerContext.getPointerArg(<span class="number">1</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> registerContext.getIntArg(<span class="number">2</span>);</span><br><span class="line">        Inspector.inspect(arg1.getByteArray(<span class="number">0</span>, length), <span class="string">&quot;arg1&quot;</span>);</span><br><span class="line">        Inspector.inspect(arg2.getByteArray(<span class="number">0</span>, length), <span class="string">&quot;arg2&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (arg1.getString(<span class="number">0</span>).equals(<span class="string">&quot;Context&quot;</span>))&#123;</span><br><span class="line">            emulator.attach().debug();</span><br><span class="line">            <span class="comment">// mr1</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h3><p>第一种，使用arm转机器码<br />转换网址 <a class="link"   target="_blank" rel="noopener" href="https://armconverter.com/" >https://armconverter.com/<i class="fas fa-external-link-alt"></i></a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">patch</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">UnidbgPointer</span> <span class="variable">pointer</span> <span class="operator">=</span> UnidbgPointer.pointer(emulator,<span class="keyword">module</span>.base + <span class="number">0x3E8</span>);</span><br><span class="line">    <span class="type">byte</span>[] code = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;(<span class="type">byte</span>) <span class="number">0xd0</span>, <span class="number">0x1a</span>&#125;;</span><br><span class="line">    pointer.write(code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二种，使用keystone</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">patch2</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">UnidbgPointer</span> <span class="variable">pointer</span> <span class="operator">=</span> UnidbgPointer.pointer(emulator,<span class="keyword">module</span>.base + <span class="number">0x3E8</span>);</span><br><span class="line">    <span class="type">Keystone</span> <span class="variable">keystone</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Keystone</span>(KeystoneArchitecture.Arm, KeystoneMode.ArmThumb);</span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;subs r0, r2, r3&quot;</span>;</span><br><span class="line">    <span class="type">byte</span>[] machineCode = keystone.assemble(s).getMachineCode();</span><br><span class="line">    <span class="comment">//byte[] code = ;</span></span><br><span class="line">    pointer.write(machineCode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="JNI"><a href="#JNI" class="headerlink" title="JNI"></a>JNI</h2><h3 id="JNI介绍"><a href="#JNI介绍" class="headerlink" title="JNI介绍"></a>JNI介绍</h3><p>当一个So在模拟执行的过程中，它要与Java层进行交互，比如获取Java层某个字段的值、调用Java层的某个方法获取返回值等等，如果你不告诉unidbg如何做，那程序就无法执行下去。你告诉undibg碰到访问Java层的某些东西的时候该怎么做的这个过程，从而让程序正确的执行下去，就叫做补环境。<br />我们在JNI部分来介绍unidbg如何来补环境，首先我们要来看unidbg中的几个概念</p>
<h3 id="类-x2F-类型"><a href="#类-x2F-类型" class="headerlink" title="类&#x2F;类型"></a>类&#x2F;类型</h3><p>Java中可以抽象出一个类，一个类可以创建对象，可以调用该类上的静态方法。一个类的基本属性有很多，unidbg模拟了父类和接口。在unidbg中对应的为DvmClass。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//参数一: 类名</span></span><br><span class="line"><span class="type">DvmClass</span> <span class="variable">Test</span> <span class="operator">=</span> vm.resolveClass(<span class="string">&quot;com/github/unidbg/Test&quot;</span>);</span><br><span class="line"><span class="comment">//重载方法，可以指定父类型。也就是表示了TestUnidbg继承了Test类。</span></span><br><span class="line"><span class="type">DvmClass</span> <span class="variable">dvmClass</span> <span class="operator">=</span> vm.resolveClass(<span class="string">&quot;com/github/unidbg/TestUnidbg&quot;</span>, Test);</span><br></pre></td></tr></table></figure>
<p>VM的resolveClass方法会创建出一个类型，可以理解为Java中的一个类，参数为全限定类名，将.换为&#x2F;。这样就创建出来一种类型了。我们可以基于此类型创建对象。</p>
<h3 id="对象-x2F-实例"><a href="#对象-x2F-实例" class="headerlink" title="对象&#x2F;实例"></a>对象&#x2F;实例</h3><p>Java层肯定会有对象的，或者叫做实例，unidbg中对应的叫做DvmObject。unidbg中所有的Java层的对象都直接或间接的继承自DvmObject。模拟创建对象:</p>
<ul>
<li><p>第一种方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DvmClass</span> <span class="variable">dvmClass</span> <span class="operator">=</span> vm.resolveClass(<span class="string">&quot;com/github/unidbg/Test&quot;</span>);</span><br><span class="line"><span class="comment">//参数一: 值</span></span><br><span class="line">DvmObject&lt;?&gt; obj = dvmClass.newObject(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>
<p>在Java中，有了类，就可以new对象了对吧。unidbg的newObject操作就类似这样。它可以有了一种类型后进行创建对象，其中的参数你可以存储任意类型的数据，此数据就会与该DvmObject绑定。</p>
</li>
<li><p>第二种方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据数据来创建DvmObject</span></span><br><span class="line"><span class="comment">//参数一: VM实例</span></span><br><span class="line"><span class="comment">//参数二: value</span></span><br><span class="line">DvmObject&lt;?&gt; obj = ProxyDvmObject.createObject(vm, <span class="built_in">this</span>);</span><br></pre></td></tr></table></figure>
<p>unidbg会根据此value值的类型来创建DvmObject。如果value为基本数据类型则会被封装为该基本类型的包装类型。如果value为一个对象，则会获取该对象所对应的Class，根据Class名称来自动创建该类型，然后创建一个对象，相当于对第一种方法的一个封装。如果为数组类型，则会被封装为由unidbg创建的包装对象。</p>
</li>
</ul>
<h3 id="包装对象"><a href="#包装对象" class="headerlink" title="包装对象"></a>包装对象</h3><p>理论上所有的Java层的对象在unidbg中都可以按照上面所述的方法进行创建。但unidbg内部有部分封装，所以在使用的时候我们要使用unidbg的包装对象</p>
<h4 id="String"><a href="#String" class="headerlink" title="String"></a>String</h4><p>String类型被封装为StringObject</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">StringObject</span>(vm,<span class="string">&quot;unidbg&quot;</span>); </span><br></pre></td></tr></table></figure>

<h4 id="Array"><a href="#Array" class="headerlink" title="Array"></a>Array</h4><p>数组类型在使用的时候按如下使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//byte[]</span></span><br><span class="line"><span class="type">ByteArray</span> <span class="variable">byteArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArray</span>(vm, <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//int[]</span></span><br><span class="line"><span class="type">IntArray</span> <span class="variable">intArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntArray</span>(vm, <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//short[]</span></span><br><span class="line"><span class="type">ShortArray</span> <span class="variable">shortArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShortArray</span>(vm, <span class="keyword">new</span> <span class="title class_">short</span>[]&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//float[]</span></span><br><span class="line"><span class="type">FloatArray</span> <span class="variable">floatArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FloatArray</span>(vm, <span class="keyword">new</span> <span class="title class_">float</span>[]&#123;<span class="number">1.0f</span>, <span class="number">2.0f</span>, <span class="number">3.0f</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//double[]</span></span><br><span class="line"><span class="type">DoubleArray</span> <span class="variable">doubleArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DoubleArray</span>(vm, <span class="keyword">new</span> <span class="title class_">double</span>[]&#123;<span class="number">1.0d</span>, <span class="number">2.0d</span>, <span class="number">3.0d</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//Object[]</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ArrayObject</span>(byteArray, intArray);</span><br></pre></td></tr></table></figure>

<h4 id="List"><a href="#List" class="headerlink" title="List"></a>List</h4><p>List类型的数据被封装为ArrayListObject</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DvmClass</span> <span class="variable">Test</span> <span class="operator">=</span> vm.resolveClass(<span class="string">&quot;com/github/unidbg/Test&quot;</span>);</span><br><span class="line">List&lt;DvmObject&lt;?&gt;&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">list.add(Test.newObject(<span class="literal">null</span>));</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ArrayListObject</span>(vm,list);</span><br></pre></td></tr></table></figure>

<!-- ### 补环境
TODO -->

<h2 id="Module"><a href="#Module" class="headerlink" title="Module"></a>Module</h2><h3 id="Module介绍"><a href="#Module介绍" class="headerlink" title="Module介绍"></a>Module介绍</h3><p>在undibg中，经过Memory加载到内存中的Elf文件，都被抽象为一个Module(LinuxModule)对象。无论是Emulator还是VM加载的，底层都是对Memory的load进行了封装，返回值就是一个Module实例。</p>
<h3 id="Module常用的属性"><a href="#Module常用的属性" class="headerlink" title="Module常用的属性"></a>Module常用的属性</h3><h4 id="base"><a href="#base" class="headerlink" title="base"></a>base</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Module</span> <span class="variable">module</span> <span class="operator">=</span> emulator.loadLibrary(file, <span class="literal">true</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;加载的基址: &quot;</span>+<span class="keyword">module</span>.base);</span><br></pre></td></tr></table></figure>
<p>base属性维护了该Elf文件被加载到内存中的基址。</p>
<h4 id="name"><a href="#name" class="headerlink" title="name"></a>name</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Module</span> <span class="variable">module</span> <span class="operator">=</span> emulator.loadLibrary(file, <span class="literal">true</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;模块的名称: &quot;</span>+<span class="keyword">module</span>.name);</span><br></pre></td></tr></table></figure>
<p>name属性维护了该模块的名称，通常为文件名。</p>
<h4 id="callEntry"><a href="#callEntry" class="headerlink" title="callEntry"></a>callEntry</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Module</span> <span class="variable">module</span> <span class="operator">=</span> emulator.loadLibrary(file, <span class="literal">true</span>);</span><br><span class="line"><span class="type">int</span> <span class="variable">ret</span> <span class="operator">=</span> <span class="keyword">module</span>.callEntry(emulator);</span><br></pre></td></tr></table></figure>
<p>当被加载的文件是可执行文件时，需要通过该方法来调用main函数。</p>
<h4 id="findSymbolByName"><a href="#findSymbolByName" class="headerlink" title="findSymbolByName"></a>findSymbolByName</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Module</span> <span class="variable">module</span> <span class="operator">=</span> emulator.loadLibrary(file, <span class="literal">true</span>);</span><br><span class="line"><span class="type">Symbol</span> <span class="variable">symbol</span> <span class="operator">=</span> <span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;symbolName&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>通过名字查找当前模块中的符号。</p>
<h2 id="Backend"><a href="#Backend" class="headerlink" title="Backend"></a>Backend</h2><h3 id="Backend介绍"><a href="#Backend介绍" class="headerlink" title="Backend介绍"></a>Backend介绍</h3><p>unidbg内置了五种Backend。Backend的作用是用来模拟执行机器指令。它作为一个模块被unidbg引入，提供了模拟CPU的能力，且被封装为统一的Backend接口。</p>
<h3 id="Backend列表"><a href="#Backend列表" class="headerlink" title="Backend列表"></a>Backend列表</h3><p>unidbg默认使用Unicorn后端。即在创建AndroidEmulator时无额外添加BackendFactory即为Unicorn后端。</p>
<h4 id="Unicorn-x2F-Unicorn2"><a href="#Unicorn-x2F-Unicorn2" class="headerlink" title="Unicorn&#x2F;Unicorn2"></a>Unicorn&#x2F;Unicorn2</h4><p><a class="link"   target="_blank" rel="noopener" href="https://www.unicorn-engine.org/" >Unicorn官网<i class="fas fa-external-link-alt"></i></a></p>
<h5 id="使用Unicorn2后端"><a href="#使用Unicorn2后端" class="headerlink" title="使用Unicorn2后端:"></a>使用Unicorn2后端:</h5><p>emulator &#x3D; AndroidEmulatorBuilder           .for32Bit()           .addBackendFactory(new Unicorn2Factory(true))           .build();<br />Unicorn2Factory构造方法的参数表示在Unicorn2创建失败时，是否退回使用Unicorn后端。如设置false，在Unicorn2后端创建失败后就退出，而不选择使用Unicorn后端。</p>
<h5 id="Unicorn后端特点"><a href="#Unicorn后端特点" class="headerlink" title="Unicorn后端特点"></a>Unicorn后端特点</h5><ul>
<li>执行较其他后端慢</li>
<li>支持原生Hook</li>
<li>支持Debugger功能</li>
<li>支持原生Trace</li>
</ul>
<p>对调试、Trace功能支持较好，缺点是执行较慢。推荐在实验环境中使用。</p>
<h4 id="Dynarmic"><a href="#Dynarmic" class="headerlink" title="Dynarmic"></a>Dynarmic</h4><p><a class="link"   target="_blank" rel="noopener" href="https://github.com/MerryMage/dynarmic" >Dynarmic官网<i class="fas fa-external-link-alt"></i></a></p>
<h5 id="使用Dynarmic后端"><a href="#使用Dynarmic后端" class="headerlink" title="使用Dynarmic后端"></a>使用Dynarmic后端</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">emulator = AndroidEmulatorBuilder</span><br><span class="line">          .for32Bit()</span><br><span class="line">          .addBackendFactory(<span class="keyword">new</span> <span class="title class_">DynarmicFactory</span>(<span class="literal">true</span>))</span><br><span class="line">          .build();</span><br></pre></td></tr></table></figure>

<h5 id="Dynarmic后端特点"><a href="#Dynarmic后端特点" class="headerlink" title="Dynarmic后端特点"></a>Dynarmic后端特点</h5><ul>
<li>执行速度快</li>
<li>无原生Hook功能</li>
</ul>
<p>生产环境推荐使用，速度比Unicorn快很多。</p>
<h4 id="Hypervisor"><a href="#Hypervisor" class="headerlink" title="Hypervisor"></a>Hypervisor</h4><p><a class="link"   target="_blank" rel="noopener" href="https://github.com/Bareflank/hypervisor" >Hypervisor官网<i class="fas fa-external-link-alt"></i></a></p>
<h5 id="使用Hypervisor后端"><a href="#使用Hypervisor后端" class="headerlink" title="使用Hypervisor后端"></a>使用Hypervisor后端</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">emulator = AndroidEmulatorBuilder</span><br><span class="line">          .for32Bit()</span><br><span class="line">          .addBackendFactory(<span class="keyword">new</span> <span class="title class_">HypervisorFactory</span>(<span class="literal">true</span>))</span><br><span class="line">          .build()</span><br></pre></td></tr></table></figure>

<h5 id="Hypervisor后端特点"><a href="#Hypervisor后端特点" class="headerlink" title="Hypervisor后端特点"></a>Hypervisor后端特点</h5><ul>
<li>支持Apple M1</li>
<li>最快的ARM64后端</li>
</ul>
<h4 id="Kvm"><a href="#Kvm" class="headerlink" title="Kvm"></a>Kvm</h4><p><a class="link"   target="_blank" rel="noopener" href="https://github.com/kholia/OSX-KVM" >Kvm官网<i class="fas fa-external-link-alt"></i></a></p>
<h5 id="使用Kvm后端"><a href="#使用Kvm后端" class="headerlink" title="使用Kvm后端"></a>使用Kvm后端</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">emulator = AndroidEmulatorBuilder</span><br><span class="line">          .for64Bit()</span><br><span class="line">          .addBackendFactory(<span class="keyword">new</span> <span class="title class_">KvmFactory</span>(<span class="literal">false</span>))</span><br><span class="line">          .build();</span><br></pre></td></tr></table></figure>

<h5 id="Kvm后端特点"><a href="#Kvm后端特点" class="headerlink" title="Kvm后端特点"></a>Kvm后端特点</h5><ul>
<li>支持Raspberry Pi B4</li>
</ul>
<h3 id="Backend接口"><a href="#Backend接口" class="headerlink" title="Backend接口"></a>Backend接口</h3><p>Backend为CPU的抽象接口，通过它可以直接读写CPU的寄存器的值、内存读写。unidbg对此类接口都有对应的封装，不建议直接使用此类接口。</p>
<h2 id="Deggbuer"><a href="#Deggbuer" class="headerlink" title="Deggbuer"></a>Deggbuer</h2><h3 id="Debugger介绍"><a href="#Debugger介绍" class="headerlink" title="Debugger介绍"></a>Debugger介绍</h3><p><strong>重要提醒: 只有unicorn后端支持调试功能！！！</strong> <strong>重要提醒: 只有unicorn后端支持调试功能！！！</strong> <strong>重要提醒: 只有unicorn后端支持调试功能！！！</strong><br />调试是在逆向工程中不可缺少的一个功能，可以帮助我们快速定位问题。在unidbg也是支持的，而且这部分功能基于原生Unicorn后端，支持非常好。<br />主要功能:</p>
<ul>
<li>断点调试</li>
<li>内存读写</li>
<li>寄存器读写</li>
<li>单步调试</li>
<li>堆栈搜索</li>
<li>调用栈打印</li>
<li>反汇编</li>
<li>patch</li>
</ul>
<h3 id="ConsoleDebugger"><a href="#ConsoleDebugger" class="headerlink" title="ConsoleDebugger"></a>ConsoleDebugger</h3><h4 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h4><h5 id="第零步"><a href="#第零步" class="headerlink" title="第零步"></a>第零步</h5><p>再提示一下，先将后端切换回Unicorn。如何切换请查看: <a href="#Backend">Backend</a></p>
<h5 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h5><p>得到控制台调试器实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Debugger</span> <span class="variable">debugger</span> <span class="operator">=</span> emulator.attach();</span><br></pre></td></tr></table></figure>

<h5 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h5><p>下断点。下断点有多种重载方便使用:</p>
<ul>
<li>模块 + 偏移</li>
<li>模块 + 符号名</li>
<li>绝对地址<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//模块 + 偏移</span></span><br><span class="line">debugger.addBreakPoint(<span class="keyword">module</span>, <span class="number">0x8607</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//模块 + 符号</span></span><br><span class="line">debugger.addBreakPoint(<span class="keyword">module</span>, <span class="string">&quot;Java_com_github_unidbg_Test_sign&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绝对地址</span></span><br><span class="line"><span class="type">long</span> <span class="variable">address</span> <span class="operator">=</span> <span class="keyword">module</span>.base + <span class="number">0x8607</span>;</span><br><span class="line">debugger.addBreakPoint(address);</span><br></pre></td></tr></table></figure>
<strong><font color="red">下断点无需手动thumb指令+1操作，手动+1下断点也是一样的效果。但手动+1会有其他的作用，如查看断点等功能，推荐手动+1。</font></strong><br />还有其他三种断点重载，添加一个断点回调:<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BreakPointCallback</span> <span class="variable">breakPointCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BreakPointCallback</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">long</span> address)</span> &#123;</span><br><span class="line">      <span class="comment">//当断点命中会回调此方法</span></span><br><span class="line">      <span class="comment">//do something...</span></span><br><span class="line">      <span class="comment">//返回值决定是否进入手动调试。</span></span><br><span class="line">      <span class="comment">//返回true，则只回调此方法，不进入调试</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">debugger.addBreakPoint(<span class="keyword">module</span>, <span class="number">0x8607</span>, breakPointCallback);</span><br><span class="line"></span><br><span class="line">debugger.addBreakPoint(<span class="keyword">module</span>, <span class="string">&quot;Java_com_github_unidbg_Test_sign&quot;</span>, breakPointCallback);</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="variable">address</span> <span class="operator">=</span> <span class="keyword">module</span>.base + <span class="number">0x8607</span>;</span><br><span class="line">debugger.addBreakPoint(address, breakPointCallback);</span><br></pre></td></tr></table></figure></li>
</ul>
<h5 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a>第三步</h5><p>执行。无论使用哪种方式对目标地址下断点，在执行起来后如果执行到断点位置，就会在控制台断下等待命令的输入。以我目前例子，命中断点后输出如下所示:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">debugger <span class="keyword">break</span> at: <span class="number">0x40008606</span> @ Function32 address=<span class="number">0x40008607</span>, arguments=[unidbg@<span class="number">0xfffe12a0</span>[libadd.so]<span class="number">0x2a0</span>, <span class="number">17037394</span>, <span class="number">1</span>]</span><br><span class="line">&gt;&gt;&gt; r0=<span class="number">0xfffe12a0</span>(-<span class="number">126304</span>) r1=<span class="number">0x103f852</span> r2=<span class="number">0x1</span> r3=<span class="number">0x2</span> r4=<span class="number">0x0</span> r5=<span class="number">0x0</span> r6=<span class="number">0x0</span> r7=<span class="number">0x0</span> r8=<span class="number">0x0</span> sb=<span class="number">0x0</span> sl=<span class="number">0x0</span> fp=<span class="number">0x0</span> ip=<span class="number">0x401315e0</span></span><br><span class="line">&gt;&gt;&gt; SP=<span class="number">0xbffff730</span> LR=unidbg@<span class="number">0xffff0000</span> PC=RX@<span class="number">0x40008606</span>[libnative-doc.so]<span class="number">0x8606</span> cpsr: N=<span class="number">0</span>, Z=<span class="number">1</span>, C=<span class="number">0</span>, V=<span class="number">0</span>, T=<span class="number">1</span>, mode=<span class="number">0b10000</span></span><br><span class="line">&gt;&gt;&gt; d0=<span class="number">0x0</span>(<span class="number">0.0</span>) d1=<span class="number">0x3220302034203720</span>(<span class="number">3.002229861217884E-67</span>) d2=<span class="number">0x3436333832203236</span>(<span class="number">3.5366761868402984E-57</span>) d3=<span class="number">0x3120323938343135</span>(<span class="number">4.583358096989596E-72</span>) d4=<span class="number">0x2030203020302030</span>(<span class="number">1.2027122125173386E-153</span>) d5=<span class="number">0x2030203020302030</span>(<span class="number">1.2027122125173386E-153</span>) d6=<span class="number">0x2030203020302030</span>(<span class="number">1.2027122125173386E-153</span>) d7=<span class="number">0x2030203020302030</span>(<span class="number">1.2027122125173386E-153</span>)</span><br><span class="line">&gt;&gt;&gt; d8=<span class="number">0x0</span>(<span class="number">0.0</span>) d9=<span class="number">0x0</span>(<span class="number">0.0</span>) d10=<span class="number">0x0</span>(<span class="number">0.0</span>) d11=<span class="number">0x0</span>(<span class="number">0.0</span>) d12=<span class="number">0x0</span>(<span class="number">0.0</span>) d13=<span class="number">0x0</span>(<span class="number">0.0</span>) d14=<span class="number">0x0</span>(<span class="number">0.0</span>) d15=<span class="number">0x0</span>(<span class="number">0.0</span>)</span><br><span class="line">Java_com_github_unidbg_Test_sign + <span class="number">0x0</span></span><br><span class="line">=&gt; *[libnative-doc.so*<span class="number">0x08607</span>]*[80b5    ]*<span class="number">0x40008606</span>:*<span class="string">&quot;push &#123;r7, lr&#125;&quot;</span></span><br><span class="line">    [libnative-doc.so <span class="number">0x08609</span>] [6f46    ] <span class="number">0x40008608</span>: <span class="string">&quot;mov r7, sp&quot;</span></span><br><span class="line">    [libnative-doc.so <span class="number">0x0860b</span>] [84b0    ] <span class="number">0x4000860a</span>: <span class="string">&quot;sub sp, #0x10&quot;</span></span><br><span class="line">    [libnative-doc.so <span class="number">0x0860d</span>] [0390    ] <span class="number">0x4000860c</span>: <span class="string">&quot;str r0, [sp, #0xc]&quot;</span></span><br><span class="line">    [libnative-doc.so <span class="number">0x0860f</span>] [0291    ] <span class="number">0x4000860e</span>: <span class="string">&quot;str r1, [sp, #8]&quot;</span></span><br><span class="line">    [libnative-doc.so <span class="number">0x08611</span>] [0192    ] <span class="number">0x40008610</span>: <span class="string">&quot;str r2, [sp, #4]&quot;</span></span><br><span class="line">    [libnative-doc.so <span class="number">0x08613</span>] [0198    ] <span class="number">0x40008612</span>: <span class="string">&quot;ldr r0, [sp, #4]&quot;</span></span><br><span class="line">    [libnative-doc.so <span class="number">0x08615</span>] [4ff48061] <span class="number">0x40008614</span>: <span class="string">&quot;mov.w r1, #0x400&quot;</span></span><br><span class="line">    [libnative-doc.so <span class="number">0x08619</span>] [fff75aec] <span class="number">0x40008618</span>: <span class="string">&quot;blx #0x40007ed0&quot;</span></span><br><span class="line">    [libnative-doc.so <span class="number">0x0861d</span>] [04b0    ] <span class="number">0x4000861c</span>: <span class="string">&quot;add sp, #0x10&quot;</span></span><br><span class="line">    [libnative-doc.so <span class="number">0x0861f</span>] [80bd    ] <span class="number">0x4000861e</span>: <span class="string">&quot;pop &#123;r7, pc&#125;&quot;</span></span><br><span class="line">    [libnative-doc.so <span class="number">0x08621</span>] [80b5    ] <span class="number">0x40008620</span>: <span class="string">&quot;push &#123;r7, lr&#125;&quot;</span></span><br><span class="line">    [libnative-doc.so <span class="number">0x08623</span>] [6f46    ] <span class="number">0x40008622</span>: <span class="string">&quot;mov r7, sp&quot;</span></span><br><span class="line">    [libnative-doc.so <span class="number">0x08625</span>] [82b0    ] <span class="number">0x40008624</span>: <span class="string">&quot;sub sp, #8&quot;</span></span><br><span class="line">    [libnative-doc.so <span class="number">0x08627</span>] [0190    ] <span class="number">0x40008626</span>: <span class="string">&quot;str r0, [sp, #4]&quot;</span></span><br><span class="line">    [libnative-doc.so <span class="number">0x08629</span>] [0198    ] <span class="number">0x40008628</span>: <span class="string">&quot;ldr r0, [sp, #4]&quot;</span></span><br></pre></td></tr></table></figure>
<p>主要信息有: 断点和当前函数参数信息，当前所有寄存器信息，当前位置的反汇编信息。 看到如上调试信息后，unidbg就会等待命令的输入，命令才是ConsoleDebugger的核心。下面我们就来看如何使用命令来操作ConsoleDebugger。</p>
<h4 id="调试指令"><a href="#调试指令" class="headerlink" title="调试指令"></a>调试指令</h4><h5 id="help"><a href="#help" class="headerlink" title="help"></a>help</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">help </span><br></pre></td></tr></table></figure>
<p>会看到下面的输出，此为ConsoleDebugger的帮助文档。我们下面也是介绍此帮助文档的内容。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">help</span><br><span class="line">c: <span class="keyword">continue</span></span><br><span class="line">n: step over</span><br><span class="line">bt: back trace</span><br><span class="line"></span><br><span class="line">st hex: search stack</span><br><span class="line">shw hex: search writable heap</span><br><span class="line">shr hex: search readable heap</span><br><span class="line">shx hex: search executable heap</span><br><span class="line"></span><br><span class="line">nb: <span class="keyword">break</span> at next block</span><br><span class="line">s|si: step into</span><br><span class="line">s[decimal]: execute specified amount instruction</span><br><span class="line"><span class="title function_">s</span><span class="params">(blx)</span>: execute util BLX mnemonic, low performance</span><br><span class="line"></span><br><span class="line"><span class="title function_">m</span><span class="params">(op)</span> [size]: show memory, <span class="keyword">default</span> size is <span class="number">0x70</span>, size may hex or decimal</span><br><span class="line">mr0-mr7, mfp, mip, msp [size]: show memory of specified register</span><br><span class="line"><span class="title function_">m</span><span class="params">(address)</span> [size]: show memory of specified address, address must start with 0x</span><br><span class="line"></span><br><span class="line">wr0-wr7, wfp, wip, wsp &lt;value&gt;: write specified register</span><br><span class="line"><span class="title function_">wb</span><span class="params">(address)</span>, ws(address), wi(address) &lt;value&gt;: write (<span class="type">byte</span>, <span class="type">short</span>, integer) memory of specified address, address must start with 0x</span><br><span class="line"><span class="title function_">wx</span><span class="params">(address)</span> &lt;hex&gt;: write bytes to memory at specified address, address must start with 0x</span><br><span class="line"></span><br><span class="line"><span class="title function_">b</span><span class="params">(address)</span>: add temporarily breakpoint, address must start with 0x, can be <span class="keyword">module</span> offset</span><br><span class="line">b: add breakpoint of register PC</span><br><span class="line">r: remove breakpoint of register PC</span><br><span class="line">blr: add temporarily breakpoint of register LR</span><br><span class="line"></span><br><span class="line"><span class="title function_">p</span> <span class="params">(assembly)</span>: patch assembly at PC address</span><br><span class="line">where: show java stack trace</span><br><span class="line"></span><br><span class="line">trace [begin end]: Set trace instructions</span><br><span class="line">traceRead [begin end]: Set trace memory read</span><br><span class="line">traceWrite [begin end]: Set trace memory write</span><br><span class="line">vm: view loaded modules</span><br><span class="line">vbs: view breakpoints</span><br><span class="line">d|dis: show disassemble</span><br><span class="line"><span class="title function_">d</span><span class="params">(0x)</span>: show disassemble at specify address</span><br><span class="line">stop: stop emulation</span><br><span class="line">run [arg]: run test</span><br><span class="line">gc: Run System.gc()</span><br><span class="line">cc size: convert asm from <span class="number">0x40008608</span> - <span class="number">0x40008608</span> + size bytes to c function</span><br></pre></td></tr></table></figure>
<h4 id="shr"><a href="#shr" class="headerlink" title="shr"></a>shr</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shr 637c777bf26b6fc5</span><br></pre></td></tr></table></figure>
<p>内存查找字节</p>
<h5 id="show-disassemble"><a href="#show-disassemble" class="headerlink" title="show disassemble"></a>show disassemble</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d | dis</span><br></pre></td></tr></table></figure>
<p>打印当前位置反编译信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">d(address)</span><br><span class="line"><span class="comment">//如</span></span><br><span class="line">d0x40008607</span><br></pre></td></tr></table></figure>
<p>打印指定地址处的反编译信息。</p>
<h5 id="continue"><a href="#continue" class="headerlink" title="continue"></a>continue</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c</span><br></pre></td></tr></table></figure>
<p>继续执行。直至遇到下一个断点断下或运行结束。</p>
<h5 id="step-over"><a href="#step-over" class="headerlink" title="step over"></a>step over</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">n</span><br></pre></td></tr></table></figure>
<p>单步步过，不进入跳转指令。</p>
<h5 id="step-into"><a href="#step-into" class="headerlink" title="step into"></a>step into</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s | si </span><br></pre></td></tr></table></figure>
<p>单步执行。执行一句指令。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s10 </span><br></pre></td></tr></table></figure>
<p>执行10句指令。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sblx </span><br></pre></td></tr></table></figure>
<p>执行到blx指令。性能较低。</p>
<h5 id="next-block"><a href="#next-block" class="headerlink" title="next block"></a>next block</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nb </span><br></pre></td></tr></table></figure>
<p>执行到下一<a href="#Block">block</a>处。</p>
<h5 id="b"><a href="#b" class="headerlink" title="b"></a>b</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b </span><br></pre></td></tr></table></figure>
<p>可在当前PC处下断点。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b0x40008607 </span><br></pre></td></tr></table></figure>
<p>指定地址下断点。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b0x8607 </span><br></pre></td></tr></table></figure>
<p>指定偏移下断点，会根据当前位置的模块来计算。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blr </span><br></pre></td></tr></table></figure>
<p>在LR处下断点。</p>
<h5 id="r"><a href="#r" class="headerlink" title="r"></a>r</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r </span><br></pre></td></tr></table></figure>
<p>删除当前位置的断点。</p>
<h5 id="blr"><a href="#blr" class="headerlink" title="blr"></a>blr</h5><p>在函数返回时候下断点</p>
<h5 id="vbs"><a href="#vbs" class="headerlink" title="vbs"></a>vbs</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vbs </span><br></pre></td></tr></table></figure>
<p>查看当前下的所有断点。</p>
<h5 id="back-trace"><a href="#back-trace" class="headerlink" title="back trace"></a>back trace</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bt </span><br></pre></td></tr></table></figure>
<p>打印当前位置调用栈。</p>
<h5 id="show-memory"><a href="#show-memory" class="headerlink" title="show memory"></a>show memory</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mr0-mr7 | mfp | mip | msp [size]</span><br><span class="line"><span class="comment">//如</span></span><br><span class="line">mr1 <span class="number">0x10</span></span><br></pre></td></tr></table></figure>
<p>读取对应寄存器所指向的地址的内存。size指定大小，默认0x70大小。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">m(address) [size]</span><br><span class="line"><span class="comment">//如</span></span><br><span class="line">m0xbffff730 <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>读取指定地址的内存。地址必须为0x开头的十六进制数。</p>
<h5 id="write-memory"><a href="#write-memory" class="headerlink" title="write memory"></a>write memory</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wr0-wr7, wfp, wip, wsp &lt;value&gt;</span><br><span class="line"><span class="comment">//如</span></span><br><span class="line">wr2 <span class="number">0x100</span></span><br></pre></td></tr></table></figure>
<p>向对应寄存器写入value指定的值。此值可为0x开头十六进制数，可为十进制数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wb(address), ws(address), wi(address) &lt;value&gt;</span><br><span class="line"><span class="comment">//如</span></span><br><span class="line">wb0x40008606 <span class="number">1</span></span><br><span class="line">ws0x40008606 <span class="number">0xb502</span></span><br></pre></td></tr></table></figure>
<p>向指定地址写入value指定的值。写入的宽度由不同指令所指定，wb能写入一个字节数据、ws能short数据、wi能写入int数据，且大小端序会被自动转换。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wx(address) &lt;hex&gt;</span><br><span class="line"><span class="comment">//如</span></span><br><span class="line">wx0x40008606 b502</span><br></pre></td></tr></table></figure>
<p>向指定地址写入hex数据，此处hex不能加0x开头，直接写十六进制就可以了。</p>
<h5 id="search-stack"><a href="#search-stack" class="headerlink" title="search stack"></a>search stack</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">st &lt;hex&gt;</span><br><span class="line"><span class="comment">//如</span></span><br><span class="line">st <span class="number">313233</span></span><br></pre></td></tr></table></figure>
<p>在当前栈上搜索指定的hex数据。</p>
<h5 id="search-writable-heap"><a href="#search-writable-heap" class="headerlink" title="search writable heap"></a>search writable heap</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shr &lt;hex&gt;</span><br><span class="line"><span class="comment">//如</span></span><br><span class="line">shr <span class="number">313233</span></span><br></pre></td></tr></table></figure>
<p>在可写的内存搜索指定的hex数据。</p>
<h5 id="search-readable-heap"><a href="#search-readable-heap" class="headerlink" title="search readable heap"></a>search readable heap</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shx &lt;hex&gt;</span><br><span class="line"><span class="comment">//如</span></span><br><span class="line">shx 6f46</span><br></pre></td></tr></table></figure>
<p>在可读的内存搜索指定的hex数据。</p>
<h5 id="search-executable-heap"><a href="#search-executable-heap" class="headerlink" title="search executable heap"></a>search executable heap</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shx &lt;hex&gt;</span><br><span class="line"><span class="comment">//如</span></span><br><span class="line">shx 6f46</span><br></pre></td></tr></table></figure>
<p>在可执行的内存搜索指定的hex数据。</p>
<h5 id="where"><a href="#where" class="headerlink" title="where"></a>where</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">where </span><br></pre></td></tr></table></figure>
<p>打印当前unidbg的调用栈。</p>
<h5 id="vm"><a href="#vm" class="headerlink" title="vm"></a>vm</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm </span><br></pre></td></tr></table></figure>
<p>查看当前所有加载的模块。</p>
<h5 id="stop"><a href="#stop" class="headerlink" title="stop"></a>stop</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stop </span><br></pre></td></tr></table></figure>
<p>停止运行。</p>
<h5 id="patch-1"><a href="#patch-1" class="headerlink" title="patch"></a>patch</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p &lt;assembly&gt;</span><br><span class="line"><span class="comment">//如</span></span><br><span class="line">p movs r0, #<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>将当前位置进行patch，无需关心thumb。</p>
<h5 id="trace"><a href="#trace" class="headerlink" title="trace"></a>trace</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">trace [begin end]</span><br><span class="line"><span class="comment">//如</span></span><br><span class="line">trace <span class="number">0x40008606</span> <span class="number">0x40008612</span></span><br><span class="line"></span><br><span class="line">traceRead [begin end]</span><br><span class="line">traceWrite [begin end]</span><br></pre></td></tr></table></figure>
<p>指定起始结束位置进行trace。</p>
<h3 id="GDB-SERVER"><a href="#GDB-SERVER" class="headerlink" title="GDB_SERVER"></a>GDB_SERVER</h3><p>不推荐使用。请使用<a href="#ConsoleDebugger">ConsoleDebugger</a>。</p>
<h3 id="ANDROID-SERVER-V7"><a href="#ANDROID-SERVER-V7" class="headerlink" title="ANDROID_SERVER_V7"></a>ANDROID_SERVER_V7</h3><p>不推荐使用。请使用<a href="#ConsoleDebugger">ConsoleDebugger</a>。</p>
<h3 id="Block"><a href="#Block" class="headerlink" title="Block"></a>Block</h3><p>什么叫做block？简单来说就是未发生跳转的一整段汇编为一个block，如发生B系列指令跳转，就会进入下一block。<br /><br><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/01.png"
                      alt="01"
                ></p>
<h2 id="RegisterContext"><a href="#RegisterContext" class="headerlink" title="RegisterContext"></a>RegisterContext</h2><p>TODO</p>
<h2 id="SyscallHandler-1"><a href="#SyscallHandler-1" class="headerlink" title="SyscallHandler"></a>SyscallHandler</h2><h3 id="SyscallHandler介绍"><a href="#SyscallHandler介绍" class="headerlink" title="SyscallHandler介绍"></a>SyscallHandler介绍</h3><p>SyscallHandler模块为处理系统调用处理器的核心模块，模拟了在执行过程中所产生的大大小小的系统调用。虽然该模块为核心模块，但提供的API并不多，我们来看。</p>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><h4 id="获取SyscallHandler实例"><a href="#获取SyscallHandler实例" class="headerlink" title="获取SyscallHandler实例"></a>获取SyscallHandler实例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SyscallHandler&lt;AndroidFileIO&gt; syscallHandler = emulator.getSyscallHandler(); </span><br></pre></td></tr></table></figure>

<h4 id="setVerbose"><a href="#setVerbose" class="headerlink" title="setVerbose"></a>setVerbose</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">syscallHandler.setVerbose(<span class="literal">true</span>); </span><br></pre></td></tr></table></figure>
<p>部分系统调用日志开关。</p>
<h4 id="addIOResolver"><a href="#addIOResolver" class="headerlink" title="addIOResolver"></a>addIOResolver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">syscallHandler.addIOResolver(<span class="keyword">new</span> <span class="title class_">IOResolver</span>&lt;AndroidFileIO&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> FileResult&lt;AndroidFileIO&gt; <span class="title function_">resolve</span><span class="params">(Emulator&lt;AndroidFileIO&gt; emulator, String pathname, <span class="type">int</span> oflags)</span> &#123;</span><br><span class="line">        <span class="comment">//参数二: 文件路径</span></span><br><span class="line">        <span class="comment">//参数三: 操作文件标志</span></span><br><span class="line">        <span class="comment">//返回值: FileResult </span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>添加IO处理器。如果在模拟执行期间，有读写文件操作，可由自定义指定的IO处理器进行处理，且自定义IO处理器的优先级最高。关于返回值请查看<a href="#FileResult">FileResult</a>。</p>
<h4 id="setEnableThreadDispatcher"><a href="#setEnableThreadDispatcher" class="headerlink" title="setEnableThreadDispatcher"></a>setEnableThreadDispatcher</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">syscallHandler.setEnableThreadDispatcher(<span class="literal">true</span>); </span><br></pre></td></tr></table></figure>
<p>多线程自动调度开关。开启此开关，会以多线程模式运行，当有线程创建会自动进行处理调度。</p>
<h4 id="setFileListener"><a href="#setFileListener" class="headerlink" title="setFileListener"></a>setFileListener</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">syscallHandler.setFileListener(<span class="keyword">new</span> <span class="title class_">FileListener</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpenSuccess</span><span class="params">(Emulator&lt;?&gt; emulator, String pathname, FileIO io)</span> &#123;</span><br><span class="line">        System.out.println(pathname+<span class="string">&quot;文件打开成功！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">(Emulator&lt;?&gt; emulator, FileIO io)</span> &#123;</span><br><span class="line">        System.err.println(io.getPath()+<span class="string">&quot;文件打开失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>设置文件监听器。此API在在运行期间，可以监听所有成功打开和关闭的文件，打开失败的文件不会进行回调。</p>
<h4 id="getFileIO"><a href="#getFileIO" class="headerlink" title="getFileIO"></a>getFileIO</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FileIO</span> <span class="variable">fileIO</span> <span class="operator">=</span> syscallHandler.getFileIO(<span class="number">0</span>); </span><br></pre></td></tr></table></figure>
<p>根据fd查询对应的File。</p>
<h3 id="自处理系统调用"><a href="#自处理系统调用" class="headerlink" title="自处理系统调用"></a>自处理系统调用</h3><p>如果unidbg处理的系统调用不足以满足你的需求，可以自己参考unidbg的处理方式，定制SyscallHandler来处理。</p>
<h3 id="FileResult"><a href="#FileResult" class="headerlink" title="FileResult"></a>FileResult</h3><p>在自定义IO处理中，FileResult作为回调方法的返回值。其有3个静态方法，分别代表对文件的不同操作。</p>
<h4 id="success"><a href="#success" class="headerlink" title="success"></a>success</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FileResult.&lt;AndroidFileIO&gt;success(<span class="keyword">new</span> <span class="title class_">SimpleFileIO</span>(oflags, <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;filepath&quot;</span>),pathname));</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>success方法表示一个文件正常处理。参数是一个NewFileIO接口的实现，根据不同的场景返回不同。如上面例子，就是返回一个普通文件，就使用SimpleFileIO实现，如果是一个文件夹，就使用DirectoryFileIO实现，其他场景可自行查看接口的实现类。</p>
<h4 id="failed"><a href="#failed" class="headerlink" title="failed"></a>failed</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FileResult.failed(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<p>表示文件打开失败。参数是一个errno，会由上层处理将errno设置为该参数。</p>
<h4 id="fallback"><a href="#fallback" class="headerlink" title="fallback"></a>fallback</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FileResult.&lt;AndroidFileIO&gt;fallback(<span class="keyword">new</span> <span class="title class_">DirectoryFileIO</span>(oflags,pathname,<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;filepath&quot;</span>)));</span><br></pre></td></tr></table></figure>
<p>表示降低自己的优先级，在其他处理器无法找到该文件时，由fallback指定的文件IO来代替。</p>
<h2 id="VirtualModule"><a href="#VirtualModule" class="headerlink" title="VirtualModule"></a>VirtualModule</h2><h3 id="VirtualModulem介绍"><a href="#VirtualModulem介绍" class="headerlink" title="VirtualModulem介绍"></a>VirtualModulem介绍</h3><p>VirtualModule是unidbg提供的一种虚拟模块方案。它的用途是当一个So由于某种原因，无法完整加载进unidbg，或想自己实现该So的部分功能时，就可以使用虚拟模块来解决。</p>
<h3 id="unidbg自带虚拟模块"><a href="#unidbg自带虚拟模块" class="headerlink" title="unidbg自带虚拟模块"></a>unidbg自带虚拟模块</h3><p>unidbg中自带了两个虚拟模块:</p>
<ul>
<li>AndroidModule(libandroid.so)</li>
<li>JniGraphics(libjnigraphics.so)</li>
</ul>
<p>这两个模块中的部分常用符号已经在unidbg中有提供，当我们要模拟执行一个So时，而它又正好使用了libandroid.so，我们就可以这样做:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">AndroidModule</span>(emulator,vm).register(memory); </span><br></pre></td></tr></table></figure>
<p>然后再加载目标So。libjnigraphics.so同理。</p>
<h3 id="自定义虚拟模块"><a href="#自定义虚拟模块" class="headerlink" title="自定义虚拟模块"></a>自定义虚拟模块</h3><p>当然我们也可以自己实现一个虚拟模块。下面我们以一个例子来说明虚拟模块应该如何使用。</p>
<h4 id="模拟场景"><a href="#模拟场景" class="headerlink" title="模拟场景"></a>模拟场景</h4><p>我们先来模拟一个使用虚拟So的场景。先来看Java层的代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.github.unidbg;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;native-doc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">sign</span><span class="params">(<span class="type">int</span> a)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Java层加载了libnative-doc.so，有一个sign方法，参数跟返回值都为int类型。我们再来看So层的代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;jni.h&gt;</span><br><span class="line">#include <span class="string">&quot;myAdd.h&quot;</span></span><br><span class="line"></span><br><span class="line">extern <span class="string">&quot;C&quot;</span></span><br><span class="line">JNIEXPORT jint JNICALL</span><br><span class="line"><span class="title function_">Java_com_github_unidbg_Test_sign</span><span class="params">(JNIEnv *env, jobject thiz, jint a)</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> myAdd(a, <span class="number">1024</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>So的代码有sign方法的实现，而且实现非常简单，调用了myAdd函数。但是这个myAdd函数是来自其他的So的一个函数，而且这个So还由于某种原因不能被正常加载或没必要去加载，我们来看在unidbg中该如何去做。</p>
<h4 id="首次尝试"><a href="#首次尝试" class="headerlink" title="首次尝试"></a>首次尝试</h4><p>现在首先要做的是在unidbg中加载native-doc模块，看代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.github.unidbg.android;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.util.IOUtils;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Module;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.memory.Memory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DocTest</span> <span class="keyword">extends</span> <span class="title class_">AbstractJni</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">DocTest</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DocTest</span>();</span><br><span class="line">        test.sign();</span><br><span class="line">        test.destroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//清理资源</span></span><br><span class="line">        IOUtils.close(emulator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AndroidEmulator emulator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Module <span class="keyword">module</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VM vm;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">DocTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//创建模拟器实例</span></span><br><span class="line">        emulator = AndroidEmulatorBuilder</span><br><span class="line">                .for32Bit()</span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">//获取Memory接口</span></span><br><span class="line">        <span class="type">Memory</span> <span class="variable">memory</span> <span class="operator">=</span> emulator.getMemory();</span><br><span class="line">        memory.setLibraryResolver(<span class="keyword">new</span> <span class="title class_">AndroidResolver</span>(<span class="number">23</span>));</span><br><span class="line">        <span class="comment">//创建虚拟机</span></span><br><span class="line">        vm = emulator.createDalvikVM();</span><br><span class="line">        <span class="comment">//加载模块</span></span><br><span class="line">        <span class="keyword">module</span> = emulator.loadLibrary(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/java/com/github/unidbg/libnative-doc.so&quot;</span>), <span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//执行JNI_OnLoad函数</span></span><br><span class="line">        vm.callJNI_OnLoad(emulator, <span class="keyword">module</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sign</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//调用com/github/unidbg/Test类下的sign方法</span></span><br><span class="line">        <span class="type">DvmClass</span> <span class="variable">testClass</span> <span class="operator">=</span> vm.resolveClass(<span class="string">&quot;com/github/unidbg/Test&quot;</span>);</span><br><span class="line">        DvmObject&lt;?&gt; obj = testClass.newObject(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">ret</span> <span class="operator">=</span> obj.callJniMethodInt(emulator, <span class="string">&quot;sign(I)I&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;执行结果: &quot;</span> + ret);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们写完上面的代码，执行时会发现如下错误:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">libnative-doc.so load dependency libadd.so failed</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>unidbg会提示你libnative-doc.so需要一个libadd.so，而unidbg又找不到这个So来加载，所以就无法执行出正常的结果。这个libadd.so提供了myAdd函数的实现，但是它无法被正常加载，我们知道的是myAdd函数的实现是什么样子的。它就是将两个参数进行相加，然后返回结果。我们知道实现就好办了，下面通过虚拟So来解决这个问题。</p>
<h4 id="处理问题"><a href="#处理问题" class="headerlink" title="处理问题"></a>处理问题</h4><p>处理这种问题就分两步。第一步创建虚拟模块，来处理未找到的符号:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//继承VirtualModule类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Add</span> <span class="keyword">extends</span> <span class="title class_">VirtualModule</span>&lt;VM&gt;&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Add</span><span class="params">(Emulator&lt;?&gt; emulator, VM extra)</span>&#123;</span><br><span class="line">        <span class="comment">//参数三为我们无法加载的So模块名称全称</span></span><br><span class="line">        <span class="built_in">super</span>(emulator,extra,<span class="string">&quot;libadd.so&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onInitialize</span><span class="params">(Emulator&lt;?&gt; emulator, VM extra, Map&lt;String, UnidbgPointer&gt; symbols)</span> &#123;</span><br><span class="line">        <span class="type">SvcMemory</span> <span class="variable">svcMemory</span> <span class="operator">=</span> emulator.getSvcMemory();</span><br><span class="line">        <span class="comment">//添加一个myAdd符号</span></span><br><span class="line">        symbols.put(<span class="string">&quot;_Z5myAddii&quot;</span>,svcMemory.registerSvc(<span class="keyword">new</span> <span class="title class_">ArmSvc</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">handle</span><span class="params">(Emulator&lt;?&gt; emulator)</span> &#123;</span><br><span class="line">                <span class="type">RegisterContext</span> <span class="variable">context</span> <span class="operator">=</span> emulator.getContext();</span><br><span class="line">                <span class="type">int</span> <span class="variable">arg0</span> <span class="operator">=</span> context.getIntArg(<span class="number">0</span>);</span><br><span class="line">                <span class="type">int</span> <span class="variable">arg1</span> <span class="operator">=</span> context.getIntArg(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span> arg0 + arg1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二步，在加载我们目标So时，先来加载我们的虚拟So:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//加载虚拟模块</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Add</span>(emulator, vm).register(memory);</span><br></pre></td></tr></table></figure>
<p>这样就可以搞定啦。</p>
<h4 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.github.unidbg.android;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.util.IOUtils;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Module;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.arm.ArmSvc;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.arm.context.RegisterContext;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.memory.Memory;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.memory.SvcMemory;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.pointer.UnidbgPointer;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.virtualmodule.VirtualModule;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DocTest</span> <span class="keyword">extends</span> <span class="title class_">AbstractJni</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">DocTest</span> <span class="variable">test</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DocTest</span>();</span><br><span class="line">        test.sign();</span><br><span class="line">        test.destroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//清理资源</span></span><br><span class="line">        IOUtils.close(emulator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AndroidEmulator emulator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Module <span class="keyword">module</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VM vm;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">DocTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//创建模拟器实例</span></span><br><span class="line">        emulator = AndroidEmulatorBuilder</span><br><span class="line">                .for32Bit()</span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">//获取Memory接口</span></span><br><span class="line">        <span class="type">Memory</span> <span class="variable">memory</span> <span class="operator">=</span> emulator.getMemory();</span><br><span class="line">        memory.setLibraryResolver(<span class="keyword">new</span> <span class="title class_">AndroidResolver</span>(<span class="number">23</span>));</span><br><span class="line">        <span class="comment">//创建虚拟机</span></span><br><span class="line">        vm = emulator.createDalvikVM();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载虚拟模块</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Add</span>(emulator, vm).register(memory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载模块</span></span><br><span class="line">        <span class="keyword">module</span> = emulator.loadLibrary(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;unidbg-android/src/test/java/com/github/unidbg/libnative-doc.so&quot;</span>), <span class="literal">true</span>);</span><br><span class="line">        <span class="comment">//执行JNI_OnLoad函数</span></span><br><span class="line">        vm.callJNI_OnLoad(emulator, <span class="keyword">module</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sign</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//调用com/github/unidbg/Test类下的sign方法</span></span><br><span class="line">        <span class="type">DvmClass</span> <span class="variable">testClass</span> <span class="operator">=</span> vm.resolveClass(<span class="string">&quot;com/github/unidbg/Test&quot;</span>);</span><br><span class="line">        DvmObject&lt;?&gt; obj = testClass.newObject(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">ret</span> <span class="operator">=</span> obj.callJniMethodInt(emulator, <span class="string">&quot;sign(I)I&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;执行结果: &quot;</span> + ret);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Add</span> <span class="keyword">extends</span> <span class="title class_">VirtualModule</span>&lt;VM&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Add</span><span class="params">(Emulator&lt;?&gt; emulator, VM extra)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(emulator, extra, <span class="string">&quot;libadd.so&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onInitialize</span><span class="params">(Emulator&lt;?&gt; emulator, VM extra, Map&lt;String, UnidbgPointer&gt; symbols)</span> &#123;</span><br><span class="line">            <span class="type">SvcMemory</span> <span class="variable">svcMemory</span> <span class="operator">=</span> emulator.getSvcMemory();</span><br><span class="line">            <span class="comment">//添加一个myAdd符号</span></span><br><span class="line">            symbols.put(<span class="string">&quot;_Z5myAddii&quot;</span>, svcMemory.registerSvc(<span class="keyword">new</span> <span class="title class_">ArmSvc</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">handle</span><span class="params">(Emulator&lt;?&gt; emulator)</span> &#123;</span><br><span class="line">                    <span class="type">RegisterContext</span> <span class="variable">context</span> <span class="operator">=</span> emulator.getContext();</span><br><span class="line">                    <span class="type">int</span> <span class="variable">arg0</span> <span class="operator">=</span> context.getIntArg(<span class="number">0</span>);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">arg1</span> <span class="operator">=</span> context.getIntArg(<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">return</span> arg0 + arg1;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Jnitrace"><a href="#Jnitrace" class="headerlink" title="Jnitrace"></a>Jnitrace</h2><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jnitrace -l so文件 包名 &gt; xxx.txt</span><br></pre></td></tr></table></figure>

<h3 id="jnitrace函数调用返回的是地址的时候"><a href="#jnitrace函数调用返回的是地址的时候" class="headerlink" title="jnitrace函数调用返回的是地址的时候"></a>jnitrace函数调用返回的是地址的时候</h3><p><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/02.png"
                      alt="02"
                ><br /> SO运行存在多线程的问题，多线程会给Trace分析带来干扰，我们在文本中查找TID 11372，跟着这个线 程走下去  <br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/03.png"
                      alt="03"
                ><br /> 此处在获取0x49即我们的字符串的长度，继续往下  <br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/04.png"
                      alt="04"
                ><br /> 此处将jstring转成Native 字符串，在JNI开发中，大部分JObject都属于局部引用，局部引用在用完之后需要手动释放  <br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/05.png"
                      alt="image.png"
                ><br /> 比如GetStringUTFChars获取的资源，最后一定要ReleaseStringUTFChars，JNItrace会在Releasexxx这 系列API中，打印内容  <br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/06.png"
                      alt="image.png"
                ><br /> <font color="red">但是需要注意的是，引用的释放方式有两种，除了Releasexx系列，也可以用DeleteLocalRef释放局部引 用，如果通过DeleteLocalRef释放，JNItrace并不会打印出具体值</font>  </p>
<h3 id="堆栈检测"><a href="#堆栈检测" class="headerlink" title="堆栈检测"></a>堆栈检测</h3><p>“java&#x2F;lang&#x2F;Throwable-&gt;<init>()V”<br /> new一个异常之后<br />“java&#x2F;lang&#x2F;Throwable-&gt;getStackTrace()[Ljava&#x2F;lang&#x2F;StackTraceElement;”<br />查看堆栈，这不就是堆栈检测吗，如果被Xposed Hook了，堆栈里会有Xposed这一 层。  <br /> new 异常之后，getStackTrace即得到异常堆栈数组，写代码验证一下<br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/07.png"
                      alt="image.png"
                >继续看JNItrace <br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/08.png"
                      alt="image.png"
                ><br />首先获取数据长度，这很好理解嘛，后面肯定是想循环遍历取出完整的调用栈，得知道调用栈有多长 <br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/09.png"
                      alt="image.png"
                ><br />获取数组第0个元素<br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/10.png"
                      alt="image.png"
                ><br /> getClassName，即获取具体的类名 <br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/11.png"
                      alt="image.png"
                ><br />因为是在JNI中处理，所以后面还得getString <br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/12.png"
                      alt="image.png"
                ><br />用完之后Release释放这个字符串资源，防止内存泄漏<br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/13.png"
                      alt="image.png"
                ><br /> com.xunmeng.pinduoduo.secure.DeviceNative即调用栈的第一层 <br />然后它对数组的第二个元素做同样的操作，一套流程总结下来，就是构造异常后读取调用栈嘛</p>
<h4 id="推荐使用objection查看堆栈"><a href="#推荐使用objection查看堆栈" class="headerlink" title="推荐使用objection查看堆栈"></a>推荐使用objection查看堆栈</h4><p><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/14.png"
                      alt="image.png"
                ></p>
<h2 id="函数调用两种方式"><a href="#函数调用两种方式" class="headerlink" title="函数调用两种方式"></a>函数调用两种方式</h2><p>Unidbg call 参数传递，到底是自己call 地址 还是用Unidbg封装的API？<br />各有优劣，用API的话代码量小一些，自己call的话更灵活，限制小。熟能生巧。</p>
<h3 id="符号调用"><a href="#符号调用" class="headerlink" title="符号调用"></a>符号调用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DvmObject</span> <span class="variable">obj</span> <span class="operator">=</span> ProxyDvmObject.createObject(vm,<span class="built_in">this</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> <span class="string">&quot;dta&quot;</span>;</span><br><span class="line"><span class="type">DvmObject</span> <span class="variable">dvmObject</span> <span class="operator">=</span> obj.callJniMethodObject(emulator, <span class="string">&quot;md5(Ljava/lang/String;)Ljava/lang/String;&quot;</span>, data);</span><br><span class="line"><span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> (String) dvmObject.getValue();</span><br><span class="line">System.out.println(<span class="string">&quot;[symble] Call the so md5 function result is ==&gt; &quot;</span>+ result);</span><br></pre></td></tr></table></figure>

<h3 id="地址调用"><a href="#地址调用" class="headerlink" title="地址调用"></a>地址调用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Pointer</span> <span class="variable">jniEnv</span> <span class="operator">=</span> vm.getJNIEnv();</span><br><span class="line"><span class="type">DvmObject</span> <span class="variable">obj</span> <span class="operator">=</span> ProxyDvmObject.createObject(vm,<span class="built_in">this</span>);</span><br><span class="line"><span class="type">StringObject</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringObject</span>(vm,<span class="string">&quot;dta&quot;</span>);</span><br><span class="line"></span><br><span class="line">List&lt;Object&gt; args = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">args.add(jniEnv);</span><br><span class="line">args.add(vm.addLocalObject(obj));</span><br><span class="line">args.add(vm.addLocalObject(data));</span><br><span class="line"></span><br><span class="line">Number[] numbers = <span class="keyword">module</span>.callFunction(emulator, <span class="number">0x8E81</span>, args.toArray());</span><br><span class="line">DvmObject&lt;?&gt; object = vm.getObject(numbers[<span class="number">0</span>].intValue());</span><br><span class="line"><span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> (String) object.getValue();</span><br><span class="line">System.out.println(<span class="string">&quot;[addr] Call the so md5 function result is ==&gt; &quot;</span>+ value);</span><br></pre></td></tr></table></figure>

<h2 id="构建类的两种方式"><a href="#构建类的两种方式" class="headerlink" title="构建类的两种方式"></a>构建类的两种方式</h2><p>以当前包类为类名</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DvmObject</span> <span class="variable">obj</span> <span class="operator">=</span> ProxyDvmObject.createObject(vm,<span class="built_in">this</span>);</span><br></pre></td></tr></table></figure>
<p>自定义包名类名</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DvmObject&lt;?&gt; context = vm.resolveClass(<span class="string">&quot;android/content/Context&quot;</span>).newObject(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<h2 id="类继承的写法"><a href="#类继承的写法" class="headerlink" title="类继承的写法"></a>类继承的写法</h2><p><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/15.png"
                      alt="image.png"
                ><br />链式继承<br />vm.resolveClass(“子类”, vm.resolveClass(“父类”, vm.resolveClass(“父类的父类”))).newObject(signature);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&quot;android/app/ActivityThread-&gt;getApplication()Landroid/app/Application;&quot;</span>: &#123;</span><br><span class="line">    <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;android/app/Application&quot;</span>, vm.resolveClass(<span class="string">&quot;android/content/ContextWrapper&quot;</span>, vm.resolveClass(<span class="string">&quot;android/content/Context&quot;</span>))).newObject(signature);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>多行的写法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DvmClass</span> <span class="variable">context</span> <span class="operator">=</span> vm.resolveClass(<span class="string">&quot;android/content/Context&quot;</span>);</span><br><span class="line"><span class="type">DvmClass</span> <span class="variable">ContextWrapper</span> <span class="operator">=</span> vm.resolveClass(<span class="string">&quot;android/content/ContextWrapper&quot;</span>,context);</span><br><span class="line"><span class="type">DvmClass</span> <span class="variable">Application</span> <span class="operator">=</span> vm.resolveClass(<span class="string">&quot;android/app/Application&quot;</span>,ContextWrapper);</span><br><span class="line"><span class="keyword">return</span> Application.newObject(signature);</span><br></pre></td></tr></table></figure>

<h2 id="unidbg补获取系统属性"><a href="#unidbg补获取系统属性" class="headerlink" title="unidbg补获取系统属性"></a>unidbg补获取系统属性</h2><p><a href="https://www.zskkk.cn/2022/12/22/unidbg%E8%A1%A5%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E5%B1%9E%E6%80%A7/">unidbg补获取系统属性</a><br />可以使用unidbg封装好的hook方法知道系统调用了哪些系统属性，__system_property_get</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SystemPropertyHook</span> <span class="variable">systemPropertyHook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SystemPropertyHook</span>(emulator);</span><br><span class="line">systemPropertyHook.setPropertyProvider(<span class="keyword">new</span> <span class="title class_">SystemPropertyProvider</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getProperty</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;lilac Systemkey:&quot;</span>+key);</span><br><span class="line">        <span class="keyword">switch</span> (key)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br><span class="line">memory.addHookListener(systemPropertyHook);</span><br></pre></td></tr></table></figure>

<h2 id="文件重定向，实现-IOResolver"><a href="#文件重定向，实现-IOResolver" class="headerlink" title="文件重定向，实现 IOResolver"></a>文件重定向，实现 IOResolver</h2><p>需要继承 IOResolver 重写 resolve方法<br />在定义emulator好后，在so加载前添加文件重定位器<br />emulator.getSyscallHandler().addIOResolver(this);<br />指定路径文件定向（单文件）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(pathname.<span class="built_in">equals</span>(<span class="string">&quot;/data/user/0/com.example.fileinunidbg/files/key.txt&quot;</span>))&#123;</span><br><span class="line">    <span class="keyword">return</span> FileResult.<span class="built_in">success</span>(<span class="keyword">new</span> <span class="built_in">SimpleFileIO</span>(oflags, <span class="keyword">new</span> <span class="built_in">File</span>(<span class="string">&quot;unidbg-android/src/test/resources/FileDemo/key.txt&quot;</span>), pathname));</span><br><span class="line"><span class="comment">//            return FileResult.success(new ByteArrayFileIO(oflags, pathname, String.valueOf(System.currentTimeMillis()).getBytes(StandardCharsets.UTF_8)));</span></span><br><span class="line"><span class="comment">//            return null;</span></span><br><span class="line"><span class="comment">//            return FileResult.failed(13);</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 返回对应的文件夹（目录文件）</span></span><br><span class="line"><span class="keyword">if</span>(pathname.<span class="built_in">equals</span>(<span class="string">&quot;/data/user/0/com.example.fileinunidbg/files/demo2&quot;</span>))&#123;</span><br><span class="line">    <span class="keyword">return</span> FileResult.<span class="built_in">success</span>(<span class="keyword">new</span> <span class="built_in">DirectoryFileIO</span>(oflags, pathname,</span><br><span class="line">            <span class="keyword">new</span> DirectoryFileIO.<span class="built_in">DirectoryEntry</span>(<span class="literal">true</span>, String.<span class="built_in">valueOf</span>(System.<span class="built_in">currentTimeMillis</span>())), <span class="keyword">new</span> DirectoryFileIO.<span class="built_in">DirectoryEntry</span>(<span class="literal">true</span>, <span class="string">&quot;1234&quot;</span>)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(pathname.<span class="built_in">equals</span>(<span class="string">&quot;/data/user/0/com.example.fileinunidbg/files/demo2/1.txt&quot;</span>))&#123;</span><br><span class="line">    <span class="keyword">return</span> FileResult.<span class="built_in">success</span>(<span class="keyword">new</span> <span class="built_in">SimpleFileIO</span>(oflags, <span class="keyword">new</span> <span class="built_in">File</span>(<span class="string">&quot;unidbg-android/src/test/resources/FileDemo/demo2/1.txt&quot;</span>), pathname));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(pathname.<span class="built_in">equals</span>(<span class="string">&quot;/data/user/0/com.example.fileinunidbg/files/demo2/2.txt&quot;</span>))&#123;</span><br><span class="line">    <span class="keyword">return</span> FileResult.<span class="built_in">success</span>(<span class="keyword">new</span> <span class="built_in">SimpleFileIO</span>(oflags, <span class="keyword">new</span> <span class="built_in">File</span>(<span class="string">&quot;unidbg-android/src/test/resources/FileDemo/demo2/2.txt&quot;</span>), pathname));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(pathname.<span class="built_in">equals</span>(<span class="string">&quot;/data/user/0/com.example.fileinunidbg/files/demo2/3.txt&quot;</span>))&#123;</span><br><span class="line">    <span class="keyword">return</span> FileResult.<span class="built_in">success</span>(<span class="keyword">new</span> <span class="built_in">SimpleFileIO</span>(oflags, <span class="keyword">new</span> <span class="built_in">File</span>(<span class="string">&quot;unidbg-android/src/test/resources/FileDemo/demo2/3.txt&quot;</span>), pathname));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((<span class="string">&quot;proc/&quot;</span> + emulator.<span class="built_in">getPid</span>() + <span class="string">&quot;/status&quot;</span>).<span class="built_in">equals</span>(pathname)) &#123;</span><br><span class="line"><span class="keyword">return</span> FileResult.<span class="built_in">success</span>(<span class="keyword">new</span> <span class="built_in">ByteArrayFileIO</span>(oflags, pathname, (<span class="string">&quot;文本内容.....&quot;</span>).<span class="built_in">getBytes</span>())&#125;</span><br></pre></td></tr></table></figure>
<p>或者是虚拟目录（对比文件夹里的文件比较多的情况下比较好）<br />在创建emulator的时候直接指定目录</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">emulator = AndroidEmulatorBuilder.for32Bit().<span class="built_in">setRootDir</span>(<span class="keyword">new</span> <span class="built_in">File</span>(<span class="string">&quot;unidbg-android/src/test/resources/FileDemo/VFS&quot;</span>)).<span class="built_in">build</span>();</span><br></pre></td></tr></table></figure>

<p>补了虚拟目录和代码，哪边会生效？<br />代码执行会先看有没有重写文件重定位器，没有就默认重定位器，两个都没有找到就到虚拟目录系统找，</p>
<h2 id="一些常用功能"><a href="#一些常用功能" class="headerlink" title="一些常用功能"></a>一些常用功能</h2><h3 id="打印内存，hexdump"><a href="#打印内存，hexdump" class="headerlink" title="打印内存，hexdump"></a>打印内存，hexdump</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Inspector.inspect(ctx.getR0Pointer().getByteArray(<span class="number">0</span>, <span class="number">0x10</span>), <span class="string">&quot;Arg1&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="unidbg下断点"><a href="#unidbg下断点" class="headerlink" title="unidbg下断点"></a>unidbg下断点</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">普通断点</span><br><span class="line">emulator.attach().addBreakPoint(<span class="keyword">module</span>.base + <span class="number">0x3161E</span>);</span><br><span class="line"></span><br><span class="line">内存写入断点</span><br><span class="line">emulator.traceWrite(<span class="keyword">module</span>.base + <span class="number">0x3A0C0</span>,<span class="keyword">module</span>.base + <span class="number">0x3A0C0</span>);</span><br></pre></td></tr></table></figure>

<h3 id="开启所有的日志"><a href="#开启所有的日志" class="headerlink" title="开启所有的日志"></a>开启所有的日志</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Logger.getLogger(<span class="string">&quot;com.github.unidbg.linux.ARM32SyscallHandler&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">Logger.getLogger(<span class="string">&quot;com.github.unidbg.unix.UnixSyscallHandler&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">Logger.getLogger(<span class="string">&quot;com.github.unidbg.AbstractEmulator&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">Logger.getLogger(<span class="string">&quot;com.github.unidbg.linux.android.dvm.DalvikVM&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">Logger.getLogger(<span class="string">&quot;com.github.unidbg.linux.android.dvm.BaseVM&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">Logger.getLogger(<span class="string">&quot;com.github.unidbg.linux.android.dvm&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line"></span><br><span class="line">所需要的头文件</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Level;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br></pre></td></tr></table></figure>

<h3 id="计算汇编的行数"><a href="#计算汇编的行数" class="headerlink" title="计算汇编的行数"></a>计算汇编的行数</h3><p>计算某个函数的汇编行数前使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">traceLength</span><span class="params">()</span>&#123;</span><br><span class="line">    emulator.getBackend().hook_add_new(<span class="keyword">new</span> <span class="title class_">CodeHook</span>() &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hook</span><span class="params">(Backend backend, <span class="type">long</span> address, <span class="type">int</span> size, Object user)</span> &#123;</span><br><span class="line">            count += <span class="number">1</span>;</span><br><span class="line">            System.out.println(count);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAttach</span><span class="params">(UnHook unHook)</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">detach</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="keyword">module</span>.base, <span class="keyword">module</span>.base + <span class="keyword">module</span>.size, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="打印函数返回值或修改返回值"><a href="#打印函数返回值或修改返回值" class="headerlink" title="打印函数返回值或修改返回值"></a>打印函数返回值或修改返回值</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hookRandom</span><span class="params">()</span>&#123;</span><br><span class="line">       emulator.attach().addBreakPoint(<span class="keyword">module</span>.findSymbolByName(<span class="string">&quot;lrand48&quot;</span>, <span class="literal">true</span>).getAddress(), <span class="keyword">new</span> <span class="title class_">BreakPointCallback</span>() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">long</span> address)</span> &#123;</span><br><span class="line">               System.out.println(<span class="string">&quot;call lrand48&quot;</span>);</span><br><span class="line">               <span class="comment">// 打印调用栈</span></span><br><span class="line">               emulator.getUnwinder().unwind();</span><br><span class="line">               <span class="comment">// 打印返回值或修改返回值</span></span><br><span class="line">               emulator.attach().addBreakPoint(emulator.getContext().getLRPointer().peer, <span class="keyword">new</span> <span class="title class_">BreakPointCallback</span>() &#123;</span><br><span class="line">                   <span class="meta">@Override</span></span><br><span class="line">                   <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">long</span> address)</span> &#123;</span><br><span class="line">                       <span class="comment">//emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_R0, 0x12345678);</span></span><br><span class="line">                       <span class="type">Number</span> <span class="variable">number</span> <span class="operator">=</span> emulator.getBackend().reg_read(ArmConst.UC_ARM_REG_R0);</span><br><span class="line">                       System.out.println(<span class="string">&quot;number &quot;</span> + number.intValue());</span><br><span class="line">                       <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;);</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h3 id="随机数函数返回值固定"><a href="#随机数函数返回值固定" class="headerlink" title="随机数函数返回值固定"></a>随机数函数返回值固定</h3><p>程序中最常见的随机变量是时间戳和随机数，绝大多数情况下，程序会使用 arc4random 这样的库函数获取随机数，其底层依赖于 <code>/dev/urandom</code>、<code>/dev/random</code> 等随机文件，或者直接访问这些文件，获取随机数。<br>在 Unidbg 里，这几个伪设备文件的模拟位置在 <code>src/main/java/com/github/unidbg/linux/file/DriverFileIO.java</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> DriverFileIO <span class="title function_">create</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">int</span> oflags, String pathname)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;/dev/urandom&quot;</span>.equals(pathname) || <span class="string">&quot;/dev/random&quot;</span>.equals(pathname) || <span class="string">&quot;/dev/srandom&quot;</span>.equals(pathname)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RandomFileIO</span>(emulator, pathname);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;/dev/alarm&quot;</span>.equals(pathname) || <span class="string">&quot;/dev/null&quot;</span>.equals(pathname)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DriverFileIO</span>(emulator, oflags, pathname);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;/dev/ashmem&quot;</span>.equals(pathname)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Ashmem</span>(emulator, oflags, pathname);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;/dev/zero&quot;</span>.equals(pathname)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ZeroFileIO</span>(emulator, oflags, pathname);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到 RandomFileIO 类里，把 randBytes 函数里的 ThreadLocalRandom.current().nextBytes(bytes); 注释掉</p>
<h3 id="获取-Trace"><a href="#获取-Trace" class="headerlink" title="获取 Trace"></a>获取 Trace</h3><p>使用方式看 <a href="#Trace">Trace</a>，下面是保存到文件<br>如果不希望 trace 只是打印在日志里，而是要重定位到文件里，所以要多几行代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">traceFile</span> <span class="operator">=</span> <span class="string">&quot;unidbg-android/src/test/resources/trace/tracecode.txt&quot;</span>;</span><br><span class="line">PrintStream traceStream;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    traceStream = <span class="keyword">new</span> <span class="title class_">PrintStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(traceFile), <span class="literal">true</span>);</span><br><span class="line">    emulator.traceCode(<span class="keyword">module</span>.base,<span class="keyword">module</span>.base+<span class="keyword">module</span>.size).setRedirect(traceStream);</span><br><span class="line">&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>大概80w行耗时3分钟左右，是否可以优化和加速 Unidbg trace 的速度。<br>指令追踪的耗时有两部分，1 是为了实现指令追踪的能力，所做的指令膨胀和插桩。2 是在展示上的耗时。前一部分的损耗我们很难控制，而后一部分展示上的耗时，可做很多优化。<br>在展示上，trace 需要包括三要素。<br>● 地址<br>● 汇编代码<br>● 寄存器、内存的值变化展示<br>耗时主要在要素二，反汇编机器码获取汇编代码上。在 Unidbg 的处理逻辑里，运行每一条指令都会对它重新做反汇编。但我们都知道，如果地址和机器码都不变化（即没有发生代码自修改的情况里），使用先前对这个地址缓存下来的反汇编即可。<br>接下来让我们对 Unidbg 的源码做一点修改，下面只处理 ARM64。<br>找到<code>unidbg-api/src/main/java/com/github/unidbg/arm/AbstractARM64Emulator.java</code>，在类中添加一个 HashMap 用于存储反汇编结果，我们将使用它来缓存反汇编。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Long, Instruction[]&gt; disassembleCache = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>
<p>printAssemble 函数的代码原先如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Instruction[] printAssemble(PrintStream out, <span class="type">long</span> address, <span class="type">int</span> size, <span class="type">int</span> maxLengthLibraryName, InstructionVisitor visitor) &#123;</span><br><span class="line">    Instruction[] insns = disassemble(address, size, <span class="number">0</span>);</span><br><span class="line">    printAssemble(out, insns, address, ARM.isThumb(backend), maxLengthLibraryName, visitor);</span><br><span class="line">    <span class="keyword">return</span> insns;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改它，当调用 printAssemble 函数时，首先检查缓存中是否已有相应的反汇编结果，如果有则直接使用，否则进行反汇编并将结果存入缓存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Instruction[] printAssemble(PrintStream out, <span class="type">long</span> address, <span class="type">int</span> size, <span class="type">int</span> maxLengthLibraryName, InstructionVisitor visitor) &#123;</span><br><span class="line">    Instruction[] insns = disassembleCache.get(address);</span><br><span class="line">    <span class="keyword">if</span> (insns == <span class="literal">null</span>) &#123;</span><br><span class="line">        insns = disassemble(address, size, <span class="number">0</span>);</span><br><span class="line">        disassembleCache.put(address, insns);</span><br><span class="line">    &#125;</span><br><span class="line">    printAssemble(out, insns, address, maxLengthLibraryName, visitor);</span><br><span class="line">    <span class="keyword">return</span> insns;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新测试 trace，这次重定向到 tracecode2.txt。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">traceFile</span> <span class="operator">=</span> <span class="string">&quot;unidbg-android/src/test/resources/trace/tracecode2.txt&quot;</span>;</span><br><span class="line">PrintStream traceStream;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    traceStream = <span class="keyword">new</span> <span class="title class_">PrintStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(traceFile), <span class="literal">true</span>);</span><br><span class="line">    emulator.traceCode(<span class="keyword">module</span>.base,<span class="keyword">module</span>.base+<span class="keyword">module</span>.size).setRedirect(traceStream);</span><br><span class="line">&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在耗时上，仅花费半分钟不到，可以说是速度大大提升，这么算的话，即使 trace 指令流的行数以亿计，也能在短短几个小时内 trace 完。<br>接下来继续修改 printAssemble 函数的代码，上面的代码没有考虑到代码自修改的情况，自修改即程序在运行期间修改自身指令，不管是出于解密、反调，还是其它目的，自修改都是一件常事。所以我们还要判断一下字节是否发生了改变。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Instruction[] printAssemble(PrintStream out, <span class="type">long</span> address, <span class="type">int</span> size, <span class="type">int</span> maxLengthLibraryName, InstructionVisitor visitor) &#123;</span><br><span class="line">    Instruction[] insns = disassembleCache.get(address);</span><br><span class="line">    <span class="type">byte</span>[] currentCode = backend.mem_read(address, size);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">needUpdateCache</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (insns != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">byte</span>[] cachedCode = <span class="keyword">new</span> <span class="title class_">byte</span>[size];</span><br><span class="line">        <span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Instruction insn : insns) &#123;</span><br><span class="line">            <span class="type">byte</span>[] insnBytes = insn.getBytes();</span><br><span class="line">            System.arraycopy(insnBytes, <span class="number">0</span>, cachedCode, offset, insnBytes.length);</span><br><span class="line">            offset += insnBytes.length;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!Arrays.equals(currentCode, cachedCode)) &#123;</span><br><span class="line">            needUpdateCache = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        needUpdateCache = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (needUpdateCache) &#123;</span><br><span class="line">        insns = disassemble(address, currentCode, <span class="literal">false</span>, <span class="number">0</span>);</span><br><span class="line">        disassembleCache.put(address, insns);</span><br><span class="line">    &#125;</span><br><span class="line">    printAssemble(out, insns, address, maxLengthLibraryName, visitor);</span><br><span class="line">    <span class="keyword">return</span> insns;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新代码会判断当前地址的机器码是否和缓存的这个地址上的机器码一致，这增加了一点开销，运行完毕后比较一下，也就慢了几秒钟，完全能承受。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">traceFile</span> <span class="operator">=</span> <span class="string">&quot;unidbg-android/src/test/resources/trace/tracecode3.txt&quot;</span>;</span><br><span class="line">PrintStream traceStream;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    traceStream = <span class="keyword">new</span> <span class="title class_">PrintStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(traceFile), <span class="literal">true</span>);</span><br><span class="line">    emulator.traceCode(<span class="keyword">module</span>.base,<span class="keyword">module</span>.base+<span class="keyword">module</span>.size).setRedirect(traceStream);</span><br><span class="line">&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="获取函数调用流"><a href="#获取函数调用流" class="headerlink" title="获取函数调用流"></a>获取函数调用流</h3><p>基于对指令流中<code>BL</code>、<code>BLR</code>等函数调用指令的监控，Unidbg 实现了对函数的监控和追踪，我们稍作处理，将它重定向到文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">traceFile</span> <span class="operator">=</span> <span class="string">&quot;unidbg-android/src/test/resources/trace/tracefunction.txt&quot;</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> PrintStream traceStream;</span><br><span class="line">    traceStream = <span class="keyword">new</span> <span class="title class_">PrintStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(traceFile), <span class="literal">true</span>);</span><br><span class="line">    emulator.attach().traceFunctionCall(<span class="keyword">module</span>, <span class="keyword">new</span> <span class="title class_">FunctionCallListener</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCall</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">long</span> callerAddress, <span class="type">long</span> functionAddress)</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postCall</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">long</span> callerAddress, <span class="type">long</span> functionAddress, Number[] args)</span> &#123;</span><br><span class="line">            traceStream.println(<span class="string">&quot;onCallFinish caller=&quot;</span> + UnidbgPointer.pointer(emulator, callerAddress) + <span class="string">&quot;, function=&quot;</span> + UnidbgPointer.pointer(emulator, functionAddress));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码置于 JNI_OnLoad 后。</p>
<h3 id="在内存中搜索数据出现的位置"><a href="#在内存中搜索数据出现的位置" class="headerlink" title="在内存中搜索数据出现的位置"></a>在内存中搜索数据出现的位置</h3><p>假如目标数据是EC 03 CE 8A 99 16 7F 9A 8F 2D F5 CD 8E E1 47 F2。<br>● 这串数据在第 25w 行左右的地址生成，地址是 A<br>● 在 36w 行的位置由 A 赋值给 B，即 A –&gt; B<br>● 在 47w 行的位置 B –&gt; C<br>● 在 55w 行的位置 C –&gt; D<br>● 在 82w 行的位置 D –&gt; E<br>● 在 97w 行的位置 E–&gt; F<br>在逆向追溯时，从 F 开始做 traceWrite，经过四五次跳转，最终才能找到 A，非常的麻烦。<br>在这个 Android Native Runtime 里，只需要处理单个 SO 里的单个函数，因此它所使用和操纵的内存区块很有效，只有几 MB 大小。因此我们可以从函数起始点开始，高频率的搜索内存里是否出现了某个值，从而确定某个数据最早出现的位置，下面是基本的实现代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.github.unidbg.Emulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.arm.backend.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.pointer.UnidbgPointer;</span><br><span class="line"><span class="keyword">import</span> com.sun.jna.Pointer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSearch</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Emulator&lt;?&gt; emulator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TreeSet&lt;Long&gt; addressUsed = <span class="keyword">new</span> <span class="title class_">TreeSet</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Long, Byte&gt; memoryData = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">byte</span>[] data;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">find</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> interval;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;<span class="type">long</span>[]&gt; activePlace = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DataSearch</span><span class="params">(Emulator&lt;?&gt; emulator, String data)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.emulator = emulator;</span><br><span class="line">        <span class="built_in">this</span>.data = hexStringToByteArray(data);</span><br><span class="line">        <span class="built_in">this</span>.interval = <span class="number">100</span>;</span><br><span class="line">        hookReadAndWrite();</span><br><span class="line">        hookBlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DataSearch</span><span class="params">(Emulator&lt;?&gt; emulator, String data, <span class="type">int</span> interval)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.emulator = emulator;</span><br><span class="line">        <span class="built_in">this</span>.data = hexStringToByteArray(data);</span><br><span class="line">        <span class="built_in">this</span>.interval = interval;</span><br><span class="line">        hookReadAndWrite();</span><br><span class="line">        hookBlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] hexStringToByteArray(String s) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> s.length();</span><br><span class="line">        <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[len / <span class="number">2</span>];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i += <span class="number">2</span>) &#123;</span><br><span class="line">            data[i / <span class="number">2</span>] = (<span class="type">byte</span>) ((Character.digit(s.charAt(i), <span class="number">16</span>) &lt;&lt; <span class="number">4</span>)</span><br><span class="line">                    + Character.digit(s.charAt(i + <span class="number">1</span>), <span class="number">16</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">hookReadAndWrite</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">WriteHook</span> <span class="variable">writeHook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WriteHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAttach</span><span class="params">(UnHook unHook)</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">detach</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hook</span><span class="params">(Backend backend, <span class="type">long</span> address, <span class="type">int</span> size, <span class="type">long</span> value, Object user)</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> <span class="number">0</span>; offset &lt; size; offset++) &#123;</span><br><span class="line">                    memoryData.put(address + offset, (<span class="type">byte</span>) (value &gt;&gt;&gt; (offset * <span class="number">8</span>)));</span><br><span class="line">                &#125;</span><br><span class="line">                updateActivePlace(address, size);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ReadHook</span> <span class="variable">readHook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReadHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAttach</span><span class="params">(UnHook unHook)</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">detach</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hook</span><span class="params">(Backend backend, <span class="type">long</span> address, <span class="type">int</span> size, Object user)</span> &#123;</span><br><span class="line">                <span class="type">byte</span>[] readBytes = emulator.getBackend().mem_read(address, size);</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> <span class="number">0</span>; offset &lt; size; offset++) &#123;</span><br><span class="line">                    memoryData.put(address + offset, readBytes[offset]);</span><br><span class="line">                &#125;</span><br><span class="line">                updateActivePlace(address, size);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        emulator.getBackend().hook_add_new(writeHook, <span class="number">1</span>, <span class="number">0</span>, <span class="literal">null</span>);</span><br><span class="line">        emulator.getBackend().hook_add_new(readHook, <span class="number">1</span>, <span class="number">0</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">hookBlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">BlockHook</span> <span class="variable">blockHook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BlockHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAttach</span><span class="params">(UnHook unHook)</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">detach</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hookBlock</span><span class="params">(Backend backend, <span class="type">long</span> address, <span class="type">int</span> size, Object user)</span> &#123;</span><br><span class="line">                count++;</span><br><span class="line">                <span class="keyword">if</span> (!find &amp;&amp; (count % interval == <span class="number">0</span>)) &#123;</span><br><span class="line">                    searchData();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        emulator.getBackend().hook_add_new(blockHook, <span class="number">1</span>, <span class="number">0</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">searchData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!find) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">long</span>[] range : activePlace) &#123;</span><br><span class="line">                <span class="keyword">if</span> (searchDataInRange(range)) &#123;</span><br><span class="line">                    find = <span class="literal">true</span>;</span><br><span class="line">                    printAddress(range);</span><br><span class="line">                    emulator.attach().debug();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">searchDataInRange</span><span class="params">(<span class="type">long</span>[] range)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">long</span> <span class="variable">i</span> <span class="operator">=</span> range[<span class="number">0</span>], max = range[<span class="number">1</span>] - data.length; i &lt;= max; i++) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">found</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; data.length; j++) &#123;</span><br><span class="line">                <span class="type">Byte</span> <span class="variable">value</span> <span class="operator">=</span> memoryData.get(i + j);</span><br><span class="line">                <span class="keyword">if</span> (value == <span class="literal">null</span> || value != data[j]) &#123;</span><br><span class="line">                    found = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (found) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">printAddress</span><span class="params">(<span class="type">long</span>[] range)</span> &#123;</span><br><span class="line">        Collection&lt;Pointer&gt; pointers = searchMemory(range[<span class="number">0</span>], range[<span class="number">1</span>], data);</span><br><span class="line">        System.out.println(<span class="string">&quot;Search data matches &quot;</span> + pointers.size() + <span class="string">&quot; count&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Pointer pointer : pointers) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;data address: &quot;</span> + pointer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Collection&lt;Pointer&gt; <span class="title function_">searchMemory</span><span class="params">(<span class="type">long</span> start, <span class="type">long</span> end, <span class="type">byte</span>[] data)</span> &#123;</span><br><span class="line">        List&lt;Pointer&gt; pointers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (end - start &gt;= data.length) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">long</span> <span class="variable">i</span> <span class="operator">=</span> start, max = end - data.length; i &lt;= max; i++) &#123;</span><br><span class="line">                <span class="type">boolean</span> <span class="variable">found</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; data.length; j++) &#123;</span><br><span class="line">                    <span class="type">Byte</span> <span class="variable">value</span> <span class="operator">=</span> memoryData.get(i + j);</span><br><span class="line">                    <span class="keyword">if</span> (value == <span class="literal">null</span> || value != data[j]) &#123;</span><br><span class="line">                        found = <span class="literal">false</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (found) &#123;</span><br><span class="line">                    pointers.add(UnidbgPointer.pointer(emulator, i));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pointers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateActivePlace</span><span class="params">(<span class="type">long</span> address, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">newAddress</span> <span class="operator">=</span> address + i;</span><br><span class="line">            <span class="keyword">if</span> (addressUsed.add(newAddress)) &#123;</span><br><span class="line">                updateActivePlace(newAddress);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateActivePlace</span><span class="params">(<span class="type">long</span> address)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">lower</span> <span class="operator">=</span> addressUsed.lower(address);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">higher</span> <span class="operator">=</span> addressUsed.higher(address);</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">connectToLower</span> <span class="operator">=</span> lower != <span class="literal">null</span> &amp;&amp; lower + <span class="number">1</span> == address;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">connectToHigher</span> <span class="operator">=</span> higher != <span class="literal">null</span> &amp;&amp; address + <span class="number">1</span> == higher;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span>[] lowerRange = <span class="literal">null</span>;</span><br><span class="line">        <span class="type">long</span>[] higherRange = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">long</span>[] range : activePlace) &#123;</span><br><span class="line">            <span class="keyword">if</span> (connectToLower &amp;&amp; range[<span class="number">1</span>] == lower) &#123;</span><br><span class="line">                lowerRange = range;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (connectToHigher &amp;&amp; range[<span class="number">0</span>] == higher) &#123;</span><br><span class="line">                higherRange = range;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (connectToLower &amp;&amp; connectToHigher) &#123;</span><br><span class="line">            <span class="keyword">assert</span> lowerRange != <span class="literal">null</span>;</span><br><span class="line">            lowerRange[<span class="number">1</span>] = higherRange[<span class="number">1</span>];</span><br><span class="line">            activePlace.remove(higherRange);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (connectToLower) &#123;</span><br><span class="line">            <span class="keyword">assert</span> lowerRange != <span class="literal">null</span>;</span><br><span class="line">            lowerRange[<span class="number">1</span>] = address;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (connectToHigher) &#123;</span><br><span class="line">            <span class="keyword">assert</span> higherRange != <span class="literal">null</span>;</span><br><span class="line">            higherRange[<span class="number">0</span>] = address;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            activePlace.add(<span class="keyword">new</span> <span class="title class_">long</span>[]&#123;address, address&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它使用上非常简单，在 loadlibaray 前添加下面一行代码即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">DataSearch</span>(Emulator&lt;?&gt; emulator, String data);</span><br></pre></td></tr></table></figure>
<p>其中 data 是你所需要搜索内容的 hexstring 形式，加不加空格都行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">DataSearch</span>(emulator, <span class="string">&quot;cd 8e ec&quot;</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">DataSearch</span>(emulator, <span class="string">&quot;cd8eec&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>DataSearch 默认的搜索频率是每 100指令流，如果处理千万级或亿级的指令流，那么可以使用 DataSearch 的另外一个构造函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">DataSearch</span>(Emulator&lt;?&gt; emulator, String data, <span class="type">int</span> interval);</span><br></pre></td></tr></table></figure>
<p>interval 用于指定每隔多少个基本块做一次内存检索，建议千万级指令流选择 500 左右，亿级指令流选择 2000 左右。检索频率越高，搜索的准确度越高，越可能发现数据的第一生成现场；检索越稀疏，搜索的耗时就越小，但可能会错过第一生成现场。因此，我们需要在性能和准确度之间找个均衡点。<br>DataSearch 并非万能，如果数据过短小，比如两三个字节，那么在内存中就不具有标识性和唯一性，无法用它处理。这种情景请使用污点分析或类似的其它分析技术。<br>除了搜索某个指定字节数组外，DataSearch 稍加修改，可以用于搜索 Key、字符串等等，比如下面是 StringSearch，它会打印内存中出现过的所有可见字符串。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.github.unidbg.Emulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.arm.backend.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.pointer.UnidbgPointer;</span><br><span class="line"><span class="keyword">import</span> com.sun.jna.Pointer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringSearch</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Emulator&lt;?&gt; emulator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TreeSet&lt;Long&gt; addressUsed = <span class="keyword">new</span> <span class="title class_">TreeSet</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Long, Byte&gt; memoryData = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; foundStrings = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> interval;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> minLength;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;<span class="type">long</span>[]&gt; activePlace = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> PrintWriter output;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">StringSearch</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">int</span> minLength, String outputFile)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.emulator = emulator;</span><br><span class="line">        <span class="built_in">this</span>.interval = <span class="number">100</span>;</span><br><span class="line">        <span class="built_in">this</span>.minLength = minLength;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.output = <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(outputFile));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        hookReadAndWrite();</span><br><span class="line">        hookBlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">StringSearch</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">int</span> minLength, <span class="type">int</span> interval, String outputFile)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.emulator = emulator;</span><br><span class="line">        <span class="built_in">this</span>.interval = interval;</span><br><span class="line">        <span class="built_in">this</span>.minLength = minLength;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.output = <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(outputFile));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        hookReadAndWrite();</span><br><span class="line">        hookBlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">hookReadAndWrite</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">WriteHook</span> <span class="variable">writeHook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WriteHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAttach</span><span class="params">(UnHook unHook)</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">detach</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hook</span><span class="params">(Backend backend, <span class="type">long</span> address, <span class="type">int</span> size, <span class="type">long</span> value, Object user)</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> <span class="number">0</span>; offset &lt; size; offset++) &#123;</span><br><span class="line">                    memoryData.put(address + offset, (<span class="type">byte</span>) (value &gt;&gt;&gt; (offset * <span class="number">8</span>)));</span><br><span class="line">                &#125;</span><br><span class="line">                updateActivePlace(address, size);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ReadHook</span> <span class="variable">readHook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReadHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAttach</span><span class="params">(UnHook unHook)</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">detach</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hook</span><span class="params">(Backend backend, <span class="type">long</span> address, <span class="type">int</span> size, Object user)</span> &#123;</span><br><span class="line">                <span class="type">byte</span>[] readBytes = emulator.getBackend().mem_read(address, size);</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> <span class="number">0</span>; offset &lt; size; offset++) &#123;</span><br><span class="line">                    memoryData.put(address + offset, readBytes[offset]);</span><br><span class="line">                &#125;</span><br><span class="line">                updateActivePlace(address, size);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        emulator.getBackend().hook_add_new(writeHook, <span class="number">1</span>, <span class="number">0</span>, <span class="literal">null</span>);</span><br><span class="line">        emulator.getBackend().hook_add_new(readHook, <span class="number">1</span>, <span class="number">0</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">hookBlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">BlockHook</span> <span class="variable">blockHook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BlockHook</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAttach</span><span class="params">(UnHook unHook)</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">detach</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hookBlock</span><span class="params">(Backend backend, <span class="type">long</span> address, <span class="type">int</span> size, Object user)</span> &#123;</span><br><span class="line">                count++;</span><br><span class="line">                <span class="keyword">if</span> (count % interval == <span class="number">0</span>)&#123;</span><br><span class="line">                    searchString();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        emulator.getBackend().hook_add_new(blockHook, <span class="number">1</span>, <span class="number">0</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">searchString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">long</span>[] range : activePlace) &#123;</span><br><span class="line">            searchStringInRange(range);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">searchStringInRange</span><span class="params">(<span class="type">long</span>[] range)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> (<span class="type">int</span>) (range[<span class="number">1</span>] - range[<span class="number">0</span>] + <span class="number">1</span>);</span><br><span class="line">        <span class="type">byte</span>[] codes = <span class="keyword">new</span> <span class="title class_">byte</span>[length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            codes[i] = memoryData.get(i + range[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        searchVisibleStringsInMemory(codes, range[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">searchVisibleStringsInMemory</span><span class="params">(<span class="type">byte</span>[] memory, <span class="type">long</span> addr)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; memory.length; i++) &#123;</span><br><span class="line">            <span class="type">byte</span> <span class="variable">b</span> <span class="operator">=</span> memory[i];</span><br><span class="line">            <span class="keyword">if</span> (b &gt;= <span class="number">32</span> &amp;&amp; b &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">                sb.append((<span class="type">char</span>) b);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                processVisibleString(sb, addr + i - sb.length());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        processVisibleString(sb, addr + memory.length - sb.length());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processVisibleString</span><span class="params">(StringBuilder sb, <span class="type">long</span> addr)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (sb.length() &gt;= minLength) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">visibleString</span> <span class="operator">=</span> sb.toString();</span><br><span class="line">            <span class="keyword">if</span> (foundStrings.add(visibleString)) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="string">&quot;Address: 0x&quot;</span> + Long.toHexString(addr) + <span class="string">&quot;, String: &quot;</span> + visibleString;</span><br><span class="line">                output.println(result);</span><br><span class="line">                output.flush();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sb.setLength(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateActivePlace</span><span class="params">(<span class="type">long</span> address, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">newAddress</span> <span class="operator">=</span> address + i;</span><br><span class="line">            <span class="keyword">if</span> (addressUsed.add(newAddress)) &#123;</span><br><span class="line">                updateActivePlace(newAddress);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateActivePlace</span><span class="params">(<span class="type">long</span> address)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">lower</span> <span class="operator">=</span> addressUsed.lower(address);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">higher</span> <span class="operator">=</span> addressUsed.higher(address);</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">connectToLower</span> <span class="operator">=</span> lower != <span class="literal">null</span> &amp;&amp; lower + <span class="number">1</span> == address;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">connectToHigher</span> <span class="operator">=</span> higher != <span class="literal">null</span> &amp;&amp; address + <span class="number">1</span> == higher;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span>[] lowerRange = <span class="literal">null</span>;</span><br><span class="line">        <span class="type">long</span>[] higherRange = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">long</span>[] range : activePlace) &#123;</span><br><span class="line">            <span class="keyword">if</span> (connectToLower &amp;&amp; range[<span class="number">1</span>] == lower) &#123;</span><br><span class="line">                lowerRange = range;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (connectToHigher &amp;&amp; range[<span class="number">0</span>] == higher) &#123;</span><br><span class="line">                higherRange = range;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (connectToLower &amp;&amp; connectToHigher) &#123;</span><br><span class="line">            <span class="keyword">assert</span> lowerRange != <span class="literal">null</span>;</span><br><span class="line">            lowerRange[<span class="number">1</span>] = higherRange[<span class="number">1</span>];</span><br><span class="line">            activePlace.remove(higherRange);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (connectToLower) &#123;</span><br><span class="line">            <span class="keyword">assert</span> lowerRange != <span class="literal">null</span>;</span><br><span class="line">            lowerRange[<span class="number">1</span>] = address;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (connectToHigher) &#123;</span><br><span class="line">            <span class="keyword">assert</span> higherRange != <span class="literal">null</span>;</span><br><span class="line">            higherRange[<span class="number">0</span>] = address;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            activePlace.add(<span class="keyword">new</span> <span class="title class_">long</span>[]&#123;address, address&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用上也很简单，参数 1 是模拟器实例，参数 2 是可见字符串的最短长度，参数 3 是输出的文件路径。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">StringSearch</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">int</span> minLength, String outputFile)</span></span><br></pre></td></tr></table></figure>
<p>它的默认搜索频率是 100 个基本块，可以使用它的重载方法，修改这个值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">StringSearch</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">int</span> minLength, <span class="type">int</span> interval, String outputFile)</span></span><br></pre></td></tr></table></figure>
<p>具体使用上，比如下面这样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">StringSearch</span>(emulator, <span class="number">5</span>,<span class="string">&quot;unidbg-android/src/test/resources/trace/strings.log&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>效果如下，运行时的字符串可以给出很多指引。<br><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/28.png"
                     
                ></p>
<h3 id="findCryptInTrace"><a href="#findCryptInTrace" class="headerlink" title="findCryptInTrace"></a>findCryptInTrace</h3><p>哈希算法主要关注下面这几点。<br>● 使用了哪种哈希算法<br>● 哈希的输入是什么<br>● 哈希的输出是什么<br>● 哈希算法是否魔改<br>首先要确定使用了什么哈希算法，上面用 IDA Findcrypt 插件看到，样本里有 SHA256 的魔数，但这并不意味着我们的目标函数就使用了这个算法，对吧。<br>但是，如果我们能在 trace 里找到 SHA256 算法的相关魔数，那就证实了 SHA256 的存在。我写过一个 010Editor 小脚本，叫 findCryptInTrace.1sc，其内容如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> md5[<span class="number">4</span>] = &#123;<span class="number">0xd76aa478</span>, <span class="number">0xe8c7b756</span>, <span class="number">0x242070db</span>, <span class="number">0xc1bdceee</span>&#125;;</span><br><span class="line"><span class="type">int</span> sha1[<span class="number">4</span>] = &#123;<span class="number">0x5A827999</span>, <span class="number">0x6ED9EBA1</span>, <span class="number">0x8F1BBCDC</span>, <span class="number">0xCA62C1D6</span>&#125;;</span><br><span class="line"><span class="type">int</span> sha256[<span class="number">4</span>] = &#123;<span class="number">0x428a2f98</span>, <span class="number">0x71374491</span>, <span class="number">0xb5c0fbcf</span>, <span class="number">0xe9b5dba5</span>&#125;;</span><br><span class="line"><span class="type">int</span> sm3[<span class="number">2</span>] = &#123;<span class="number">0x79cc4519</span>, <span class="number">0x7a879d8a</span>&#125;;</span><br><span class="line"><span class="type">int</span> crc32[<span class="number">2</span>] = &#123;<span class="number">0x77073096</span>, <span class="number">0xEE0E612C</span>&#125;;</span><br><span class="line"><span class="type">int</span> chacha20[<span class="number">2</span>] = &#123;<span class="number">0x61707865</span>, <span class="number">0x3320646e</span>&#125;;</span><br><span class="line"><span class="type">int</span> hmac[<span class="number">2</span>] = &#123;<span class="number">0x36363636</span>, <span class="number">0x5C5C5C5C</span>&#125;;</span><br><span class="line"><span class="type">int</span> tea[<span class="number">1</span>] = &#123;<span class="number">0x9e3779b9</span>&#125;;</span><br><span class="line"><span class="type">int</span> twofish[<span class="number">4</span>] = &#123;<span class="number">0xBCBC3275</span>, <span class="number">0xECEC21F3</span>, <span class="number">0x202043C6</span>, <span class="number">0xB3B3C9F4</span>&#125;;</span><br><span class="line"><span class="type">int</span> salsa20[<span class="number">4</span>] = &#123;<span class="number">0x61707865</span>, <span class="number">0x3320646e</span>, <span class="number">0x79622d32</span>, <span class="number">0x6b206574</span>&#125;;</span><br><span class="line"><span class="type">int</span> blowfish[<span class="number">2</span>] = &#123;<span class="number">0x243f6a88</span>, <span class="number">0x85a308d3</span>&#125;;</span><br><span class="line"><span class="type">int</span> rc6[<span class="number">2</span>] = &#123;<span class="number">0xb7e15163</span>, <span class="number">0x9e3779b9</span>&#125;;</span><br><span class="line"><span class="type">int</span> aes[<span class="number">2</span>] = &#123;<span class="number">0xC66363A5</span>, <span class="number">0xF87C7C84</span>&#125;;</span><br><span class="line"><span class="type">int</span> aplib[<span class="number">1</span>] = &#123;<span class="number">0x32335041</span>&#125;;</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">search</span><span class="params">(<span class="type">int</span> arr[], string name)</span>&#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> sizeof(arr)/sizeof(arr[<span class="number">0</span>]);</span><br><span class="line">    local <span class="type">int</span> i;</span><br><span class="line">    local string s;</span><br><span class="line">    local <span class="type">uchar</span> <span class="variable">exist</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span>( i = <span class="number">0</span>; i &lt; num; i++ )&#123;</span><br><span class="line">        SPrintf(s, <span class="string">&quot;%X&quot;</span>, arr[i]);</span><br><span class="line">        <span class="keyword">if</span>(FindFirst(s, <span class="literal">false</span>) &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            exist = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(exist)&#123;</span><br><span class="line">        Printf(<span class="string">&quot;Find &quot;</span>+name +<span class="string">&quot;, num:0x&quot;</span>+s+<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Printf(<span class="string">&quot;***********Findcrypt Search Start****************\n&quot;</span>);</span><br><span class="line">search(md5, <span class="string">&quot;MD5&quot;</span>);</span><br><span class="line">search(sha1, <span class="string">&quot;SHA1&quot;</span>);</span><br><span class="line">search(sha256, <span class="string">&quot;SHA256&quot;</span>);</span><br><span class="line">search(sm3, <span class="string">&quot;sm3&quot;</span>);</span><br><span class="line">search(crc32, <span class="string">&quot;crc32&quot;</span>);</span><br><span class="line">search(chacha20, <span class="string">&quot;chacha20&quot;</span>);</span><br><span class="line">search(hmac, <span class="string">&quot;hmac&quot;</span>);</span><br><span class="line">search(tea, <span class="string">&quot;tea&quot;</span>);</span><br><span class="line">search(twofish,<span class="string">&quot;twofish&quot;</span>);</span><br><span class="line">search(salsa20, <span class="string">&quot;salsa20&quot;</span>);</span><br><span class="line">search(blowfish, <span class="string">&quot;blowfish&quot;</span>);</span><br><span class="line">search(rc6,<span class="string">&quot;rc6&quot;</span>);</span><br><span class="line">search(aes,<span class="string">&quot;aes&quot;</span>);</span><br><span class="line">search(aplib,<span class="string">&quot;aplib&quot;</span>);</span><br><span class="line">Printf(<span class="string">&quot;***********Findcrypt Search Over****************\n&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>原理和 Findcrypt 类似，搜索各种常见算法所使用的常量，下面演示它的使用。<br><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/29.png"
                     
                ><br>打开我们的脚本，选择运行。<br><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/30.png"
                     
                ><br>trace 里明确找到了 SHA256 算法以及 HMAC 方案的特征。这说明样本可能使用了 HMAC-SHA256，也可能是 SHA256 + HMAC-SHA256，或者其它，这都说不清，需要进一步分析。</p>
<!-- ## 算法分析中的HOOK思路  

- 快速验证用Console Debugger 
- 持久化用HookZz 
- 稳定Hook 用Unicorn Hook   -->


<h2 id="反制unidng"><a href="#反制unidng" class="headerlink" title="反制unidng"></a>反制unidng</h2><p>如何增加跑通Unidbg模拟执行的成本  ？</p>
<h4 id="一、JNI交互"><a href="#一、JNI交互" class="headerlink" title="一、JNI交互"></a>一、JNI交互</h4><p>主要有两点 </p>
<ol>
<li>尽可能增加补JAVA环境所需的时间成本</li>
</ol>
<p>打个比方，在SO中编写1000个对JAVA层的访问和调用函数，每次计算时根据时间戳使用其中的50 个，这样做的话，运算的时间成本不高，但因为时间戳一直在变，所以得在Unidbg中补齐全量的 JAVA访问。 </p>
<ol start="2">
<li>使用Unidbg暂不支持的JNI调用</li>
</ol>
<p>src&#x2F;main&#x2F;java&#x2F;com&#x2F;github&#x2F;unidbg&#x2F;linux&#x2F;android&#x2F;dvm&#x2F;DalvikVM.java 是Unidbg中实现JNI方法 的类，可以发现，只实现了最常用的那部分JNI方法，所以可以在样本中使用这些Unidbg尚未实现 的JNI方法。 </p>
<h4 id="二、系统调用"><a href="#二、系统调用" class="headerlink" title="二、系统调用"></a>二、系统调用</h4><p>Unidbg实现了许多常见的系统调用，但还有一些偏冷门的系统调用未实现，以及不偏僻但较难完美实现 的系统调用，典型代表——fork相关系统调用。 </p>
<h4 id="三、文件访问"><a href="#三、文件访问" class="headerlink" title="三、文件访问"></a>三、文件访问</h4><p>尽可能多的文件访问和交互 </p>
<h4 id="四、检测Unidbg"><a href="#四、检测Unidbg" class="headerlink" title="四、检测Unidbg"></a>四、检测Unidbg</h4><p>样本可以感知并检测自己运行在Unidbg环境中，并走向错误的分支。这一块我的了解不多，但确实是可 以的，Unidbg的执行环境和真机是有很大差距的。打个比方，每个Android进程都有一些初始化环境变 量，Android系统启动时通过setEnv设置，Unidbg中则没有。 </p>
<h4 id="五、目标函数无法被单独执行"><a href="#五、目标函数无法被单独执行" class="headerlink" title="五、目标函数无法被单独执行"></a>五、目标函数无法被单独执行</h4><p>尽其所能的增加目标函数被执行的”前置条件“，或者说初始化函数。这里面可以玩的花招、阴招太多 了。这应该作为一个主要的反Unidbg的方向，它是有效且杀伤力巨大的  </p>
<h4 id="六、在真机上使用GetStaticMethodID寻找一个不存在的方法"><a href="#六、在真机上使用GetStaticMethodID寻找一个不存在的方法" class="headerlink" title="六、在真机上使用GetStaticMethodID寻找一个不存在的方法"></a>六、在真机上使用GetStaticMethodID寻找一个不存在的方法</h4><p>在真机上，使用GetStaticMethodID寻找一个不存在的方法，系统会返回一个错误。在unidbg中使用GetStaticMethodID，像是无论存不存在都会模拟一个jmethodID返回给so<br />关于这个反unidbg的思路和形成，如果java层不存在某个类或者方法，jni中使用findclass或者getmethodid就会报错（这很合理嘛，因为找不到），而Unidbg因为没办法了解Java环境具体咋样，所以不管你find啥class还是get什么method，它都当做这是存在的。<br />解决，如果你想让Unidbg findclass找不到一个类，可以使用BaseVM的addNotFoundClass方法，如果想让Unidbg找不到某个方法，可以修改AbstractJni中的acceptMethod方法。</p>
<h2 id="Unidbg报错"><a href="#Unidbg报错" class="headerlink" title="Unidbg报错"></a>Unidbg报错</h2><h3 id="Illegal-JNI-version"><a href="#Illegal-JNI-version" class="headerlink" title="Illegal JNI version"></a>Illegal JNI version</h3><p><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/16.png"
                      alt="image.png"
                ><br /> JNI版本错误，而只意味 JNIOnLoad 运行过程中出了错。至于具体出错的原因有很多，一个常见的问题是SO的依赖库缺失。  <br /> 我们的目标SO依赖了 libc++_shared.so ，这个库是C++的支持库，但不在Unidbg默认支持的SO里。 我们要在apk的lib里把它拷贝出来。  <br /> 还有另一个更通用的办法 ，当报错时，就把 traceCode打开，记录执行流，看最后在哪儿停下来。  <br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/17.png"
                      alt="image.png"
                ><br /> 比如此处，我在JNI_OnLoad前面打开traceCode，在IDA中跳转到最后一条运行地址 0x177C  <br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/18.png"
                      alt="image.png"
                ><br /> 可以发现正是C++的标准库函数，符合上面的猜测。  <br />添加之后正常加载<br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/19.png"
                      alt="image.png"
                ></p>
<h3 id="app开发过程中的失误，释放变量后还调用"><a href="#app开发过程中的失误，释放变量后还调用" class="headerlink" title="app开发过程中的失误，释放变量后还调用"></a>app开发过程中的失误，释放变量后还调用</h3><p>运行样本后，发现内存错误<br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/20.png"
                      alt="image.png"
                ><br />第一种尝试，把Unidbg的日志全开，src&#x2F;test&#x2F;resources&#x2F;log4j.properties中的INFO全配置改为DEBUG<br />再次运行后会在报错的地方停下来。输入bt查看调用栈<br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/21.png"
                      alt="image.png"
                ><br />unidbg提供了大量详情的调用回溯信息，直接拉到底部，看目标样本是从哪里调用。用IDA跳到0xabf<br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/22.png"
                      alt="image.png"
                ><br />奇了怪了，打个日志还报错？把日志等级改为INFO，在此处下个断点分析。<br />emulator.attach().addBreakPoint(module.base+0x00abf);<br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/23.png"
                      alt="image.png"
                ><br />_android_log_print是常用函数，参数1是此日志的优先级，参数2是tag，参数3是格式化字符串，之后的都是内容。都可以在Console Debugger中验证<br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/24.png"
                      alt="image.png"
                ><br />参数1是6，可以直接看，通过mrx查看其余参数，参数23也都正常，那参数4呢<br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/25.png"
                      alt="image.png"
                ><br />内存异常了，返回IDA查看代码<br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/26.png"
                      alt="image.png"
                ><br />可以看到上面释放了变量，下面还在调用。<br />怎么解决？<br />直接patch，改为两条无效指令，需要修改4个字节<br /><img  
                     lazyload
                     alt="image"
                     data-src="/../images/24643/27.png"
                      alt="image.png"
                ><br />首先写入0046，debug发现不对，调整了一下大小端序，再DEBUG似乎OK了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">patchLog</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="type">int</span> <span class="variable">patchCode</span> <span class="operator">=</span> <span class="number">0x46004600</span>;</span><br><span class="line">	emulator.getMemory().pointer(<span class="keyword">module</span>.base + <span class="number">0xABE</span>).setInt(<span class="number">0</span>,patchCode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另一种填入两个nop也可以</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">patchLog1</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">Pointer</span> <span class="variable">pointer</span> <span class="operator">=</span> UnidbgPointer.pointer(emulator, <span class="keyword">module</span>.base + <span class="number">0xABE</span>);</span><br><span class="line">    <span class="keyword">assert</span> pointer != <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">Keystone</span> <span class="variable">keystone</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Keystone</span>(KeystoneArchitecture.Arm,KeystoneMode.ArmThumb)) &#123;</span><br><span class="line">		<span class="type">KeystoneEncoded</span> <span class="variable">encoded</span> <span class="operator">=</span> keystone.assemble(<span class="string">&quot;nop&quot;</span>);</span><br><span class="line">		<span class="type">byte</span>[] patch = encoded.getMachineCode();</span><br><span class="line">        pointer.write(<span class="number">0</span>, patch, <span class="number">0</span>, patch.length);</span><br><span class="line">        pointer.write(<span class="number">2</span>, patch, <span class="number">0</span>, patch.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>第三种方法，前面两种都是静态打patch，和用IDA的KeyPatch直接打patch没啥区别</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">patchLog2</span><span class="params">()</span>&#123;</span><br><span class="line">    emulator.attach().addBreakPoint(<span class="keyword">module</span>.base + <span class="number">0xABE</span>, <span class="keyword">new</span> <span class="title class_">BreakPointCallback</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onHit</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="type">long</span> address)</span> &#123;</span><br><span class="line">        	emulator.getBackend().reg_write(ArmConst.UC_ARM_REG_PC,(address)+<span class="number">5</span>);</span><br><span class="line">        	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>解释一下做了什么，我们在log的调用处下了一个断点，inline hook 都是在调用前断下来了，所以在执 行前断了下来，然后加了BreakPointCallback回调，在这个时机做处理，我们将PC指针直接往前加了 5，PC指向哪里，函数就执行哪里，本来PC指向“blx log”这个地址，程序即将去执行log函数。但我们直 接将PC加了5，为什么加5？<br />我们知道这里的log是个坑，它长四个字节，我们要越过这个坑，但加4不够，我们是thumb模式，再+1，所以就是+5。</p>

                </div>

                
                        <div class="article-copyright-info-container border-box">
    <div class="copyright-info-content border-box">
        <div class="copyright-info-top border-box">
            <div class="post-title border-box text-ellipsis">
                Unidbg操作说明
            </div>

            <div class="post-link border-box text-ellipsis">
                posts/24643/
            </div>
        </div>

        <div class="copyright-info-bottom border-box">
            <div class="post-author bottom-item">
                <div class="type">
                    作者
                </div>
                <div class="content">zsk</div>
            </div>

            <div class="post-time bottom-item">
                <div class="type">
                    发布于
                </div>
                <div class="content">2022-10-19 00:00</div>
            </div>


            <div class="post-license bottom-item">
                <div class="type">
                    许可
                </div>
                <div class="content tooltip" data-tooltip-content="CC BY-NC-SA 4.0">
                    <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">
                        <i class="fa-brands fa-creative-commons"></i>
                        <i class="fa-brands fa-creative-commons-by"></i>
                        <i class="fa-brands fa-creative-commons-nc"></i>
                        <i class="fa-brands fa-creative-commons-sa"></i>
                    </a>
                </div>
            </div>
        </div>

        <i class="copyright-bg fa-solid fa-copyright"></i>
    </div>
    <div class="copy-copyright-info flex-center tooltip" data-tooltip-content="复制版权信息" data-tooltip-offset-y="-2px">
        <i class="fa-solid fa-copy"></i>
    </div>
</div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/Unidbg/">Unidbg</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                            <div class="post-share-container border-box">
    <ul class="share-list-wrap border-box">
        <li class="qq share-item border-box flex-center tooltip"
            data-tooltip-content="分享到 QQ"
        >
            <i class="fa-brands fa-qq"></i>
        </li>
        <li class="wechat share-item border-box flex-center tooltip tooltip-img"
            data-tooltip-content="分享到微信"
            data-tooltip-img-tip="微信扫一扫"
            data-tooltip-img-style="background-color: #fff; top: -10px; padding: 0.6rem 0.6rem 0.1rem 0.6rem;"
        >
            <i class="fa-brands fa-weixin"></i>
        </li>
        <li class="weibo share-item border-box flex-center tooltip"
            data-tooltip-content="分享到微博"
        >
            <i class="fa-brands fa-weibo"></i>
        </li>
    </ul>
</div>

                        
                    </div>
                </div>

                

                
                    <div class="article-nav">
                        
                            <div class="article-prev">
                                <a class="prev"
                                   rel="prev"
                                   href="/posts/48808/"
                                   title="unidbg踩坑记录，getobjectclass对象为null"
                                >
                                    <span class="left arrow-icon flex-center">
                                      <i class="fas fa-chevron-left"></i>
                                    </span>
                                            <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">unidbg踩坑记录，getobjectclass对象为null</span>
                                        <span class="post-nav-item">上一篇</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="article-next">
                                <a class="next"
                                   rel="next"
                                   href="/posts/3538/"
                                   title="对称加解密算法RC4原理过程及实现"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">对称加解密算法RC4原理过程及实现</span>
                                        <span class="post-nav-item">下一篇</span>
                                    </span>
                                            <span class="right arrow-icon flex-center">
                                      <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    


    <div class="comments-container border-box">
        <div id="comments-anchor" class="comment-area-title border-box">
            <i class="fas fa-comments"></i>&nbsp;评论
        </div>
        
            

    <div class="valine-container">
        <script data-pjax src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script data-pjax>
          function loadValine() {

            const config = {
              el: '#vcomments',
              appId: 'WxNQs5QEQtykF82Sb7nAjXRO-gzGzoHsz',
              appKey: '4rZ6NwH5zAu6VEspHwVrgqOq',
              meta: ['nick', 'mail', 'link'],
              avatar: 'wavatar',
              enableQQ: true,
              placeholder: '😜 尽情吐槽吧~',
              lang: 'zh-CN'.toLowerCase()
            }

            if ('') {
              config.serverURLs = ''
            }

            new Valine(config)

            function getAuthor(language) {
              switch (language) {
                case 'en':
                  return 'Author'
                case 'zh-CN':
                  return '博主'
                case 'zh-TW':
                  return '站長'
                default:
                  return 'Master'
              }
            }

            // Add "Author" identify
            const getValineDomTimer = setInterval(() => {
              const vcards = document.querySelectorAll('#vcomments .vcards .vcard')
              if (vcards.length > 0) {
                let author = 'zsk'

                if (author) {
                  for (let vcard of vcards) {
                    const vnick_dom = vcard.querySelector('.vhead .vnick')
                    const vnick = vnick_dom.innerHTML
                    if (vnick === author) {
                      vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                    }
                  }
                }
                clearInterval(getValineDomTimer)
              } else {
                clearInterval(getValineDomTimer)
              }
            }, 2000)
          }

          if ('true' === 'true') {
            const loadValineTimeout = setTimeout(() => {
              loadValine()
              clearTimeout(loadValineTimeout)
            }, 1000)
          } else {
            window.addEventListener('DOMContentLoaded', loadValine)
          }
        </script>
    </div>


        
    </div>





                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A1%A5%E7%8E%AF%E5%A2%83%E7%9A%84%E4%B8%89%E6%9D%A1%E5%87%86%E5%88%99"><span class="nav-number">1.</span> <span class="nav-text">补环境的三条准则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95"><span class="nav-number">2.</span> <span class="nav-text">目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A1%86%E6%9E%B6"><span class="nav-number">3.</span> <span class="nav-text">基本框架</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AndroidEmulator"><span class="nav-number">4.</span> <span class="nav-text">AndroidEmulator</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AndroidEmulator%E4%BB%8B%E7%BB%8D"><span class="nav-number">4.1.</span> <span class="nav-text">AndroidEmulator介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAAndroidEmulator%E5%AE%9E%E4%BE%8B"><span class="nav-number">4.2.</span> <span class="nav-text">创建AndroidEmulator实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AndroidEmulator%E6%93%8D%E4%BD%9C%E6%8E%A5%E5%8F%A3"><span class="nav-number">4.3.</span> <span class="nav-text">AndroidEmulator操作接口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#getMemory"><span class="nav-number">4.3.1.</span> <span class="nav-text">getMemory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getPid"><span class="nav-number">4.3.2.</span> <span class="nav-text">getPid</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#createDalvikVM"><span class="nav-number">4.3.3.</span> <span class="nav-text">createDalvikVM</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#loadLibrary"><span class="nav-number">4.3.4.</span> <span class="nav-text">loadLibrary</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getDalvikVM"><span class="nav-number">4.3.5.</span> <span class="nav-text">getDalvikVM</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#showRegs"><span class="nav-number">4.3.6.</span> <span class="nav-text">showRegs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getBackend"><span class="nav-number">4.3.7.</span> <span class="nav-text">getBackend</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getProcessName"><span class="nav-number">4.3.8.</span> <span class="nav-text">getProcessName</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getContext"><span class="nav-number">4.3.9.</span> <span class="nav-text">getContext</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#isRunning"><span class="nav-number">4.3.10.</span> <span class="nav-text">isRunning</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Trace"><span class="nav-number">4.3.11.</span> <span class="nav-text">Trace</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Set-x2F-Get"><span class="nav-number">4.3.12.</span> <span class="nav-text">Set&#x2F;Get</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SyscallHandler"><span class="nav-number">4.3.13.</span> <span class="nav-text">SyscallHandler</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Debugger"><span class="nav-number">4.3.14.</span> <span class="nav-text">Debugger</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#emulateSignal"><span class="nav-number">4.3.15.</span> <span class="nav-text">emulateSignal</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#disassemble"><span class="nav-number">4.3.16.</span> <span class="nav-text">disassemble</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#close"><span class="nav-number">4.3.17.</span> <span class="nav-text">close</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getUnwinder"><span class="nav-number">4.3.18.</span> <span class="nav-text">getUnwinder</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Memory"><span class="nav-number">5.</span> <span class="nav-text">Memory</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Memory%E4%BB%8B%E7%BB%8D"><span class="nav-number">5.1.</span> <span class="nav-text">Memory介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Memory%E6%93%8D%E4%BD%9C"><span class="nav-number">5.2.</span> <span class="nav-text">Memory操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96Memory%E5%AE%9E%E4%BE%8B"><span class="nav-number">5.2.1.</span> <span class="nav-text">获取Memory实例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#setLibraryResolver"><span class="nav-number">5.2.2.</span> <span class="nav-text">setLibraryResolver</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#findModule"><span class="nav-number">5.2.3.</span> <span class="nav-text">findModule</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#allocateStack"><span class="nav-number">5.2.4.</span> <span class="nav-text">allocateStack</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#malloc"><span class="nav-number">5.2.5.</span> <span class="nav-text">malloc</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#setErrno"><span class="nav-number">5.2.6.</span> <span class="nav-text">setErrno</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getStackPoint"><span class="nav-number">5.2.7.</span> <span class="nav-text">getStackPoint</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#disableCallInitFunction"><span class="nav-number">5.2.8.</span> <span class="nav-text">disableCallInitFunction</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getMemoryMap"><span class="nav-number">5.2.9.</span> <span class="nav-text">getMemoryMap</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pointer"><span class="nav-number">5.2.10.</span> <span class="nav-text">pointer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#addModuleListener"><span class="nav-number">5.2.11.</span> <span class="nav-text">addModuleListener</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#load"><span class="nav-number">5.2.12.</span> <span class="nav-text">load</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Memory%E6%80%BB%E7%BB%93"><span class="nav-number">5.3.</span> <span class="nav-text">Memory总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VM"><span class="nav-number">6.</span> <span class="nav-text">VM</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#VM%E4%BB%8B%E7%BB%8D"><span class="nav-number">6.1.</span> <span class="nav-text">VM介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VM%E5%88%9B%E5%BB%BA"><span class="nav-number">6.2.</span> <span class="nav-text">VM创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VM%E6%8E%A5%E5%8F%A3"><span class="nav-number">6.3.</span> <span class="nav-text">VM接口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E6%8E%A7%E5%88%B6"><span class="nav-number">6.3.1.</span> <span class="nav-text">日志控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AEJNI"><span class="nav-number">6.3.2.</span> <span class="nav-text">设置JNI</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E7%94%A8JNI-OnLoad%E5%87%BD%E6%95%B0"><span class="nav-number">6.3.3.</span> <span class="nav-text">调用JNI_OnLoad函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%A8%A1%E6%8B%9F%E5%99%A8%E5%AE%9E%E4%BE%8B"><span class="nav-number">6.3.4.</span> <span class="nav-text">获取模拟器实例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96APK%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF"><span class="nav-number">6.3.5.</span> <span class="nav-text">获取APK相关信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9D%97"><span class="nav-number">6.3.6.</span> <span class="nav-text">加载模块</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VM%E6%80%BB%E7%BB%93"><span class="nav-number">6.4.</span> <span class="nav-text">VM总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CallMethod"><span class="nav-number">7.</span> <span class="nav-text">CallMethod</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8CJNI%E5%87%BD%E6%95%B0"><span class="nav-number">7.1.</span> <span class="nav-text">执行JNI函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E4%BB%BB%E6%84%8F%E5%87%BD%E6%95%B0"><span class="nav-number">7.2.</span> <span class="nav-text">执行任意函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8Cmain%E5%87%BD%E6%95%B0"><span class="nav-number">7.3.</span> <span class="nav-text">执行main函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JNI%E6%96%B9%E6%B3%95%E5%B0%81%E8%A3%85"><span class="nav-number">7.4.</span> <span class="nav-text">JNI方法封装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#void"><span class="nav-number">7.4.1.</span> <span class="nav-text">void</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#boolean"><span class="nav-number">7.4.2.</span> <span class="nav-text">boolean</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#int"><span class="nav-number">7.4.3.</span> <span class="nav-text">int</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#long"><span class="nav-number">7.4.4.</span> <span class="nav-text">long</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#float"><span class="nav-number">7.4.5.</span> <span class="nav-text">float</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#double"><span class="nav-number">7.4.6.</span> <span class="nav-text">double</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E7%B1%BB%E5%9E%8B"><span class="nav-number">7.4.7.</span> <span class="nav-text">对象类型</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JNI%E6%96%B9%E6%B3%95%E7%AD%BE%E5%90%8D"><span class="nav-number">7.5.</span> <span class="nav-text">JNI方法签名</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hook"><span class="nav-number">8.</span> <span class="nav-text">Hook</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Hook%E4%BB%8B%E7%BB%8D"><span class="nav-number">8.1.</span> <span class="nav-text">Hook介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hook%E6%A1%86%E6%9E%B6%E5%88%86%E7%B1%BB"><span class="nav-number">8.2.</span> <span class="nav-text">Hook框架分类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#HookZz"><span class="nav-number">8.2.1.</span> <span class="nav-text">HookZz</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96HookZz%E5%AE%9E%E4%BE%8B"><span class="nav-number">8.2.1.1.</span> <span class="nav-text">获取HookZz实例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#HookZz-API"><span class="nav-number">8.2.1.2.</span> <span class="nav-text">HookZz API</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#wrap"><span class="nav-number">8.2.1.2.1.</span> <span class="nav-text">wrap</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#replace"><span class="nav-number">8.2.1.2.2.</span> <span class="nav-text">replace</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#instrument"><span class="nav-number">8.2.1.2.3.</span> <span class="nav-text">instrument</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Dobby"><span class="nav-number">8.2.2.</span> <span class="nav-text">Dobby</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96Dobby%E5%AE%9E%E4%BE%8B"><span class="nav-number">8.2.2.1.</span> <span class="nav-text">获取Dobby实例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Dobby-API"><span class="nav-number">8.2.2.2.</span> <span class="nav-text">Dobby API</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#replace-1"><span class="nav-number">8.2.2.2.1.</span> <span class="nav-text">replace</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#instrument-1"><span class="nav-number">8.2.2.2.2.</span> <span class="nav-text">instrument</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#xHook"><span class="nav-number">8.2.3.</span> <span class="nav-text">xHook</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96xHook%E5%AE%9E%E4%BE%8B"><span class="nav-number">8.2.3.1.</span> <span class="nav-text">获取xHook实例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#xHook-API"><span class="nav-number">8.2.3.2.</span> <span class="nav-text">xHook API</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#register"><span class="nav-number">8.2.3.2.1.</span> <span class="nav-text">register</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#refresh"><span class="nav-number">8.2.3.2.2.</span> <span class="nav-text">refresh</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Whale"><span class="nav-number">8.2.4.</span> <span class="nav-text">Whale</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96Whale%E5%AE%9E%E4%BE%8B"><span class="nav-number">8.2.4.1.</span> <span class="nav-text">获取Whale实例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Whale-API"><span class="nav-number">8.2.4.2.</span> <span class="nav-text">Whale API</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%94%9Fhook"><span class="nav-number">8.2.5.</span> <span class="nav-text">原生hook</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#patch"><span class="nav-number">8.3.</span> <span class="nav-text">patch</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JNI"><span class="nav-number">9.</span> <span class="nav-text">JNI</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JNI%E4%BB%8B%E7%BB%8D"><span class="nav-number">9.1.</span> <span class="nav-text">JNI介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B1%BB-x2F-%E7%B1%BB%E5%9E%8B"><span class="nav-number">9.2.</span> <span class="nav-text">类&#x2F;类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1-x2F-%E5%AE%9E%E4%BE%8B"><span class="nav-number">9.3.</span> <span class="nav-text">对象&#x2F;实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%85%E8%A3%85%E5%AF%B9%E8%B1%A1"><span class="nav-number">9.4.</span> <span class="nav-text">包装对象</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#String"><span class="nav-number">9.4.1.</span> <span class="nav-text">String</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Array"><span class="nav-number">9.4.2.</span> <span class="nav-text">Array</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#List"><span class="nav-number">9.4.3.</span> <span class="nav-text">List</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Module"><span class="nav-number">10.</span> <span class="nav-text">Module</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Module%E4%BB%8B%E7%BB%8D"><span class="nav-number">10.1.</span> <span class="nav-text">Module介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Module%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="nav-number">10.2.</span> <span class="nav-text">Module常用的属性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#base"><span class="nav-number">10.2.1.</span> <span class="nav-text">base</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#name"><span class="nav-number">10.2.2.</span> <span class="nav-text">name</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#callEntry"><span class="nav-number">10.2.3.</span> <span class="nav-text">callEntry</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#findSymbolByName"><span class="nav-number">10.2.4.</span> <span class="nav-text">findSymbolByName</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Backend"><span class="nav-number">11.</span> <span class="nav-text">Backend</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Backend%E4%BB%8B%E7%BB%8D"><span class="nav-number">11.1.</span> <span class="nav-text">Backend介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Backend%E5%88%97%E8%A1%A8"><span class="nav-number">11.2.</span> <span class="nav-text">Backend列表</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Unicorn-x2F-Unicorn2"><span class="nav-number">11.2.1.</span> <span class="nav-text">Unicorn&#x2F;Unicorn2</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Unicorn2%E5%90%8E%E7%AB%AF"><span class="nav-number">11.2.1.1.</span> <span class="nav-text">使用Unicorn2后端:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Unicorn%E5%90%8E%E7%AB%AF%E7%89%B9%E7%82%B9"><span class="nav-number">11.2.1.2.</span> <span class="nav-text">Unicorn后端特点</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Dynarmic"><span class="nav-number">11.2.2.</span> <span class="nav-text">Dynarmic</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Dynarmic%E5%90%8E%E7%AB%AF"><span class="nav-number">11.2.2.1.</span> <span class="nav-text">使用Dynarmic后端</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Dynarmic%E5%90%8E%E7%AB%AF%E7%89%B9%E7%82%B9"><span class="nav-number">11.2.2.2.</span> <span class="nav-text">Dynarmic后端特点</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hypervisor"><span class="nav-number">11.2.3.</span> <span class="nav-text">Hypervisor</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Hypervisor%E5%90%8E%E7%AB%AF"><span class="nav-number">11.2.3.1.</span> <span class="nav-text">使用Hypervisor后端</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Hypervisor%E5%90%8E%E7%AB%AF%E7%89%B9%E7%82%B9"><span class="nav-number">11.2.3.2.</span> <span class="nav-text">Hypervisor后端特点</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Kvm"><span class="nav-number">11.2.4.</span> <span class="nav-text">Kvm</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Kvm%E5%90%8E%E7%AB%AF"><span class="nav-number">11.2.4.1.</span> <span class="nav-text">使用Kvm后端</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Kvm%E5%90%8E%E7%AB%AF%E7%89%B9%E7%82%B9"><span class="nav-number">11.2.4.2.</span> <span class="nav-text">Kvm后端特点</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Backend%E6%8E%A5%E5%8F%A3"><span class="nav-number">11.3.</span> <span class="nav-text">Backend接口</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Deggbuer"><span class="nav-number">12.</span> <span class="nav-text">Deggbuer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Debugger%E4%BB%8B%E7%BB%8D"><span class="nav-number">12.1.</span> <span class="nav-text">Debugger介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConsoleDebugger"><span class="nav-number">12.2.</span> <span class="nav-text">ConsoleDebugger</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4"><span class="nav-number">12.2.1.</span> <span class="nav-text">使用步骤</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AC%AC%E9%9B%B6%E6%AD%A5"><span class="nav-number">12.2.1.1.</span> <span class="nav-text">第零步</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5"><span class="nav-number">12.2.1.2.</span> <span class="nav-text">第一步</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5"><span class="nav-number">12.2.1.3.</span> <span class="nav-text">第二步</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5"><span class="nav-number">12.2.1.4.</span> <span class="nav-text">第三步</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E6%8C%87%E4%BB%A4"><span class="nav-number">12.2.2.</span> <span class="nav-text">调试指令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#help"><span class="nav-number">12.2.2.1.</span> <span class="nav-text">help</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#shr"><span class="nav-number">12.2.3.</span> <span class="nav-text">shr</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#show-disassemble"><span class="nav-number">12.2.3.1.</span> <span class="nav-text">show disassemble</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#continue"><span class="nav-number">12.2.3.2.</span> <span class="nav-text">continue</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#step-over"><span class="nav-number">12.2.3.3.</span> <span class="nav-text">step over</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#step-into"><span class="nav-number">12.2.3.4.</span> <span class="nav-text">step into</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#next-block"><span class="nav-number">12.2.3.5.</span> <span class="nav-text">next block</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b"><span class="nav-number">12.2.3.6.</span> <span class="nav-text">b</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#r"><span class="nav-number">12.2.3.7.</span> <span class="nav-text">r</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#blr"><span class="nav-number">12.2.3.8.</span> <span class="nav-text">blr</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#vbs"><span class="nav-number">12.2.3.9.</span> <span class="nav-text">vbs</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#back-trace"><span class="nav-number">12.2.3.10.</span> <span class="nav-text">back trace</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#show-memory"><span class="nav-number">12.2.3.11.</span> <span class="nav-text">show memory</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write-memory"><span class="nav-number">12.2.3.12.</span> <span class="nav-text">write memory</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#search-stack"><span class="nav-number">12.2.3.13.</span> <span class="nav-text">search stack</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#search-writable-heap"><span class="nav-number">12.2.3.14.</span> <span class="nav-text">search writable heap</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#search-readable-heap"><span class="nav-number">12.2.3.15.</span> <span class="nav-text">search readable heap</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#search-executable-heap"><span class="nav-number">12.2.3.16.</span> <span class="nav-text">search executable heap</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#where"><span class="nav-number">12.2.3.17.</span> <span class="nav-text">where</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#vm"><span class="nav-number">12.2.3.18.</span> <span class="nav-text">vm</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#stop"><span class="nav-number">12.2.3.19.</span> <span class="nav-text">stop</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#patch-1"><span class="nav-number">12.2.3.20.</span> <span class="nav-text">patch</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#trace"><span class="nav-number">12.2.3.21.</span> <span class="nav-text">trace</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GDB-SERVER"><span class="nav-number">12.3.</span> <span class="nav-text">GDB_SERVER</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ANDROID-SERVER-V7"><span class="nav-number">12.4.</span> <span class="nav-text">ANDROID_SERVER_V7</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Block"><span class="nav-number">12.5.</span> <span class="nav-text">Block</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RegisterContext"><span class="nav-number">13.</span> <span class="nav-text">RegisterContext</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SyscallHandler-1"><span class="nav-number">14.</span> <span class="nav-text">SyscallHandler</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SyscallHandler%E4%BB%8B%E7%BB%8D"><span class="nav-number">14.1.</span> <span class="nav-text">SyscallHandler介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#API"><span class="nav-number">14.2.</span> <span class="nav-text">API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96SyscallHandler%E5%AE%9E%E4%BE%8B"><span class="nav-number">14.2.1.</span> <span class="nav-text">获取SyscallHandler实例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#setVerbose"><span class="nav-number">14.2.2.</span> <span class="nav-text">setVerbose</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#addIOResolver"><span class="nav-number">14.2.3.</span> <span class="nav-text">addIOResolver</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#setEnableThreadDispatcher"><span class="nav-number">14.2.4.</span> <span class="nav-text">setEnableThreadDispatcher</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#setFileListener"><span class="nav-number">14.2.5.</span> <span class="nav-text">setFileListener</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getFileIO"><span class="nav-number">14.2.6.</span> <span class="nav-text">getFileIO</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%A4%84%E7%90%86%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="nav-number">14.3.</span> <span class="nav-text">自处理系统调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FileResult"><span class="nav-number">14.4.</span> <span class="nav-text">FileResult</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#success"><span class="nav-number">14.4.1.</span> <span class="nav-text">success</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#failed"><span class="nav-number">14.4.2.</span> <span class="nav-text">failed</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fallback"><span class="nav-number">14.4.3.</span> <span class="nav-text">fallback</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VirtualModule"><span class="nav-number">15.</span> <span class="nav-text">VirtualModule</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#VirtualModulem%E4%BB%8B%E7%BB%8D"><span class="nav-number">15.1.</span> <span class="nav-text">VirtualModulem介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#unidbg%E8%87%AA%E5%B8%A6%E8%99%9A%E6%8B%9F%E6%A8%A1%E5%9D%97"><span class="nav-number">15.2.</span> <span class="nav-text">unidbg自带虚拟模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%99%9A%E6%8B%9F%E6%A8%A1%E5%9D%97"><span class="nav-number">15.3.</span> <span class="nav-text">自定义虚拟模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A8%A1%E6%8B%9F%E5%9C%BA%E6%99%AF"><span class="nav-number">15.3.1.</span> <span class="nav-text">模拟场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A6%96%E6%AC%A1%E5%B0%9D%E8%AF%95"><span class="nav-number">15.3.2.</span> <span class="nav-text">首次尝试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%84%E7%90%86%E9%97%AE%E9%A2%98"><span class="nav-number">15.3.3.</span> <span class="nav-text">处理问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="nav-number">15.3.4.</span> <span class="nav-text">完整代码</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Jnitrace"><span class="nav-number">16.</span> <span class="nav-text">Jnitrace</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-number">16.1.</span> <span class="nav-text">使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jnitrace%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E8%BF%94%E5%9B%9E%E7%9A%84%E6%98%AF%E5%9C%B0%E5%9D%80%E7%9A%84%E6%97%B6%E5%80%99"><span class="nav-number">16.2.</span> <span class="nav-text">jnitrace函数调用返回的是地址的时候</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A0%86%E6%A0%88%E6%A3%80%E6%B5%8B"><span class="nav-number">16.3.</span> <span class="nav-text">堆栈检测</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A8%E8%8D%90%E4%BD%BF%E7%94%A8objection%E6%9F%A5%E7%9C%8B%E5%A0%86%E6%A0%88"><span class="nav-number">16.3.1.</span> <span class="nav-text">推荐使用objection查看堆栈</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="nav-number">17.</span> <span class="nav-text">函数调用两种方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%A6%E5%8F%B7%E8%B0%83%E7%94%A8"><span class="nav-number">17.1.</span> <span class="nav-text">符号调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%B0%E5%9D%80%E8%B0%83%E7%94%A8"><span class="nav-number">17.2.</span> <span class="nav-text">地址调用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E7%B1%BB%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="nav-number">18.</span> <span class="nav-text">构建类的两种方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B1%BB%E7%BB%A7%E6%89%BF%E7%9A%84%E5%86%99%E6%B3%95"><span class="nav-number">19.</span> <span class="nav-text">类继承的写法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unidbg%E8%A1%A5%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E5%B1%9E%E6%80%A7"><span class="nav-number">20.</span> <span class="nav-text">unidbg补获取系统属性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E9%87%8D%E5%AE%9A%E5%90%91%EF%BC%8C%E5%AE%9E%E7%8E%B0-IOResolver"><span class="nav-number">21.</span> <span class="nav-text">文件重定向，实现 IOResolver</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E4%BA%9B%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD"><span class="nav-number">22.</span> <span class="nav-text">一些常用功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E5%8D%B0%E5%86%85%E5%AD%98%EF%BC%8Chexdump"><span class="nav-number">22.1.</span> <span class="nav-text">打印内存，hexdump</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#unidbg%E4%B8%8B%E6%96%AD%E7%82%B9"><span class="nav-number">22.2.</span> <span class="nav-text">unidbg下断点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%90%AF%E6%89%80%E6%9C%89%E7%9A%84%E6%97%A5%E5%BF%97"><span class="nav-number">22.3.</span> <span class="nav-text">开启所有的日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E6%B1%87%E7%BC%96%E7%9A%84%E8%A1%8C%E6%95%B0"><span class="nav-number">22.4.</span> <span class="nav-text">计算汇编的行数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E5%8D%B0%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E5%80%BC%E6%88%96%E4%BF%AE%E6%94%B9%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="nav-number">22.5.</span> <span class="nav-text">打印函数返回值或修改返回值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9A%8F%E6%9C%BA%E6%95%B0%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E5%80%BC%E5%9B%BA%E5%AE%9A"><span class="nav-number">22.6.</span> <span class="nav-text">随机数函数返回值固定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-Trace"><span class="nav-number">22.7.</span> <span class="nav-text">获取 Trace</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%B5%81"><span class="nav-number">22.8.</span> <span class="nav-text">获取函数调用流</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E5%86%85%E5%AD%98%E4%B8%AD%E6%90%9C%E7%B4%A2%E6%95%B0%E6%8D%AE%E5%87%BA%E7%8E%B0%E7%9A%84%E4%BD%8D%E7%BD%AE"><span class="nav-number">22.9.</span> <span class="nav-text">在内存中搜索数据出现的位置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#findCryptInTrace"><span class="nav-number">22.10.</span> <span class="nav-text">findCryptInTrace</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%88%B6unidng"><span class="nav-number">23.</span> <span class="nav-text">反制unidng</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80%E3%80%81JNI%E4%BA%A4%E4%BA%92"><span class="nav-number">23.0.1.</span> <span class="nav-text">一、JNI交互</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="nav-number">23.0.2.</span> <span class="nav-text">二、系统调用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE"><span class="nav-number">23.0.3.</span> <span class="nav-text">三、文件访问</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E6%A3%80%E6%B5%8BUnidbg"><span class="nav-number">23.0.4.</span> <span class="nav-text">四、检测Unidbg</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E7%9B%AE%E6%A0%87%E5%87%BD%E6%95%B0%E6%97%A0%E6%B3%95%E8%A2%AB%E5%8D%95%E7%8B%AC%E6%89%A7%E8%A1%8C"><span class="nav-number">23.0.5.</span> <span class="nav-text">五、目标函数无法被单独执行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E5%9C%A8%E7%9C%9F%E6%9C%BA%E4%B8%8A%E4%BD%BF%E7%94%A8GetStaticMethodID%E5%AF%BB%E6%89%BE%E4%B8%80%E4%B8%AA%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-number">23.0.6.</span> <span class="nav-text">六、在真机上使用GetStaticMethodID寻找一个不存在的方法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unidbg%E6%8A%A5%E9%94%99"><span class="nav-number">24.</span> <span class="nav-text">Unidbg报错</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Illegal-JNI-version"><span class="nav-number">24.1.</span> <span class="nav-text">Illegal JNI version</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#app%E5%BC%80%E5%8F%91%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E5%A4%B1%E8%AF%AF%EF%BC%8C%E9%87%8A%E6%94%BE%E5%8F%98%E9%87%8F%E5%90%8E%E8%BF%98%E8%B0%83%E7%94%A8"><span class="nav-number">24.2.</span> <span class="nav-text">app开发过程中的失误，释放变量后还调用</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="border-box website-info-box default">
        
            <div class="copyright-info info-item default">
                &copy;&nbsp;<span>2021</span>&nbsp;-&nbsp;2025
                
                    &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">zsk</a>
                
            </div>

            <div class="theme-info info-item default">
                由&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;驱动&nbsp;&&nbsp;主题&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
            </div>

            

            
                <div class="deploy-info info-item default">
                    
                        本站由 <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/deploy-provider/github.png"></span> 提供部署服务
                        
                </div>
            
        

        <div class="count-item info-item default">
            
                <span class="count-box border-box word">
                    <span class="item-type border-box">总字数</span>
                    <span class="item-value border-box word">138.2k</span>
                </span>
            

            
                <span class="count-box border-box uv">
                    <span class="item-type border-box">访客数</span>
                    <span class="item-value border-box uv" id="busuanzi_value_site_uv"></span>
                </span>
            

            
                <span class="count-box border-box pv">
                    <span class="item-type border-box">访问量</span>
                    <span class="item-value border-box pv" id="busuanzi_value_site_pv"></span>
                </span>
            
        </div>
    </div>
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="tools-list border-box">
        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        
            <li class="tools-item go-to-comments-tablet flex-center">
                <i class="fas fa-comment"></i>
            </li>
        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A1%A5%E7%8E%AF%E5%A2%83%E7%9A%84%E4%B8%89%E6%9D%A1%E5%87%86%E5%88%99"><span class="nav-number">1.</span> <span class="nav-text">补环境的三条准则</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95"><span class="nav-number">2.</span> <span class="nav-text">目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A1%86%E6%9E%B6"><span class="nav-number">3.</span> <span class="nav-text">基本框架</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AndroidEmulator"><span class="nav-number">4.</span> <span class="nav-text">AndroidEmulator</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#AndroidEmulator%E4%BB%8B%E7%BB%8D"><span class="nav-number">4.1.</span> <span class="nav-text">AndroidEmulator介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAAndroidEmulator%E5%AE%9E%E4%BE%8B"><span class="nav-number">4.2.</span> <span class="nav-text">创建AndroidEmulator实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AndroidEmulator%E6%93%8D%E4%BD%9C%E6%8E%A5%E5%8F%A3"><span class="nav-number">4.3.</span> <span class="nav-text">AndroidEmulator操作接口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#getMemory"><span class="nav-number">4.3.1.</span> <span class="nav-text">getMemory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getPid"><span class="nav-number">4.3.2.</span> <span class="nav-text">getPid</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#createDalvikVM"><span class="nav-number">4.3.3.</span> <span class="nav-text">createDalvikVM</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#loadLibrary"><span class="nav-number">4.3.4.</span> <span class="nav-text">loadLibrary</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getDalvikVM"><span class="nav-number">4.3.5.</span> <span class="nav-text">getDalvikVM</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#showRegs"><span class="nav-number">4.3.6.</span> <span class="nav-text">showRegs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getBackend"><span class="nav-number">4.3.7.</span> <span class="nav-text">getBackend</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getProcessName"><span class="nav-number">4.3.8.</span> <span class="nav-text">getProcessName</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getContext"><span class="nav-number">4.3.9.</span> <span class="nav-text">getContext</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#isRunning"><span class="nav-number">4.3.10.</span> <span class="nav-text">isRunning</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Trace"><span class="nav-number">4.3.11.</span> <span class="nav-text">Trace</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Set-x2F-Get"><span class="nav-number">4.3.12.</span> <span class="nav-text">Set&#x2F;Get</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SyscallHandler"><span class="nav-number">4.3.13.</span> <span class="nav-text">SyscallHandler</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Debugger"><span class="nav-number">4.3.14.</span> <span class="nav-text">Debugger</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#emulateSignal"><span class="nav-number">4.3.15.</span> <span class="nav-text">emulateSignal</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#disassemble"><span class="nav-number">4.3.16.</span> <span class="nav-text">disassemble</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#close"><span class="nav-number">4.3.17.</span> <span class="nav-text">close</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getUnwinder"><span class="nav-number">4.3.18.</span> <span class="nav-text">getUnwinder</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Memory"><span class="nav-number">5.</span> <span class="nav-text">Memory</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Memory%E4%BB%8B%E7%BB%8D"><span class="nav-number">5.1.</span> <span class="nav-text">Memory介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Memory%E6%93%8D%E4%BD%9C"><span class="nav-number">5.2.</span> <span class="nav-text">Memory操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96Memory%E5%AE%9E%E4%BE%8B"><span class="nav-number">5.2.1.</span> <span class="nav-text">获取Memory实例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#setLibraryResolver"><span class="nav-number">5.2.2.</span> <span class="nav-text">setLibraryResolver</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#findModule"><span class="nav-number">5.2.3.</span> <span class="nav-text">findModule</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#allocateStack"><span class="nav-number">5.2.4.</span> <span class="nav-text">allocateStack</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#malloc"><span class="nav-number">5.2.5.</span> <span class="nav-text">malloc</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#setErrno"><span class="nav-number">5.2.6.</span> <span class="nav-text">setErrno</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getStackPoint"><span class="nav-number">5.2.7.</span> <span class="nav-text">getStackPoint</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#disableCallInitFunction"><span class="nav-number">5.2.8.</span> <span class="nav-text">disableCallInitFunction</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getMemoryMap"><span class="nav-number">5.2.9.</span> <span class="nav-text">getMemoryMap</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pointer"><span class="nav-number">5.2.10.</span> <span class="nav-text">pointer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#addModuleListener"><span class="nav-number">5.2.11.</span> <span class="nav-text">addModuleListener</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#load"><span class="nav-number">5.2.12.</span> <span class="nav-text">load</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Memory%E6%80%BB%E7%BB%93"><span class="nav-number">5.3.</span> <span class="nav-text">Memory总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VM"><span class="nav-number">6.</span> <span class="nav-text">VM</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#VM%E4%BB%8B%E7%BB%8D"><span class="nav-number">6.1.</span> <span class="nav-text">VM介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VM%E5%88%9B%E5%BB%BA"><span class="nav-number">6.2.</span> <span class="nav-text">VM创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VM%E6%8E%A5%E5%8F%A3"><span class="nav-number">6.3.</span> <span class="nav-text">VM接口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E6%8E%A7%E5%88%B6"><span class="nav-number">6.3.1.</span> <span class="nav-text">日志控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AEJNI"><span class="nav-number">6.3.2.</span> <span class="nav-text">设置JNI</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E7%94%A8JNI-OnLoad%E5%87%BD%E6%95%B0"><span class="nav-number">6.3.3.</span> <span class="nav-text">调用JNI_OnLoad函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%A8%A1%E6%8B%9F%E5%99%A8%E5%AE%9E%E4%BE%8B"><span class="nav-number">6.3.4.</span> <span class="nav-text">获取模拟器实例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96APK%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF"><span class="nav-number">6.3.5.</span> <span class="nav-text">获取APK相关信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9D%97"><span class="nav-number">6.3.6.</span> <span class="nav-text">加载模块</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VM%E6%80%BB%E7%BB%93"><span class="nav-number">6.4.</span> <span class="nav-text">VM总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CallMethod"><span class="nav-number">7.</span> <span class="nav-text">CallMethod</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8CJNI%E5%87%BD%E6%95%B0"><span class="nav-number">7.1.</span> <span class="nav-text">执行JNI函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E4%BB%BB%E6%84%8F%E5%87%BD%E6%95%B0"><span class="nav-number">7.2.</span> <span class="nav-text">执行任意函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8Cmain%E5%87%BD%E6%95%B0"><span class="nav-number">7.3.</span> <span class="nav-text">执行main函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JNI%E6%96%B9%E6%B3%95%E5%B0%81%E8%A3%85"><span class="nav-number">7.4.</span> <span class="nav-text">JNI方法封装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#void"><span class="nav-number">7.4.1.</span> <span class="nav-text">void</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#boolean"><span class="nav-number">7.4.2.</span> <span class="nav-text">boolean</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#int"><span class="nav-number">7.4.3.</span> <span class="nav-text">int</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#long"><span class="nav-number">7.4.4.</span> <span class="nav-text">long</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#float"><span class="nav-number">7.4.5.</span> <span class="nav-text">float</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#double"><span class="nav-number">7.4.6.</span> <span class="nav-text">double</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E7%B1%BB%E5%9E%8B"><span class="nav-number">7.4.7.</span> <span class="nav-text">对象类型</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JNI%E6%96%B9%E6%B3%95%E7%AD%BE%E5%90%8D"><span class="nav-number">7.5.</span> <span class="nav-text">JNI方法签名</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hook"><span class="nav-number">8.</span> <span class="nav-text">Hook</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Hook%E4%BB%8B%E7%BB%8D"><span class="nav-number">8.1.</span> <span class="nav-text">Hook介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hook%E6%A1%86%E6%9E%B6%E5%88%86%E7%B1%BB"><span class="nav-number">8.2.</span> <span class="nav-text">Hook框架分类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#HookZz"><span class="nav-number">8.2.1.</span> <span class="nav-text">HookZz</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96HookZz%E5%AE%9E%E4%BE%8B"><span class="nav-number">8.2.1.1.</span> <span class="nav-text">获取HookZz实例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#HookZz-API"><span class="nav-number">8.2.1.2.</span> <span class="nav-text">HookZz API</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#wrap"><span class="nav-number">8.2.1.2.1.</span> <span class="nav-text">wrap</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#replace"><span class="nav-number">8.2.1.2.2.</span> <span class="nav-text">replace</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#instrument"><span class="nav-number">8.2.1.2.3.</span> <span class="nav-text">instrument</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Dobby"><span class="nav-number">8.2.2.</span> <span class="nav-text">Dobby</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96Dobby%E5%AE%9E%E4%BE%8B"><span class="nav-number">8.2.2.1.</span> <span class="nav-text">获取Dobby实例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Dobby-API"><span class="nav-number">8.2.2.2.</span> <span class="nav-text">Dobby API</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#replace-1"><span class="nav-number">8.2.2.2.1.</span> <span class="nav-text">replace</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#instrument-1"><span class="nav-number">8.2.2.2.2.</span> <span class="nav-text">instrument</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#xHook"><span class="nav-number">8.2.3.</span> <span class="nav-text">xHook</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96xHook%E5%AE%9E%E4%BE%8B"><span class="nav-number">8.2.3.1.</span> <span class="nav-text">获取xHook实例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#xHook-API"><span class="nav-number">8.2.3.2.</span> <span class="nav-text">xHook API</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#register"><span class="nav-number">8.2.3.2.1.</span> <span class="nav-text">register</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#refresh"><span class="nav-number">8.2.3.2.2.</span> <span class="nav-text">refresh</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Whale"><span class="nav-number">8.2.4.</span> <span class="nav-text">Whale</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96Whale%E5%AE%9E%E4%BE%8B"><span class="nav-number">8.2.4.1.</span> <span class="nav-text">获取Whale实例</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Whale-API"><span class="nav-number">8.2.4.2.</span> <span class="nav-text">Whale API</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%9F%E7%94%9Fhook"><span class="nav-number">8.2.5.</span> <span class="nav-text">原生hook</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#patch"><span class="nav-number">8.3.</span> <span class="nav-text">patch</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JNI"><span class="nav-number">9.</span> <span class="nav-text">JNI</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JNI%E4%BB%8B%E7%BB%8D"><span class="nav-number">9.1.</span> <span class="nav-text">JNI介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B1%BB-x2F-%E7%B1%BB%E5%9E%8B"><span class="nav-number">9.2.</span> <span class="nav-text">类&#x2F;类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1-x2F-%E5%AE%9E%E4%BE%8B"><span class="nav-number">9.3.</span> <span class="nav-text">对象&#x2F;实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8C%85%E8%A3%85%E5%AF%B9%E8%B1%A1"><span class="nav-number">9.4.</span> <span class="nav-text">包装对象</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#String"><span class="nav-number">9.4.1.</span> <span class="nav-text">String</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Array"><span class="nav-number">9.4.2.</span> <span class="nav-text">Array</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#List"><span class="nav-number">9.4.3.</span> <span class="nav-text">List</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Module"><span class="nav-number">10.</span> <span class="nav-text">Module</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Module%E4%BB%8B%E7%BB%8D"><span class="nav-number">10.1.</span> <span class="nav-text">Module介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Module%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="nav-number">10.2.</span> <span class="nav-text">Module常用的属性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#base"><span class="nav-number">10.2.1.</span> <span class="nav-text">base</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#name"><span class="nav-number">10.2.2.</span> <span class="nav-text">name</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#callEntry"><span class="nav-number">10.2.3.</span> <span class="nav-text">callEntry</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#findSymbolByName"><span class="nav-number">10.2.4.</span> <span class="nav-text">findSymbolByName</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Backend"><span class="nav-number">11.</span> <span class="nav-text">Backend</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Backend%E4%BB%8B%E7%BB%8D"><span class="nav-number">11.1.</span> <span class="nav-text">Backend介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Backend%E5%88%97%E8%A1%A8"><span class="nav-number">11.2.</span> <span class="nav-text">Backend列表</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Unicorn-x2F-Unicorn2"><span class="nav-number">11.2.1.</span> <span class="nav-text">Unicorn&#x2F;Unicorn2</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Unicorn2%E5%90%8E%E7%AB%AF"><span class="nav-number">11.2.1.1.</span> <span class="nav-text">使用Unicorn2后端:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Unicorn%E5%90%8E%E7%AB%AF%E7%89%B9%E7%82%B9"><span class="nav-number">11.2.1.2.</span> <span class="nav-text">Unicorn后端特点</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Dynarmic"><span class="nav-number">11.2.2.</span> <span class="nav-text">Dynarmic</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Dynarmic%E5%90%8E%E7%AB%AF"><span class="nav-number">11.2.2.1.</span> <span class="nav-text">使用Dynarmic后端</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Dynarmic%E5%90%8E%E7%AB%AF%E7%89%B9%E7%82%B9"><span class="nav-number">11.2.2.2.</span> <span class="nav-text">Dynarmic后端特点</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hypervisor"><span class="nav-number">11.2.3.</span> <span class="nav-text">Hypervisor</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Hypervisor%E5%90%8E%E7%AB%AF"><span class="nav-number">11.2.3.1.</span> <span class="nav-text">使用Hypervisor后端</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Hypervisor%E5%90%8E%E7%AB%AF%E7%89%B9%E7%82%B9"><span class="nav-number">11.2.3.2.</span> <span class="nav-text">Hypervisor后端特点</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Kvm"><span class="nav-number">11.2.4.</span> <span class="nav-text">Kvm</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Kvm%E5%90%8E%E7%AB%AF"><span class="nav-number">11.2.4.1.</span> <span class="nav-text">使用Kvm后端</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Kvm%E5%90%8E%E7%AB%AF%E7%89%B9%E7%82%B9"><span class="nav-number">11.2.4.2.</span> <span class="nav-text">Kvm后端特点</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Backend%E6%8E%A5%E5%8F%A3"><span class="nav-number">11.3.</span> <span class="nav-text">Backend接口</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Deggbuer"><span class="nav-number">12.</span> <span class="nav-text">Deggbuer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Debugger%E4%BB%8B%E7%BB%8D"><span class="nav-number">12.1.</span> <span class="nav-text">Debugger介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConsoleDebugger"><span class="nav-number">12.2.</span> <span class="nav-text">ConsoleDebugger</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4"><span class="nav-number">12.2.1.</span> <span class="nav-text">使用步骤</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AC%AC%E9%9B%B6%E6%AD%A5"><span class="nav-number">12.2.1.1.</span> <span class="nav-text">第零步</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5"><span class="nav-number">12.2.1.2.</span> <span class="nav-text">第一步</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5"><span class="nav-number">12.2.1.3.</span> <span class="nav-text">第二步</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5"><span class="nav-number">12.2.1.4.</span> <span class="nav-text">第三步</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E6%8C%87%E4%BB%A4"><span class="nav-number">12.2.2.</span> <span class="nav-text">调试指令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#help"><span class="nav-number">12.2.2.1.</span> <span class="nav-text">help</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#shr"><span class="nav-number">12.2.3.</span> <span class="nav-text">shr</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#show-disassemble"><span class="nav-number">12.2.3.1.</span> <span class="nav-text">show disassemble</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#continue"><span class="nav-number">12.2.3.2.</span> <span class="nav-text">continue</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#step-over"><span class="nav-number">12.2.3.3.</span> <span class="nav-text">step over</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#step-into"><span class="nav-number">12.2.3.4.</span> <span class="nav-text">step into</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#next-block"><span class="nav-number">12.2.3.5.</span> <span class="nav-text">next block</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b"><span class="nav-number">12.2.3.6.</span> <span class="nav-text">b</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#r"><span class="nav-number">12.2.3.7.</span> <span class="nav-text">r</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#blr"><span class="nav-number">12.2.3.8.</span> <span class="nav-text">blr</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#vbs"><span class="nav-number">12.2.3.9.</span> <span class="nav-text">vbs</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#back-trace"><span class="nav-number">12.2.3.10.</span> <span class="nav-text">back trace</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#show-memory"><span class="nav-number">12.2.3.11.</span> <span class="nav-text">show memory</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write-memory"><span class="nav-number">12.2.3.12.</span> <span class="nav-text">write memory</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#search-stack"><span class="nav-number">12.2.3.13.</span> <span class="nav-text">search stack</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#search-writable-heap"><span class="nav-number">12.2.3.14.</span> <span class="nav-text">search writable heap</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#search-readable-heap"><span class="nav-number">12.2.3.15.</span> <span class="nav-text">search readable heap</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#search-executable-heap"><span class="nav-number">12.2.3.16.</span> <span class="nav-text">search executable heap</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#where"><span class="nav-number">12.2.3.17.</span> <span class="nav-text">where</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#vm"><span class="nav-number">12.2.3.18.</span> <span class="nav-text">vm</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#stop"><span class="nav-number">12.2.3.19.</span> <span class="nav-text">stop</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#patch-1"><span class="nav-number">12.2.3.20.</span> <span class="nav-text">patch</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#trace"><span class="nav-number">12.2.3.21.</span> <span class="nav-text">trace</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GDB-SERVER"><span class="nav-number">12.3.</span> <span class="nav-text">GDB_SERVER</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ANDROID-SERVER-V7"><span class="nav-number">12.4.</span> <span class="nav-text">ANDROID_SERVER_V7</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Block"><span class="nav-number">12.5.</span> <span class="nav-text">Block</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RegisterContext"><span class="nav-number">13.</span> <span class="nav-text">RegisterContext</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SyscallHandler-1"><span class="nav-number">14.</span> <span class="nav-text">SyscallHandler</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SyscallHandler%E4%BB%8B%E7%BB%8D"><span class="nav-number">14.1.</span> <span class="nav-text">SyscallHandler介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#API"><span class="nav-number">14.2.</span> <span class="nav-text">API</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96SyscallHandler%E5%AE%9E%E4%BE%8B"><span class="nav-number">14.2.1.</span> <span class="nav-text">获取SyscallHandler实例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#setVerbose"><span class="nav-number">14.2.2.</span> <span class="nav-text">setVerbose</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#addIOResolver"><span class="nav-number">14.2.3.</span> <span class="nav-text">addIOResolver</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#setEnableThreadDispatcher"><span class="nav-number">14.2.4.</span> <span class="nav-text">setEnableThreadDispatcher</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#setFileListener"><span class="nav-number">14.2.5.</span> <span class="nav-text">setFileListener</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#getFileIO"><span class="nav-number">14.2.6.</span> <span class="nav-text">getFileIO</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%A4%84%E7%90%86%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="nav-number">14.3.</span> <span class="nav-text">自处理系统调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FileResult"><span class="nav-number">14.4.</span> <span class="nav-text">FileResult</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#success"><span class="nav-number">14.4.1.</span> <span class="nav-text">success</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#failed"><span class="nav-number">14.4.2.</span> <span class="nav-text">failed</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fallback"><span class="nav-number">14.4.3.</span> <span class="nav-text">fallback</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#VirtualModule"><span class="nav-number">15.</span> <span class="nav-text">VirtualModule</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#VirtualModulem%E4%BB%8B%E7%BB%8D"><span class="nav-number">15.1.</span> <span class="nav-text">VirtualModulem介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#unidbg%E8%87%AA%E5%B8%A6%E8%99%9A%E6%8B%9F%E6%A8%A1%E5%9D%97"><span class="nav-number">15.2.</span> <span class="nav-text">unidbg自带虚拟模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%99%9A%E6%8B%9F%E6%A8%A1%E5%9D%97"><span class="nav-number">15.3.</span> <span class="nav-text">自定义虚拟模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A8%A1%E6%8B%9F%E5%9C%BA%E6%99%AF"><span class="nav-number">15.3.1.</span> <span class="nav-text">模拟场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A6%96%E6%AC%A1%E5%B0%9D%E8%AF%95"><span class="nav-number">15.3.2.</span> <span class="nav-text">首次尝试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%84%E7%90%86%E9%97%AE%E9%A2%98"><span class="nav-number">15.3.3.</span> <span class="nav-text">处理问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="nav-number">15.3.4.</span> <span class="nav-text">完整代码</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Jnitrace"><span class="nav-number">16.</span> <span class="nav-text">Jnitrace</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-number">16.1.</span> <span class="nav-text">使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jnitrace%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E8%BF%94%E5%9B%9E%E7%9A%84%E6%98%AF%E5%9C%B0%E5%9D%80%E7%9A%84%E6%97%B6%E5%80%99"><span class="nav-number">16.2.</span> <span class="nav-text">jnitrace函数调用返回的是地址的时候</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A0%86%E6%A0%88%E6%A3%80%E6%B5%8B"><span class="nav-number">16.3.</span> <span class="nav-text">堆栈检测</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%A8%E8%8D%90%E4%BD%BF%E7%94%A8objection%E6%9F%A5%E7%9C%8B%E5%A0%86%E6%A0%88"><span class="nav-number">16.3.1.</span> <span class="nav-text">推荐使用objection查看堆栈</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="nav-number">17.</span> <span class="nav-text">函数调用两种方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%A6%E5%8F%B7%E8%B0%83%E7%94%A8"><span class="nav-number">17.1.</span> <span class="nav-text">符号调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%B0%E5%9D%80%E8%B0%83%E7%94%A8"><span class="nav-number">17.2.</span> <span class="nav-text">地址调用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E7%B1%BB%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="nav-number">18.</span> <span class="nav-text">构建类的两种方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B1%BB%E7%BB%A7%E6%89%BF%E7%9A%84%E5%86%99%E6%B3%95"><span class="nav-number">19.</span> <span class="nav-text">类继承的写法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unidbg%E8%A1%A5%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E5%B1%9E%E6%80%A7"><span class="nav-number">20.</span> <span class="nav-text">unidbg补获取系统属性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E9%87%8D%E5%AE%9A%E5%90%91%EF%BC%8C%E5%AE%9E%E7%8E%B0-IOResolver"><span class="nav-number">21.</span> <span class="nav-text">文件重定向，实现 IOResolver</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E4%BA%9B%E5%B8%B8%E7%94%A8%E5%8A%9F%E8%83%BD"><span class="nav-number">22.</span> <span class="nav-text">一些常用功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E5%8D%B0%E5%86%85%E5%AD%98%EF%BC%8Chexdump"><span class="nav-number">22.1.</span> <span class="nav-text">打印内存，hexdump</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#unidbg%E4%B8%8B%E6%96%AD%E7%82%B9"><span class="nav-number">22.2.</span> <span class="nav-text">unidbg下断点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%90%AF%E6%89%80%E6%9C%89%E7%9A%84%E6%97%A5%E5%BF%97"><span class="nav-number">22.3.</span> <span class="nav-text">开启所有的日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E6%B1%87%E7%BC%96%E7%9A%84%E8%A1%8C%E6%95%B0"><span class="nav-number">22.4.</span> <span class="nav-text">计算汇编的行数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E5%8D%B0%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E5%80%BC%E6%88%96%E4%BF%AE%E6%94%B9%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="nav-number">22.5.</span> <span class="nav-text">打印函数返回值或修改返回值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9A%8F%E6%9C%BA%E6%95%B0%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E5%80%BC%E5%9B%BA%E5%AE%9A"><span class="nav-number">22.6.</span> <span class="nav-text">随机数函数返回值固定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-Trace"><span class="nav-number">22.7.</span> <span class="nav-text">获取 Trace</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%B5%81"><span class="nav-number">22.8.</span> <span class="nav-text">获取函数调用流</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E5%86%85%E5%AD%98%E4%B8%AD%E6%90%9C%E7%B4%A2%E6%95%B0%E6%8D%AE%E5%87%BA%E7%8E%B0%E7%9A%84%E4%BD%8D%E7%BD%AE"><span class="nav-number">22.9.</span> <span class="nav-text">在内存中搜索数据出现的位置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#findCryptInTrace"><span class="nav-number">22.10.</span> <span class="nav-text">findCryptInTrace</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%88%B6unidng"><span class="nav-number">23.</span> <span class="nav-text">反制unidng</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80%E3%80%81JNI%E4%BA%A4%E4%BA%92"><span class="nav-number">23.0.1.</span> <span class="nav-text">一、JNI交互</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="nav-number">23.0.2.</span> <span class="nav-text">二、系统调用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE"><span class="nav-number">23.0.3.</span> <span class="nav-text">三、文件访问</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E6%A3%80%E6%B5%8BUnidbg"><span class="nav-number">23.0.4.</span> <span class="nav-text">四、检测Unidbg</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E7%9B%AE%E6%A0%87%E5%87%BD%E6%95%B0%E6%97%A0%E6%B3%95%E8%A2%AB%E5%8D%95%E7%8B%AC%E6%89%A7%E8%A1%8C"><span class="nav-number">23.0.5.</span> <span class="nav-text">五、目标函数无法被单独执行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E5%9C%A8%E7%9C%9F%E6%9C%BA%E4%B8%8A%E4%BD%BF%E7%94%A8GetStaticMethodID%E5%AF%BB%E6%89%BE%E4%B8%80%E4%B8%AA%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E6%96%B9%E6%B3%95"><span class="nav-number">23.0.6.</span> <span class="nav-text">六、在真机上使用GetStaticMethodID寻找一个不存在的方法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unidbg%E6%8A%A5%E9%94%99"><span class="nav-number">24.</span> <span class="nav-text">Unidbg报错</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Illegal-JNI-version"><span class="nav-number">24.1.</span> <span class="nav-text">Illegal JNI version</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#app%E5%BC%80%E5%8F%91%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E5%A4%B1%E8%AF%AF%EF%BC%8C%E9%87%8A%E6%94%BE%E5%8F%98%E9%87%8F%E5%90%8E%E8%BF%98%E8%B0%83%E7%94%A8"><span class="nav-number">24.2.</span> <span class="nav-text">app开发过程中的失误，释放变量后还调用</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>



<!-- common -->
<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.8.1/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.8.1/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.8.1/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.8.1/source/js/dark-light-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.8.1/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.8.1/source/js/libs/anime.min.js"></script>

<!-- local-search -->

    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.8.1/source/js/local-search.js"></script>


<!-- code-block -->

    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.8.1/source/js/code-block.js"></script>


<!-- lazyload -->

    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.8.1/source/js/lazyload.js"></script>


<div class="pjax">
    
        <!-- post-helper -->
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.8.1/source/js/post/post-helper.js"></script>

        <!-- toc -->
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.8.1/source/js/post/toc.js"></script>
        

        <!-- copyright-info -->
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.8.1/source/js/post/copyright-info.js"></script>
        

        <!-- share -->
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.8.1/source/js/post/share.js"></script>
        
    

    <!-- category-page -->
    

    <!-- links-page -->
    
</div>

<!-- pjax -->

    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.8.1/source/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart()
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd()
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'))
            KEEP.initExecute()
        });
    });
</script>




    
        
    
        
            
<script class="custom-inject-js" src="/js/custom-1.js" data-pjax></script>

        
    

</body>
</html>
