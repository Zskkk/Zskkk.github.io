<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="zsk">
    
    <meta name="baidu-site-verification" content="codeva-FDuSf8Qgto" />
    

    
    <title>
        
            App解固脱壳方式 |
        
        zskのblog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/head.svg">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/fontawesome/css/fontawesome.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/fontawesome/css/regular.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/fontawesome/css/solid.min.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/fontawesome/css/brands.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"www.zskkk.cn","root":"/","language":"zh-CN","path":"search.xml"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066cc","logo":"/images/head.svg","favicon":"/images/head.svg","avatar":"/images/head.svg","font_size":null,"font_family":null,"hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"header_transparent":true,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving.","font_color":null,"hitokoto":true},"scroll":{"progress_bar":true,"percent":true}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"mac"},"code_block":{"tools":{"enable":false,"style":"mac"},"highlight_theme":"obsidian"},"side_tools":{},"pjax":{"enable":false},"lazyload":{"enable":true},"comment":{"enable":true,"use":"valine","valine":{"appid":"WxNQs5QEQtykF82Sb7nAjXRO-gzGzoHsz","appkey":"4rZ6NwH5zAu6VEspHwVrgqOq","placeholder":"😜 尽情吐槽吧~"},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.7"},"waline":{"server_url":null,"reaction":false,"version":2}},"post":{"author_label":{"enable":true,"auto":true,"custom_label_list":["Trainee","Engineer","Architect"]},"word_count":{"enable":true,"wordcount":true,"min2read":true},"img_align":"left","copyright_info":true},"version":"3.5.2"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"};
  </script>

<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="/images/head.svg">
                </a>
            
            <a class="logo-title" href="/">
               zskのblog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                关于
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">关于</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="post-page-container">
        <div class="article-content-container">
            <div class="article-title">
                <span class="title-hover-animation">App解固脱壳方式</span>
            </div>
            
                <div class="article-header">
                    <div class="avatar">
                        <img src="/images/head.svg">
                    </div>
					
                    <div class="info">
                        <div class="author">
                            <span class="name">zsk</span>
                            
                                <span class="author-label">Lv4</span>
                            
                        </div>
                        <div class="meta-info">
                            
<div class="article-meta-info">
    <span class="article-date article-meta-item">
        
            <i class="fa-regular fa-calendar-plus"></i>&nbsp;
        
        <span class="pc">2020-10-29 00:00:00</span>
        <span class="mobile">2020-10-29 00:00</span>
    </span>
    
        <span class="article-update-date article-meta-item">
        <i class="fas fa-file-pen"></i>&nbsp;
        <span class="pc">2020-10-29 00:00:00</span>
    </span>
    
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E8%84%B1%E5%A3%B3/">脱壳</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>2.5k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>10 分钟</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
	
	
</div>

                        </div>
                    </div>
                </div>
            

            <div class="article-content keep-markdown-body">
                <p><a class="link"   target="_blank" rel="noopener" href="https://www.yuque.com/attachments/yuque/0/2020/zip/2721723/1603962732264-00bfe3f5-1985-44fa-8c02-31050a671665.zip?from=https://www.yuque.com/gongguoshuiwen/whieq5/gceigp%23OJEdd" >样例app下载链接<i class="fas fa-external-link-alt"></i></a></p>
<h2 id="一、常见的壳"><a href="#一、常见的壳" class="headerlink" title="一、常见的壳"></a>一、常见的壳</h2><p>通常是看lib文件夹下so库特征，以下是市面上常见的不同厂商对APP的加固特征：<br />爱加密：libexec.so,libexecmain.so，ijiami.dat <br />梆梆： libsecexe.so,libsecmain.so , libDexHelper.so libSecShell.so<br />360：libprotectClass.so,libjiagu.so，libjiagu_art.so，libjiagu_x86.so <br />百度：libbaiduprotect.so <br />腾讯：libshellx-2.10.6.0.so，libBugly.so，libtup.so, libexec.so，libshell.so，stub_tengxun <br />网易易盾：libnesec.so<br />为什么要加固：<br />     一定程度保护源代码<br />加固方式：<br />    .dex加固 .so加固 </p>
<h2 id="二、加固原理"><a href="#二、加固原理" class="headerlink" title="二、加固原理"></a>二、加固原理</h2><p>壳dex 读取源dex文件，加密后，写进一个新的dex文件<br /><br><img  
                     lazyload
                     alt="image"
                     data-src="https://github.com/Zskkk/blog-images/raw/master/20201029/01.webp"
                     
                ></p>
<p><br />新APK运行 <br />先加载壳APP—&gt;壳APP读Dex文件末尾的源APKD大小—-&gt;在内存中壳APP解密出源APP—&gt;运行源APP 壳APK有自己的Application对象 <br />源APK有自己的Application对象 <br />壳APK启动时 在AndroidMenifest.xml里找源APK的Application 执行它的oncreate方法 启动源APK <br />Dex文件格式：  任何类型的文件都有文件格式，对应的软件按照文件格式来就能解析出类型，.xml .json .jpeg<br /><br><img  
                     lazyload
                     alt="image"
                     data-src="https://github.com/Zskkk/blog-images/raw/master/20201029/02.webp"
                     
                ></p>
<h2 id="三、如何查看有没有壳"><a href="#三、如何查看有没有壳" class="headerlink" title="三、如何查看有没有壳"></a>三、如何查看有没有壳</h2><p>用<code>apktool</code>对apk进行反编译，或者修改apk的后缀为zip，进行解压。查看解压后的文件下的lib目录，<br /><br><img  
                     lazyload
                     alt="image"
                     data-src="https://github.com/Zskkk/blog-images/raw/master/20201029/03.webp"
                     
                ><br><br />可以看到这两个是用了腾讯的乐加固，或者我们不确定的话可以用jadx打开apk，也是可以发现的<br /><br><img  
                     lazyload
                     alt="image"
                     data-src="https://github.com/Zskkk/blog-images/raw/master/20201029/04.webp"
                     
                ><br><br />都是壳的代码。不过即使怎么加壳，它都会去调源apk的Application，打开<code>AndroidManifest.xml</code>文件，<br /><br><img  
                     lazyload
                     alt="image"
                     data-src="https://github.com/Zskkk/blog-images/raw/master/20201029/05.webp"
                     
                ><br><br />可以看到，上面一个是壳的，下面是源apk的Application。<br />逆向&#x2F;脱壳方法 <br />反编译&#x2F;Hook技术和动态调试 <br />Hook：先取得要Hook函数&#x2F;方法的控制权，不用破坏程序 <br />动态调试：反调试，汇编，计算内存地址</p>
<h2 id="四、Hook技术"><a href="#四、Hook技术" class="headerlink" title="四、Hook技术"></a>四、Hook技术</h2><p>改变程序执行流程的一种技术 在函数被调用前，通过HOOK技术，先得到该函数的控制权，实现该函数的逻辑改写<br /><br><img  
                     lazyload
                     alt="image"
                     data-src="https://github.com/Zskkk/blog-images/raw/master/20201029/06.webp"
                     
                ><br />Hook可以在在Java层、Native层（.so库） <br />在代码层 寻找要Hook的地方 进行Hook 改下代码逻辑</p>
<h2 id="五、脱壳工具"><a href="#五、脱壳工具" class="headerlink" title="五、脱壳工具"></a>五、脱壳工具</h2><p><strong>脱壳原理：</strong><br>在壳APK解密源APK后，源APK被加载前，拦截这个过程中的系统函数 把内存种Dex dump出来。<br /></p>
<p><strong>手动脱壳：</strong><br>通过动态调试，跟踪计算Dex源文件的内存偏移地址，从内存中Dump出Dex文件 ，难度大，寄存器，汇编，反调试，反读写  IDA。<br /></p>
<p><strong>工具脱壳：</strong><br />    HOOK技术&#x2F;内存特征寻找  简单易操作  <br /></p>
<p><strong>基于xposed 脱壳工具</strong>：  <br />        Fdex2：Hook ClassLoader loadClass方法 <br />        通用脱壳  dumpDex：<a class="link"   target="_blank" rel="noopener" href="https://github.com/WrBug/dumpDex" >https://github.com/WrBug/dumpDex<i class="fas fa-external-link-alt"></i></a><br /><strong>逆向框架：</strong> 筑好底层 提供开发接口<br /><strong>xposed</strong>（Java 编译，只能在java层）  <br /><strong>frida</strong>（Python Javascript 代码注入，可以hook住java层、Native层） </p>
<h2 id="六、开始脱壳（用FDex2脱壳）"><a href="#六、开始脱壳（用FDex2脱壳）" class="headerlink" title="六、开始脱壳（用FDex2脱壳）"></a>六、开始脱壳（用FDex2脱壳）</h2><p>首先我们打开<strong>xposed，</strong>把FDex2打开，并选择我们要的app<br /><br><img  
                     lazyload
                     alt="image"
                     data-src="https://github.com/Zskkk/blog-images/raw/master/20201029/07.webp"
                     
                ><br /><br><img  
                     lazyload
                     alt="image"
                     data-src="https://github.com/Zskkk/blog-images/raw/master/20201029/08.webp"
                     
                ><br />接下来就可以运行app，然后我们去<code>/data/user/0/com.iCitySuzhou.suzhou001</code>该目录下查看，多出来两个dex文件<br /><br><img  
                     lazyload
                     alt="image"
                     data-src="https://github.com/Zskkk/blog-images/raw/master/20201029/09.webp"
                     
                ><br><br />把这两个文件拉到电脑用kadx打开，第一个是壳<br /><br><img  
                     lazyload
                     alt="image"
                     data-src="https://github.com/Zskkk/blog-images/raw/master/20201029/10.webp"
                     
                ><br><br />打开第二个很明显看到这才是源apk的源码，而且可以发现它对源码进行混淆了<br /><br><img  
                     lazyload
                     alt="image"
                     data-src="https://github.com/Zskkk/blog-images/raw/master/20201029/11.webp"
                     
                ><br><br />所以到这里我们的脱壳就成功了。</p>
<h2 id="七、开始脱壳（用Frida脱壳）"><a href="#七、开始脱壳（用Frida脱壳）" class="headerlink" title="七、开始脱壳（用Frida脱壳）"></a>七、开始脱壳（用Frida脱壳）</h2><h3 id="Frida脱壳"><a href="#Frida脱壳" class="headerlink" title="Frida脱壳"></a>Frida脱壳</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">function_address = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(libname, <span class="keyword">function</span>);</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(address, func);</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(address,</span><br><span class="line"> <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line"> &#125;,</span><br><span class="line"> <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line"> &#125;</span><br><span class="line">)</span><br><span class="line"><span class="title class_">File</span> 模块 写文件流程</span><br><span class="line"> <span class="keyword">new</span> <span class="title class_">File</span>(filepath, mode)</span><br><span class="line"> <span class="title function_">write</span>(data)</span><br><span class="line"> <span class="title function_">flush</span>()</span><br><span class="line"> <span class="title function_">close</span>()</span><br><span class="line">file = <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;yuanrenxue.dex&quot;</span>, <span class="string">&quot;wb&quot;</span>)</span><br><span class="line"><span class="comment">//data 是字符串或者 arrayBuffer // readByteArray() 返回的arrayBuffer</span></span><br><span class="line">file.<span class="title function_">write</span>(data)</span><br><span class="line">file.<span class="title function_">flush</span>()</span><br><span class="line">file.<span class="title function_">close</span>()</span><br><span class="line"><span class="comment">//把内存里的值转成字符串</span></span><br><span class="line"><span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>()</span><br><span class="line"><span class="comment">//把内存里的值转换成整型</span></span><br><span class="line"><span class="title class_">Memory</span>.<span class="title function_">readInt</span>()</span><br><span class="line"><span class="comment">//以begin为起始位置，从内存中读length长度的数据出来 返回ArrayBuffer类型</span></span><br><span class="line"><span class="title class_">Memory</span>.<span class="title function_">readByteArray</span>(begin, length)</span><br><span class="line"><span class="comment">//把地址转换成NativePointer类型 frida里操作内存地址需要NativePointer类型</span></span><br><span class="line"><span class="title function_">ptr</span>()</span><br><span class="line"><span class="variable constant_">JS</span> api</span><br><span class="line">#把其它进制转换成<span class="number">10</span>进制</span><br><span class="line"><span class="built_in">parseInt</span>(num, radix)</span><br></pre></td></tr></table></figure>
<p>加壳apk运行流程：app启动后–&gt;壳dex先加载起来–&gt;把源classes.dex读出来–&gt;解密源classes.dex–&gt;把源classes.dex给加载进内存–&gt;源dex运行起来<br />下两篇文章都对dex进行了详解<br />Dex文件格式详解 <a class="link"   target="_blank" rel="noopener" href="https://www.jianshu.com/p/f7f0a712ddfe" >https://www.jianshu.com/p/f7f0a712ddfe<i class="fas fa-external-link-alt"></i></a><br />ART 加载dex文件 <a class="link"   target="_blank" rel="noopener" href="https://www.jianshu.com/p/f81242ad8cb7" >https://www.jianshu.com/p/f81242ad8cb7<i class="fas fa-external-link-alt"></i></a></p>
<h3 id="dex文件结构"><a href="#dex文件结构" class="headerlink" title="dex文件结构"></a>dex文件结构</h3><table>
<thead>
<tr>
<th><strong>数据名称</strong></th>
<th><strong>解释</strong></th>
</tr>
</thead>
<tbody><tr>
<td>header</td>
<td>dex文件头部，记录整个dex文件的相关属性</td>
</tr>
<tr>
<td>string_ids</td>
<td>字符串数据索引，记录了每个字符串在数据区的偏移量</td>
</tr>
<tr>
<td>type_ids</td>
<td>类似数据索引，记录了每个类型的字符串索引</td>
</tr>
<tr>
<td>proto_ids</td>
<td>原型数据索引，记录了方法声明的字符串，返回类型字符串，参数列表</td>
</tr>
<tr>
<td>field_ids</td>
<td>字段数据索引，记录了所属类，类型以及方法名</td>
</tr>
<tr>
<td>method_ids</td>
<td>类方法索引，记录方法所属类名，方法声明以及方法名等信息</td>
</tr>
<tr>
<td>class_defs</td>
<td>类定义数据索引，记录指定类各类信息，包括接口，超类，类数据偏移量</td>
</tr>
<tr>
<td>data</td>
<td>数据区，保存了各个类的真是数据</td>
</tr>
<tr>
<td>link_data</td>
<td>连接数据区</td>
</tr>
</tbody></table>
<h3 id="header"><a href="#header" class="headerlink" title="header"></a>header</h3><p>简单记录了dex文件的一些基本信息，以及大致的数据分布。长度固定为0x70,其中每一项信息所占用的内存空间也是固定的，好处是虚拟机在处理dex时不用考虑dex文件的多样性</p>
<table>
<thead>
<tr>
<th align="center"><strong>字段名称</strong></th>
<th align="center"><strong>偏移值</strong></th>
<th align="center"><strong>长度</strong></th>
<th align="center"><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">magic</td>
<td align="center">0x0</td>
<td align="center">8</td>
<td align="center">魔数字段，值为”dex\</td>
</tr>
<tr>
<td align="center">035\0”（固定的）</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">checksum</td>
<td align="center">0x8</td>
<td align="center">4</td>
<td align="center">校验码</td>
</tr>
<tr>
<td align="center">signature</td>
<td align="center">0xc</td>
<td align="center">20</td>
<td align="center">sha-1签名</td>
</tr>
<tr>
<td align="center">file_size</td>
<td align="center">0x20</td>
<td align="center">4</td>
<td align="center">dex文件总长度</td>
</tr>
<tr>
<td align="center">……</td>
<td align="center">……</td>
<td align="center">…..</td>
<td align="center">……</td>
</tr>
</tbody></table>
<p>字段太多就不都展示出来，可以看到<code>file_size</code>这个就是我们要找的dex文件,因为源dex解密后会加载进内存，所以我们去Hook加载Dex的函数，把Dex从内存中dump出来。<br />下面这个函数就是把解密后的源dex加载进内存：<br />DexFile::OpenMemory(const uint8_t* base,<br />   size_t size,<br />   const std::string&amp; location, <br />   uint32_t location_checksum, <br />   MemMap* mem_map,&#x2F;&#x2F;nullptr const OatDexFile* oat_dex_file, <br />   std::string* error_msg)<br />OpenMemory()是在安卓系统<code>/system/lib/libart.so</code>里面，然后我们先把这个so文件拉到电脑用IDA打开<br /><br><img  
                     lazyload
                     alt="image"
                     data-src="https://github.com/Zskkk/blog-images/raw/master/20201029/12.webp"
                     
                ><br><br />打开IDA选择静态调试，打开libart.so这个文件<br><br /><br><img  
                     lazyload
                     alt="image"
                     data-src="https://github.com/Zskkk/blog-images/raw/master/20201029/13.webp"
                     
                ><br><img  
                     lazyload
                     alt="image"
                     data-src="https://github.com/Zskkk/blog-images/raw/master/20201029/14.webp"
                     
                ><br><br />这些就是so文件里面的函数，点击这个框，按ctrl+f进行搜索，输入OpenMemory这个函数，右键进行编辑，<br /><code>_ZN3art7DexFile10OpenMemoryEPKhjRKNSt3__112basic_stringIcNS3_11char_traitsIcEENS3_9allocatorIcEEEEjPNS_6MemMapEPKNS_10OatDexFileEPS9_</code><br />这个字符串就是OpenMemory函数在内存中对外的方法名，我们打开IDA就是为了找这个方法名。<br /><br><img  
                     lazyload
                     alt="image"
                     data-src="https://github.com/Zskkk/blog-images/raw/master/20201029/15.webp"
                     
                ></p>
<p>现在来写脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">package = <span class="string">&quot;com.iCitySuzhou.suzhou001&quot;</span></span><br><span class="line"></span><br><span class="line">open_memory_6 = <span class="string">&quot;_ZN3art7DexFile10OpenMemoryEPKhjRKNSt3__112basic_stringIcNS3_11char_traitsIcEENS3_9allocatorIcEEEEjPNS_6MemMapEPKNS_10OatDexFileEPS9_&quot;</span></span><br><span class="line"><span class="comment">#OpenMemory 在libart.so中  art虚拟机(安卓5)  davlink虚拟机（安卓4）</span></span><br><span class="line"><span class="comment">#Hook OpenMemory的导出方法名</span></span><br><span class="line"><span class="comment">#用IDA 打开libart.so 查看OpenMemory的导出方法名</span></span><br><span class="line"><span class="comment">#OpenMemory的第一个参数是dex文件在内存中的起始位置</span></span><br><span class="line"><span class="comment">#根据dex文件格式 从起始位置开始 第32个字节 是该dex文件的大小</span></span><br><span class="line"><span class="comment">#知道dex起始位置和整个文件大小，只需要把这段内存dum出来即可</span></span><br><span class="line"><span class="comment">#适用于 安卓 6 7 8 9</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#文件的起始位置 文件的大小 知道了文件的结束位置</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_message</span>(<span class="params">message, data</span>):</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(message[<span class="string">&#x27;payload&#x27;</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">src = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">//找so文件某个方法地址，找openMemory的内存地址</span></span><br><span class="line"><span class="string">var openMemory_address = Module.findExportByName(&quot;libart.so&quot;, &quot;_ZN3art7DexFile10OpenMemoryEPKhjRKNSt3__112basic_stringIcNS3_11char_traitsIcEENS3_9allocatorIcEEEEjPNS_6MemMapEPKNS_10OatDexFileEPS9_&quot;);</span></span><br><span class="line"><span class="string">send(&#x27;openMemory address:&#x27;+openMemory_address)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//hook openMemory地址</span></span><br><span class="line"><span class="string">Interceptor.attach(openMemory_address, &#123;</span></span><br><span class="line"><span class="string">    //一进入openMemory，就会调用onEnter方法</span></span><br><span class="line"><span class="string">    onEnter: function (args) &#123;</span></span><br><span class="line"><span class="string">        //dex文件的起始位置</span></span><br><span class="line"><span class="string">        var dex_begin_address = args[1]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        //dex文件的前8个字节是magic字段 看dex的文件格式说明</span></span><br><span class="line"><span class="string">        //打印magic（会显示 &quot;dex 035&quot;） 三个字符 可以验证是否为dex文件 </span></span><br><span class="line"><span class="string">        console.log(&quot;magic : &quot; + Memory.readUtf8String(dex_begin_address))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        //把地址转换成整型（十进制） 再加32 </span></span><br><span class="line"><span class="string">        //因为dex文件的第32个字节处存放的是 dex文件的大小</span></span><br><span class="line"><span class="string">        var address = parseInt(dex_begin_address, 16) + 0x20</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        //把address地址指向的内存值读出来 该值就是dex的文件大小</span></span><br><span class="line"><span class="string">        //ptr(address)转换的原因是 frida只接受 NativePointer类型指针</span></span><br><span class="line"><span class="string">        var dex_size = Memory.readInt(ptr(address))</span></span><br><span class="line"><span class="string">        console.log(&quot;dex_size :&quot; + dex_size)</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        //frida写文件 把内存中的数据 写到本地</span></span><br><span class="line"><span class="string">        var timestamp = new Date().getTime();</span></span><br><span class="line"><span class="string">        var file = new File(&quot;/data/data/%s/&quot; + timestamp + &quot;.dex&quot;, &quot;wb&quot;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        //Memory.readByteArray(begin, length)</span></span><br><span class="line"><span class="string">        //把内存里的数据读出来，从begin开始读，取length长度</span></span><br><span class="line"><span class="string">        file.write(Memory.readByteArray(dex_begin_address, dex_size))</span></span><br><span class="line"><span class="string">        file.flush()</span></span><br><span class="line"><span class="string">        file.close()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        send(&quot;dex begin address:&quot;+parseInt(dex_begin_address,16))</span></span><br><span class="line"><span class="string">        send(&quot;dex file size:&quot;+dex_size)</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    onLeave: function (retval) &#123;</span></span><br><span class="line"><span class="string">        if (retval.toInt32() &gt; 0) &#123;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>%(package)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;dex 导出目录为: /data/data/%s&quot;</span>%(package))</span><br><span class="line">device = frida.get_usb_device()</span><br><span class="line">pid = device.spawn(package)</span><br><span class="line">session = device.attach(pid)</span><br><span class="line">script = session.create_script(src)</span><br><span class="line">script.on(<span class="string">&quot;message&quot;</span> , on_message)</span><br><span class="line">script.load()</span><br><span class="line">device.resume(pid)</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>
<p>把frida-server运行起来<br /><img  
                     lazyload
                     alt="image"
                     data-src="https://github.com/Zskkk/blog-images/raw/master/20201029/16.webp"
                     
                ><br><br /> <br><br />hook需要app运行，先把app打开，再运行脚本，<br><br /><img  
                     lazyload
                     alt="image"
                     data-src="https://github.com/Zskkk/blog-images/raw/master/20201029/17.webp"
                     
                ><br><br />我们去手机<code>/data/data/com.iCitySuzhou.suzhou001</code>目录下查看，会多了几个dex文件<br><br /><img  
                     lazyload
                     alt="image"
                     data-src="https://github.com/Zskkk/blog-images/raw/master/20201029/18.webp"
                     
                ><br><br />把这些dex文件拉到电脑用jadx打开看下，一个个查看后，找到了源dex<br><br /><img  
                     lazyload
                     alt="image"
                     data-src="https://github.com/Zskkk/blog-images/raw/master/20201029/19.webp"
                     
                ><br><br />到这里用frida脱壳也成功了。。。</p>
<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><p>壳的种类⾮常多，根据其种类不同，使⽤的技术也不同，这⾥稍微简单分个类：</p>
<ul>
<li>⼀代整体型壳：采⽤ Dex 整体加密，动态加载运⾏的机制；</li>
<li>⼆代函数抽取型壳：粒度更细，将⽅法单独抽取出来，加密保存，解密执⾏；</li>
<li>三代 VMP、Dex2C 壳：独⽴虚拟机解释执⾏、语义等价语法迁移，强度最⾼。</li>
</ul>
<p>先说最难的 Dex2C ⽬前是没有办法还原的，只能跟踪进⾏分析； VMP 虚拟机解释执⾏保护的是映射表，只要⼼思细、功夫深，是可以将映射表还原的；</p>
<p>⼆代壳函数抽取⽬前是可以从根本上进⾏还原的， dump 出所有的运⾏时的⽅法体，填充到 dump 下来的 dex 中去的，这也是fart的核⼼原理。</p>
<h3 id="frida-Dexdump"><a href="#frida-Dexdump" class="headerlink" title="frida-Dexdump"></a>frida-Dexdump</h3><p><a class="link"   target="_blank" rel="noopener" href="https://github.com/hluwa/FRIDA-DEXDump" >https://github.com/hluwa/FRIDA-DEXDump<i class="fas fa-external-link-alt"></i></a></p>
<p>利⽤ frida 的搜索内存，通过匹配 DEX ⽂件的特征，例如 DEX ⽂件的 文件头 中的 magic — dex.035 这个特征。 frida-Dexdump 便是这种脱壳⽅法的代表作。</p>
<ul>
<li>对于于完整的 dex，采⽤暴⼒搜索 dex035 即可找到。</li>
<li>⽽对于抹头的 dex，通过匹配⼀些特征来找到，然后⾃动修复⽂件头。</li>
</ul>
<p>抽取 -&gt; invoke -&gt; 还原 -&gt; 再抽取</p>

            </div>

            
                <div class="post-copyright-info">
                    <div class="article-copyright-info-container">
    <ul class="copyright-info-content">
        <li>
            <span class="type">本文标题</span>：<span class="content">App解固脱壳方式</span>
        </li>
        <li>
            <span class="type">本文作者</span>：<span class="content">zsk</span>
        </li>
        <li>
            <span class="type">创建时间</span>：<span class="content">2020-10-29 00:00:00</span>
        </li>
        <li class="post-link">
            <span class="type">本文链接</span>：<span class="content">2020-10-29/App解固脱壳方式.html</span>
        </li>
        <li>
            <span class="type">版权声明</span>：<span class="content">本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！</span>
        </li>
    </ul>
</div>

                </div>
            

            
                <ul class="post-tags-box">
                    
                        <li class="tag-item">
                            <a href="/tags/%E8%84%B1%E5%A3%B3/">#脱壳</a>&nbsp;
                        </li>
                    
                </ul>
            

            
                <div class="article-nav">
                    
                        <div class="article-prev">
                            <a class="prev"
                               rel="prev"
                               href="/2020-12-27/%E6%9F%90%E4%B8%9C%E5%AE%9E%E6%97%B6%E5%BC%B9%E5%B9%95%E6%8A%93%E5%8F%96.html"
                            >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                                <span class="title flex-center">
                                <span class="post-nav-title-item">某东实时弹幕抓取</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                            </a>
                        </div>
                    
                    
                </div>
            

            
                <div class="comment-container">
                    
<div class="comments-container">
    <div id="comments-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments"></i>&nbsp;评论
    </div>
    
        
            

    <div class="valine-container">
        <script  src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script >
          function loadValine() {
            new Valine({
              el: '#vcomments',
              appId: 'WxNQs5QEQtykF82Sb7nAjXRO-gzGzoHsz',
              appKey: '4rZ6NwH5zAu6VEspHwVrgqOq',
              meta: ['nick', 'mail', 'link'],
              avatar: 'wavatar',
              enableQQ: true,
              placeholder: '😜 尽情吐槽吧~',
              lang: 'zh-CN'.toLowerCase()
            });

            function getAuthor(language) {
              switch (language) {
                case 'en':
                  return 'Author';
                case 'zh-CN':
                  return '博主';
                default:
                  return 'Master';
              }
            }

            // Add "Author" identify
            const getValineDomTimer = setInterval(() => {
              const vcards = document.querySelectorAll('#vcomments .vcards .vcard');
              if (vcards.length > 0) {
                let author = 'zsk';

                if (author) {
                  for (let vcard of vcards) {
                    const vnick_dom = vcard.querySelector('.vhead .vnick');
                    const vnick = vnick_dom.innerHTML;
                    if (vnick === author) {
                      vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                    }
                  }
                }
                clearInterval(getValineDomTimer);
              } else {
                clearInterval(getValineDomTimer);
              }
            }, 2000);
          }

          if ('false' === 'true') {
            const loadValineTimeout = setTimeout(() => {
              loadValine();
              clearTimeout(loadValineTimeout);
            }, 1000);
          } else {
            window.addEventListener('DOMContentLoaded', loadValine);
          }
        </script>
    </div>



        
    
</div>

                </div>
            
        </div>

        
            <div class="toc-content-container">
                <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E5%B8%B8%E8%A7%81%E7%9A%84%E5%A3%B3"><span class="nav-number">1.</span> <span class="nav-text">一、常见的壳</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E5%8A%A0%E5%9B%BA%E5%8E%9F%E7%90%86"><span class="nav-number">2.</span> <span class="nav-text">二、加固原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E5%A6%82%E4%BD%95%E6%9F%A5%E7%9C%8B%E6%9C%89%E6%B2%A1%E6%9C%89%E5%A3%B3"><span class="nav-number">3.</span> <span class="nav-text">三、如何查看有没有壳</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81Hook%E6%8A%80%E6%9C%AF"><span class="nav-number">4.</span> <span class="nav-text">四、Hook技术</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E8%84%B1%E5%A3%B3%E5%B7%A5%E5%85%B7"><span class="nav-number">5.</span> <span class="nav-text">五、脱壳工具</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E5%BC%80%E5%A7%8B%E8%84%B1%E5%A3%B3%EF%BC%88%E7%94%A8FDex2%E8%84%B1%E5%A3%B3%EF%BC%89"><span class="nav-number">6.</span> <span class="nav-text">六、开始脱壳（用FDex2脱壳）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83%E3%80%81%E5%BC%80%E5%A7%8B%E8%84%B1%E5%A3%B3%EF%BC%88%E7%94%A8Frida%E8%84%B1%E5%A3%B3%EF%BC%89"><span class="nav-number">7.</span> <span class="nav-text">七、开始脱壳（用Frida脱壳）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Frida%E8%84%B1%E5%A3%B3"><span class="nav-number">7.1.</span> <span class="nav-text">Frida脱壳</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dex%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="nav-number">7.2.</span> <span class="nav-text">dex文件结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#header"><span class="nav-number">7.3.</span> <span class="nav-text">header</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A1%A5%E5%85%85"><span class="nav-number">8.</span> <span class="nav-text">补充</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#frida-Dexdump"><span class="nav-number">8.1.</span> <span class="nav-text">frida-Dexdump</span></a></li></ol></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                

            </div>

        </div>

        <div class="page-main-content-bottom">
            
<footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
                <span>2021</span> -
            
            2023
            
                &nbsp;<i class="fas fa-heart icon-animate"></i>
                &nbsp;<a href="/">zsk</a>
            
        </div>
        
            <script async 
                    src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                
                
                    总访问量&nbsp;<span id="busuanzi_value_site_pv"></span>
                
            </div>
        
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.5.2</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="tools-item flex-center go-to-comments">
                <i class="fas fa-comment"></i>
                <span class="post-comments-count"></span>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/dark-light-toggle.js"></script>




    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/code-block.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/lazyload.js"></script>


<div class="post-scripts">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/post-helper.js"></script>
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/libs/anime.min.js"></script>
        
        
            <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.5.2/source/js/toc.js"></script>
        
    
</div>



</body>
</html>
